<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self' https://cdn.jsdelivr.net; frame-src 'self' https://www.youtube.com https://www.youtube-nocookie.com;">
<title>ê²Œì‹œê¸€ ìƒì„¸ - ìƒŒëƒ </title>
<link rel="stylesheet" href="/assets/css/gnb.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="/assets/css/variables.css">
<link rel="stylesheet" href="/assets/css/base.css">
<link rel="stylesheet" href="/assets/css/layout.css">
<link rel="stylesheet" href="/assets/css/components.css">
<style>

/* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
.main-content {
  margin-left: 80px;
  flex: 1;
  padding: 2rem;
}

/* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
.back-button {
  margin-bottom: 1.5rem;
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 1rem;
  cursor: pointer;
  padding: 0.5rem 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: color 0.2s;
}

.back-button:hover {
  color: var(--text-dark);
}

/* ê²Œì‹œê¸€ ìƒì„¸ ì»¨í…Œì´ë„ˆ */
.detail-container {
  background-color: var(--bg-white);
  border-radius: 12px;
  padding: 2rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* ì¹´í…Œê³ ë¦¬ */
.post-category {
  display: inline-block;
  padding: 0.4rem 1rem;
  border-radius: 20px;
  background-color: var(--soft-pink);
  color: var(--primary-pink);
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 1rem;
}

/* ì œëª© */
.post-title {
  font-size: 2rem;
  font-weight: bold;
  color: var(--text-dark);
  margin-bottom: 1.5rem;
  line-height: 1.4;
}

/* ë©”íƒ€ ì •ë³´ (ì‘ì„±ì, ì‘ì„±ì¼, ì¡°íšŒìˆ˜) */
.post-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--border-gray);
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

.post-meta-left {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.post-meta-right {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-left: auto;
  position: relative;
}

.author-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.author-profile {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--profile-bg);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 1rem;
}

.author-name {
  font-size: 1rem;
  color: var(--text-dark);
  font-weight: 500;
}

.meta-divider {
  color: var(--border-light);
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.meta-item-icon {
  font-size: 1rem;
}

/* ë³¸ë¬¸ ë‚´ìš© */
.post-content {
  font-size: 1rem;
  line-height: 1.8;
  color: var(--text-dark);
  margin-bottom: 2rem;
  min-height: 200px;
}

.post-content img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 1rem 0;
}

.post-content iframe {
  max-width: 100%;
  border-radius: 8px;
  margin: 1rem 0;
}

/* íƒœê·¸ ì„¹ì…˜ */
.post-tags {
  padding-top: 1.5rem;
}

.tags-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 0.75rem;
  font-weight: 500;
}

.tag-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.tag-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  background-color: var(--bg-light);
  color: var(--text-dark);
  border-radius: 20px;
  font-size: 0.85rem;
}

/* ìˆ˜ì •/ì‚­ì œ ë©”ë‰´ ë²„íŠ¼ */
.post-menu-btn {
  background: none;
  border: none;
  padding: 0.5rem;
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 1.25rem;
  transition: color 0.2s;
  position: relative;
}

.post-menu-btn:hover {
  color: var(--text-dark);
}

/* ìˆ˜ì •/ì‚­ì œ ëª¨ë‹¬ */
.post-menu-modal {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 0.5rem;
  background: white;
  border: 1px solid var(--border-gray);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  min-width: 120px;
  overflow: hidden;
}

.post-menu-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  width: 100%;
  padding: 0.75rem 1rem;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  transition: background-color 0.2s;
  color: var(--text-dark);
  font-size: 0.95rem;
}

.post-menu-item:hover {
  background-color: var(--soft-gray);
}

.post-menu-item i {
  font-size: 1rem;
  width: 16px;
}

.post-menu-item-danger {
  color: var(--error);
}

.post-menu-item-danger:hover {
  background-color: var(--error-bg);
}

/* ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ êµ¬ë¶„ì„  */
.post-comments-divider {
  height: 1px;
  background-color: var(--soft-pink-light);
  margin: 3rem 0 -0.5rem 0;
}

/* ëŒ“ê¸€ í—¤ë” ë˜í¼ */
.comments-header-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
}

/* ì¶”ì²œ ë° ë¶ë§ˆí¬ ë²„íŠ¼ (ì¸ë¼ì¸, ì•„ì´ì½˜ë§Œ) */
.post-actions-inline {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.action-icon-btn {
  background: none;
  border: none;
  padding: 0.5rem;
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 1.25rem;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  position: relative;
}

.action-icon-btn:hover {
  color: var(--text-dark);
  transform: scale(1.1);
}

.action-icon-btn i {
  font-size: 1.25rem;
}

.action-count {
  font-weight: 500;
  font-size: 0.85rem;
  margin-left: 0.25rem;
}

/* ì¶”ì²œ ë²„íŠ¼ */
.like-btn.active {
  color: var(--gold);
}

.like-btn.active i {
  color: var(--gold);
}

.like-btn.active .action-count {
  color: var(--gold);
}

/* ë¶ë§ˆí¬ ë²„íŠ¼ */
.bookmark-btn.active {
  color: var(--primary-pink);
}

.bookmark-btn.active i {
  color: var(--primary-pink);
}

/* ì´ë¯¸ì§€ ì„¹ì…˜ (ë ˆì‹œí”¼ìš©) */
.post-image-section {
  margin-bottom: 2rem;
  text-align: center;
}

.post-image {
  max-width: 100%;
  max-height: 500px;
  border-radius: 12px;
  object-fit: contain;
}

/* ë¡œë”© ë° ì—ëŸ¬ */
.loading {
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary);
}

.error {
  text-align: center;
  padding: 3rem;
  color: var(--error);
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .main-content {
    margin-left: 0;
    padding: 1rem;
    padding-bottom: calc(1rem + 70px); /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ë†’ì´ë§Œí¼ ì¶”ê°€ */
  }

  .detail-container {
    padding: 1.5rem;
  }

  .post-title {
    font-size: 1.5rem;
  }

  .post-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .post-meta-right {
    align-self: flex-end;
    margin-left: 0;
  }

  .meta-divider {
    display: none;
  }
}

@media (max-width: 480px) {
  .post-title {
    font-size: 1.25rem;
  }

  .author-profile {
    width: 32px;
    height: 32px;
    font-size: 0.85rem;
  }
}

/* ëŒ“ê¸€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
.comments-section {
  padding: 2rem 0 0 0;
}

.comments-header {
  font-size: 1.25rem;
  font-weight: bold;
  color: var(--text-dark);
}

.comments-count {
  color: var(--primary-pink);
  margin-left: 0.5rem;
}

/* ëŒ“ê¸€ í˜ì´ì§€ë„¤ì´ì…˜ */
.comments-pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  margin: 2rem 0;
  padding: 1rem 0;
}

.pagination-btn {
  background: none;
  border: 1px solid var(--border-light);
  border-radius: 6px;
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pagination-btn:hover:not(:disabled) {
  background-color: var(--soft-gray);
  border-color: var(--primary-pink);
  color: var(--primary-pink);
}

.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination-info {
  font-size: 0.95rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* ëŒ“ê¸€ ì‘ì„± í¼ */
.comment-form {
  margin-top: 2rem;
  padding: 1.5rem;
  background-color: var(--soft-gray);
  border-radius: 8px;
  border-top: 1px solid var(--border-gray);
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.comment-form-header {
  font-size: 1rem;
  font-weight: 500;
  color: var(--text-dark);
  margin-bottom: 1rem;
}

.comment-input-group {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.comment-author-input {
  padding: 0.75rem;
  border: 1px solid var(--border-light);
  border-radius: 6px;
  font-size: 0.95rem;
  outline: none;
  transition: border-color 0.2s;
}

.comment-author-input:focus {
  border-color: var(--primary-pink);
}

.comment-textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border-light);
  border-radius: 6px;
  font-size: 0.95rem;
  outline: none;
  resize: vertical;
  min-height: 100px;
  font-family: inherit;
  transition: border-color 0.2s;
  box-sizing: border-box;
}

.comment-textarea:focus {
  border-color: var(--primary-pink);
}

.comment-form-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0.5rem;
}

.comment-char-count {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.comment-submit-btn {
  padding: 0.6rem 1.5rem;
  background-color: var(--primary-pink);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.comment-submit-btn:hover {
  background-color: var(--primary-pink-hover);
}

.comment-submit-btn:disabled {
  background-color: var(--border-light);
  cursor: not-allowed;
}

/* ëŒ“ê¸€ ëª©ë¡ */
.comments-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.comment-item {
  padding: 1.25rem;
  background-color: var(--soft-gray);
  border-radius: 8px;
  transition: background-color 0.2s;
}

.comment-item:hover {
  background-color: var(--border-color);
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
}

.comment-author-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.comment-author-profile {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background-color: var(--profile-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 0.9rem;
  flex-shrink: 0;
}

.comment-author-details {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.comment-author-name {
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--text-dark);
}

.comment-meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.comment-index {
  color: var(--primary-pink);
  font-weight: 500;
}

.comment-actions {
  display: flex;
  gap: 0.5rem;
}

.comment-action-btn {
  padding: 0.4rem 0.8rem;
  background: none;
  border: 1px solid var(--border-light);
  border-radius: 4px;
  font-size: 0.85rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.comment-action-btn:hover {
  border-color: var(--primary-pink);
  color: var(--primary-pink);
}

.comment-action-btn.delete {
  border-color: var(--error);
  color: var(--error);
}

.comment-action-btn.delete:hover {
  background-color: var(--error);
  color: white;
}

.comment-content {
  font-size: 0.95rem;
  line-height: 1.6;
  color: var(--text-dark);
  white-space: pre-wrap;
  word-break: break-word;
}

.comment-edit-form {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-top: 0.75rem;
}

.comment-edit-textarea {
  padding: 0.75rem;
  border: 1px solid var(--primary-pink);
  border-radius: 6px;
  font-size: 0.95rem;
  outline: none;
  resize: vertical;
  min-height: 80px;
  font-family: inherit;
}

.comment-edit-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
}

.comment-save-btn,
.comment-cancel-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
}

.comment-save-btn {
  background-color: var(--primary-pink);
  color: white;
}

.comment-save-btn:hover {
  background-color: var(--primary-pink-hover);
}

.comment-cancel-btn {
  background-color: var(--border-gray);
  color: var(--text-dark);
}

.comment-cancel-btn:hover {
  background-color: var(--border-light);
}

.no-comments {
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary);
  font-size: 0.95rem;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .comments-section {
    padding: 1.5rem;
  }

  .comment-form {
    padding: 1rem;
  }

  .comment-item {
    padding: 1rem;
  }

  .comment-header {
    flex-direction: column;
    gap: 0.75rem;
  }

  .comment-actions {
    align-self: flex-start;
  }
}
</style>
</head>
<body>
<div class="main-container">
  <!-- GNB (Global Navigation Bar) -->
  <div id="gnb-root"></div>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <main class="main-content">
    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <button class="back-button" id="backToListBtn">
      <span>â†</span>
      <span>ëª©ë¡ìœ¼ë¡œ</span>
    </button>

    <!-- ê²Œì‹œê¸€ ìƒì„¸ ì»¨í…Œì´ë„ˆ -->
    <div class="detail-container" id="detailContainer">
      <div class="loading" id="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <div class="error" id="error" style="display: none;"></div>
      
      <!-- ê²Œì‹œê¸€ ë‚´ìš© (ë™ì ìœ¼ë¡œ ìƒì„±) -->
      <div id="postContent" style="display: none;">
        <div class="post-category" id="postCategory"></div>
        <div class="post-image-section" id="postImageSection" style="display: none;">
          <img class="post-image" id="postImage" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€">
        </div>
        <h1 class="post-title" id="postTitle"></h1>
        <div class="post-meta">
          <div class="post-meta-left">
            <div class="author-info">
              <div class="author-profile" id="authorProfile"></div>
              <span class="author-name" id="authorName"></span>
            </div>
            <span class="meta-divider">|</span>
            <div class="meta-item">
              <span id="postDate"></span>
            </div>
            <span class="meta-divider">|</span>
            <div class="meta-item">
              <span class="meta-item-icon">ğŸ‘</span>
              <span id="postViews"></span>
            </div>
          </div>
          <!-- ìˆ˜ì •/ì‚­ì œ ë©”ë‰´ ë²„íŠ¼ -->
          <div class="post-meta-right">
            <button class="post-menu-btn" id="postMenuBtn" title="ë”ë³´ê¸°">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <!-- ìˆ˜ì •/ì‚­ì œ ëª¨ë‹¬ -->
            <div class="post-menu-modal" id="postMenuModal" style="display: none;">
              <button class="post-menu-item" id="editPostBtn">
                <i class="bi bi-pencil"></i>
                <span>ìˆ˜ì •</span>
              </button>
              <button class="post-menu-item post-menu-item-danger" id="deletePostBtn">
                <i class="bi bi-trash"></i>
                <span>ì‚­ì œ</span>
              </button>
            </div>
          </div>
        </div>
        <div class="post-content" id="postContentBody"></div>
        <div class="post-tags" id="postTagsSection" style="display: none;">
          <div class="tag-list" id="tagList"></div>
        </div>
      </div>
      
      <!-- ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ êµ¬ë¶„ì„  -->
      <div class="post-comments-divider"></div>
  
      <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
      <div class="comments-section" id="commentsSection" style="display: none;">
        <div class="comments-header-wrapper">
          <div class="comments-header">
            ëŒ“ê¸€<span class="comments-count" id="commentsCount">(0)</span>
          </div>
          <!-- ì¶”ì²œ ë° ë¶ë§ˆí¬ ë²„íŠ¼ (ì•„ì´ì½˜ë§Œ) -->
          <div class="post-actions-inline">
            <button class="action-icon-btn like-btn" id="likeBtn" title="ì¶”ì²œ">
              <i class="bi bi-star"></i>
              <span class="action-count" id="likeCount">0</span>
            </button>
            <button class="action-icon-btn bookmark-btn" id="bookmarkBtn" title="ë¶ë§ˆí¬">
              <i class="bi bi-bookmark"></i>
            </button>
          </div>
        </div>

        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        <div class="comments-list" id="commentsList">
          <div class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>
        </div>
        
        <!-- ëŒ“ê¸€ í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="comments-pagination" id="commentsPagination" style="display: none;">
          <button class="pagination-btn" id="prevPageBtn" disabled>
            <i class="bi bi-chevron-left"></i>
          </button>
          <span class="pagination-info" id="paginationInfo">1 / 1</span>
          <button class="pagination-btn" id="nextPageBtn" disabled>
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>

        <!-- ëŒ“ê¸€ ì‘ì„± í¼ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ) -->
        <div class="comment-form" id="commentForm" style="display: none;">
          <textarea 
            class="comment-textarea" 
            id="commentTextarea" 
            placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 1000ì)" 
            maxlength="1000"
          ></textarea>
          <div class="comment-form-footer">
            <span class="comment-char-count">
              <span id="commentCharCount">0</span> / 1000
            </span>
            <button class="comment-submit-btn" id="commentSubmitBtn">ëŒ“ê¸€ ì‘ì„±</button>
          </div>
        </div>

        <!-- ë¡œê·¸ì¸ ì•ˆë‚´ (ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì) -->
        <div class="comment-login-notice" id="commentLoginNotice" style="display: none;">
          <div style="text-align: center; padding: 2rem; background-color: var(--soft-gray); border-radius: 8px;">
            <p style="margin-bottom: 1rem; color: var(--text-secondary);">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <button 
              class="btn btn-primary" 
              onclick="window.location.href='/login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search)"
              style="padding: 0.6rem 1.5rem;"
            >
              ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div id="site-footer" class="mt-5"></div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="/assets/js/gnb.js"></script>
<script>
// URL íŒŒë¼ë¯¸í„°ì—ì„œ type(MENU_ID)ê³¼ id ê°€ì ¸ì˜¤ê¸°
const urlParams = new URLSearchParams(window.location.search);
const postType = urlParams.get('type'); // '1' (ë ˆì‹œí”¼) or '2' (ì •ë³´ ê³µìœ ) - MENU_TBì˜ MENU_ID
const postId = urlParams.get('id');

// ê²Œì‹œê¸€ ì •ë³´ ì €ì¥ (ëª©ë¡ìœ¼ë¡œ ì´ë™ ì‹œ ì‚¬ìš©)
let currentPostData = {
  boardId: postType, // MENU_ID
  categoryId: null, // ì¹´í…Œê³ ë¦¬ëŠ” ê²Œì‹œê¸€ ë¡œë“œ í›„ ì„¤ì •
  createdAt: null // í˜ì´ì§€ ê³„ì‚°ìš©
};

// DOM ìš”ì†Œ
const loading = document.getElementById('loading');
const error = document.getElementById('error');
const postContent = document.getElementById('postContent');
const detailContainer = document.getElementById('detailContainer');

// ê²Œì‹œê¸€ ë¡œë“œ
async function loadPost() {
  if (!postType || !postId) {
    showError('ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.');
    return;
  }

  try {
    // MENU_ID 1 = ë ˆì‹œí”¼ ê²Œì‹œíŒ, MENU_ID 2 = ì •ë³´ ê³µìœ  ê²Œì‹œíŒ
    const apiUrl = postType === '1' 
      ? `/api/recipes/${postId}`
      : `/api/tips/${postId}`;
    
    const response = await fetch(apiUrl);
    const result = await response.json();

    if (!result.success) {
      showError(result.message || 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const data = result.data;
    console.log('ê²Œì‹œê¸€ ë°ì´í„° ì „ì²´:', data); // ë””ë²„ê¹…ìš©
    console.log('ê²Œì‹œê¸€ ë°ì´í„° í‚¤ ëª©ë¡:', Object.keys(data)); // ë””ë²„ê¹…ìš©
    console.log('CONTENT ê°’:', data.CONTENT); // ë””ë²„ê¹…ìš©
    console.log('CONTENT íƒ€ì…:', typeof data.CONTENT); // ë””ë²„ê¹…ìš©
    console.log('CONTENT ì¡´ì¬ ì—¬ë¶€:', data.CONTENT !== null && data.CONTENT !== undefined); // ë””ë²„ê¹…ìš©
    
    // ëª¨ë“  í‚¤ë¥¼ í™•ì¸í•˜ì—¬ CONTENTì™€ ìœ ì‚¬í•œ í‚¤ ì°¾ê¸°
    const contentKeys = Object.keys(data).filter(key => key.toLowerCase().includes('content'));
    console.log('CONTENT ê´€ë ¨ í‚¤ë“¤:', contentKeys); // ë””ë²„ê¹…ìš©
    
    displayPost(data);
  } catch (err) {
    console.error('ê²Œì‹œê¸€ ë¡œë“œ ì˜¤ë¥˜:', err);
    showError('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ë‚ ì§œ í¬ë§·: yyyy.mm.dd hh:mm
function formatDateTime(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return '-';
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const mm = String(d.getMinutes()).padStart(2, '0');
  return `${y}.${m}.${day} ${hh}:${mm}`;
}

// ê²Œì‹œê¸€ í‘œì‹œ
function displayPost(data) {
  // ê²Œì‹œê¸€ ì •ë³´ ì €ì¥ (ëª©ë¡ìœ¼ë¡œ ì´ë™ ì‹œ ì‚¬ìš©)
  currentPostData.categoryId = data.CATEGORY || null;
  currentPostData.createdAt = data.CREATED_AT || null;
  
  // ì¹´í…Œê³ ë¦¬
  const categoryEl = document.getElementById('postCategory');
  if (data.CATEGORY_NAME) {
    categoryEl.textContent = data.CATEGORY_NAME;
    categoryEl.style.display = 'inline-block';
  } else {
    categoryEl.style.display = 'none';
  }

  // ì´ë¯¸ì§€ ì„¹ì…˜ ìˆ¨ê¹€ (ì¸ë„¤ì¼ì€ ê²Œì‹œíŒ ëª©ë¡ì—ì„œë§Œ ì‚¬ìš©, ìƒì„¸ë³´ê¸°ì—ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
  document.getElementById('postImageSection').style.display = 'none';

  // ì œëª©
  document.getElementById('postTitle').textContent = data.TITLE || 'ì œëª© ì—†ìŒ';

  // ì‘ì„±ì í”„ë¡œí•„ ì•„ì´ì½˜ (ì´ë¦„ì˜ ì²« ê¸€ì)
  const authorName = data.AUTHOR_NAME || 'ìµëª…';
  const authorProfile = document.getElementById('authorProfile');
  authorProfile.textContent = authorName.charAt(0).toUpperCase();
  document.getElementById('authorName').textContent = authorName;

  // ì‘ì„±ì¼ (yyyy.mm.dd hh:mm) - ì„œë²„ í¬ë§· ëŒ€ì‹  ì§ì ‘ í¬ë§·
  const createdAt = formatDateTime(data.CREATED_AT || data.CREATED_AT_FORMATTED);
  document.getElementById('postDate').textContent = createdAt;

  // ì¡°íšŒìˆ˜
  const views = data.VIEWS ? data.VIEWS.toLocaleString() : '0';
  document.getElementById('postViews').textContent = views;

  // ë³¸ë¬¸ ë‚´ìš©
  const contentBody = document.getElementById('postContentBody');
  
  // CONTENT ì»¬ëŸ¼ ì°¾ê¸° (ëª¨ë“  ê°€ëŠ¥í•œ í‚¤ ì‹œë„)
  let content = null;
  if (data.CONTENT !== null && data.CONTENT !== undefined) {
    content = data.CONTENT;
  } else if (data.content !== null && data.content !== undefined) {
    content = data.content;
  } else if (data.Content !== null && data.Content !== undefined) {
    content = data.Content;
  } else {
    // ëª¨ë“  í‚¤ë¥¼ í™•ì¸í•˜ì—¬ CONTENTì™€ ìœ ì‚¬í•œ í‚¤ ì°¾ê¸°
    const contentKey = Object.keys(data).find(key => 
      key.toLowerCase() === 'content' || 
      key.toLowerCase().includes('content')
    );
    if (contentKey) {
      content = data[contentKey];
      console.log('CONTENTë¥¼ ë‹¤ë¥¸ í‚¤ì—ì„œ ì°¾ìŒ:', contentKey, content);
    }
  }
  
  // CONTENTê°€ null, undefined, ë¹ˆ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í‘œì‹œ
  if (content !== null && content !== undefined && String(content).trim() !== '') {
    console.log('CONTENT í‘œì‹œ:', content.substring(0, 100) + '...');
    contentBody.innerHTML = content;
  } else {
    console.error('âš ï¸ CONTENTë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë°ì´í„° í‚¤:', Object.keys(data));
    console.error('âš ï¸ ì „ì²´ ë°ì´í„°:', data);
    contentBody.innerHTML = '<p style="color: var(--text-secondary);">ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
  }

  // íƒœê·¸
  const tagsSection = document.getElementById('postTagsSection');
  const tagList = document.getElementById('tagList');
  if (data.TAGS && data.TAGS.trim()) {
    const tags = data.TAGS.split(',').map(tag => tag.trim()).filter(tag => tag);
    if (tags.length > 0) {
      tagList.innerHTML = '';
      tags.forEach(tag => {
        const tagBadge = document.createElement('span');
        tagBadge.className = 'tag-badge';
        tagBadge.textContent = `#${tag}`;
        tagList.appendChild(tagBadge);
      });
      tagsSection.style.display = 'block';
    } else {
      tagsSection.style.display = 'none';
    }
  } else {
    tagsSection.style.display = 'none';
  }

  // ë¡œë”© ìˆ¨ê¸°ê³  ë‚´ìš© í‘œì‹œ
  loading.style.display = 'none';
  postContent.style.display = 'block';
  
  // ì¶”ì²œ ë° ë¶ë§ˆí¬ ìƒíƒœ ë¡œë“œ
  loadLikeAndBookmarkStatus();
}

// ì—ëŸ¬ í‘œì‹œ
function showError(message) {
  loading.style.display = 'none';
  error.style.display = 'block';
  error.textContent = message;
}

// ============================================================
// ì¶”ì²œ ë° ë¶ë§ˆí¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
// ============================================================

// ì¶”ì²œ ë° ë¶ë§ˆí¬ ìƒíƒœ ë¡œë“œ
async function loadLikeAndBookmarkStatus() {
  if (!postType || !postId) return;
  
  try {
    const user = getStoredUser();
    if (!user || !user.userId) {
      // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ì¶”ì²œ ìˆ˜ë§Œ í‘œì‹œ
      await loadLikeCount();
      return;
    }
    
    // ë¡œê·¸ì¸í•œ ê²½ìš° ìƒíƒœì™€ ìˆ˜ í•¨ê»˜ ë¡œë“œ
    const [likeStatus, bookmarkStatus, likeCount] = await Promise.all([
      checkLikeStatus(user.userId),
      checkBookmarkStatus(user.userId),
      loadLikeCount()
    ]);
    
    updateLikeButton(likeStatus, likeCount);
    updateBookmarkButton(bookmarkStatus);
  } catch (error) {
    console.error('ì¶”ì²œ/ë¶ë§ˆí¬ ìƒíƒœ ë¡œë“œ ì˜¤ë¥˜:', error);
    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¶”ì²œ ìˆ˜ë§Œ ë¡œë“œ
    await loadLikeCount();
  }
}

// ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getStoredUser() {
  try {
    const raw = localStorage.getItem('sandwichUser');
    return raw ? JSON.parse(raw) : null;
  } catch (error) {
    console.warn('ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error);
    return null;
  }
}

// ì¶”ì²œ ìˆ˜ ë¡œë“œ
async function loadLikeCount() {
  try {
    const response = await fetch(`/api/likes/count?postType=${postType}&postId=${postId}`);
    const result = await response.json();
    
    if (result.success) {
      document.getElementById('likeCount').textContent = result.count || 0;
    }
  } catch (error) {
    console.error('ì¶”ì²œ ìˆ˜ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// ì¶”ì²œ ìƒíƒœ í™•ì¸
async function checkLikeStatus(userId) {
  try {
    const response = await fetch(`/api/likes/status?postType=${postType}&postId=${postId}&userId=${userId}`);
    const result = await response.json();
    return result.success && result.liked;
  } catch (error) {
    console.error('ì¶”ì²œ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
    return false;
  }
}

// ë¶ë§ˆí¬ ìƒíƒœ í™•ì¸
async function checkBookmarkStatus(userId) {
  try {
    const response = await fetch(`/api/bookmarks/status?postType=${postType}&postId=${postId}&userId=${userId}`);
    const result = await response.json();
    return result.success && result.bookmarked;
  } catch (error) {
    console.error('ë¶ë§ˆí¬ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
    return false;
  }
}

// ì¶”ì²œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
function updateLikeButton(isLiked, count) {
  const likeBtn = document.getElementById('likeBtn');
  const likeIcon = likeBtn.querySelector('i');
  const likeCount = document.getElementById('likeCount');
  
  if (isLiked) {
    likeBtn.classList.add('active');
    likeIcon.className = 'bi bi-star-fill';
  } else {
    likeBtn.classList.remove('active');
    likeIcon.className = 'bi bi-star';
  }
  
  if (count !== undefined) {
    likeCount.textContent = count || 0;
  }
}

// ë¶ë§ˆí¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
function updateBookmarkButton(isBookmarked) {
  const bookmarkBtn = document.getElementById('bookmarkBtn');
  const bookmarkIcon = bookmarkBtn.querySelector('i');
  
  if (isBookmarked) {
    bookmarkBtn.classList.add('active');
    bookmarkIcon.className = 'bi bi-bookmark-check-fill';
  } else {
    bookmarkBtn.classList.remove('active');
    bookmarkIcon.className = 'bi bi-bookmark';
  }
}

// ì¶”ì²œ í† ê¸€
async function toggleLike() {
  const user = getStoredUser();
  if (!user || !user.userId) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
    return;
  }
  
  const likeBtn = document.getElementById('likeBtn');
  const isCurrentlyLiked = likeBtn.classList.contains('active');
  
  try {
    const response = await fetch('/api/likes/toggle', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        userId: user.userId,
        postType: parseInt(postType),
        postId: parseInt(postId)
      })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      alert(result.message || 'ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateLikeButton(result.liked, result.count);
  } catch (error) {
    console.error('ì¶”ì²œ í† ê¸€ ì˜¤ë¥˜:', error);
    alert('ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ë¶ë§ˆí¬ í† ê¸€
async function toggleBookmark() {
  const user = getStoredUser();
  if (!user || !user.userId) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
    return;
  }
  
  try {
    const response = await fetch('/api/bookmarks/toggle', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        userId: user.userId,
        postType: parseInt(postType),
        postId: parseInt(postId)
      })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      alert(result.message || 'ë¶ë§ˆí¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateBookmarkButton(result.bookmarked);
    
    if (result.bookmarked) {
      // ë¶ë§ˆí¬ ì¶”ê°€ ì„±ê³µ ì‹œ ê°„ë‹¨í•œ í”¼ë“œë°± (ì„ íƒì‚¬í•­)
      // alert('ë¶ë§ˆí¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('ë¶ë§ˆí¬ í† ê¸€ ì˜¤ë¥˜:', error);
    alert('ë¶ë§ˆí¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ============================================================
// ëŒ“ê¸€ ê´€ë ¨ í•¨ìˆ˜ë“¤
// ============================================================
let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´
let currentCommentPage = 1;
const COMMENTS_PER_PAGE = 15;
let allComments = []; // ëª¨ë“  ëŒ“ê¸€ ì €ì¥

// ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function checkLoginStatus() {
  try {
    const userDataStr = localStorage.getItem('sandwichUser');
    if (userDataStr) {
      currentUser = JSON.parse(userDataStr);
      return true;
    }
  } catch (error) {
    console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
  currentUser = null;
  return false;
}

// ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
async function loadComments(page = 1) {
  if (!postType || !postId) return;
  
  try {
    const response = await fetch(`/api/comments?postType=${postType}&postId=${postId}`);
    const result = await response.json();
    
    if (!result.success) {
      console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', result.message);
      return;
    }
    
    allComments = result.data || [];
    currentCommentPage = page;
    
    displayComments(allComments, page);
    updateCommentPagination(allComments.length);
    document.getElementById('commentsCount').textContent = `(${allComments.length})`;
  } catch (error) {
    console.error('ëŒ“ê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

// ëŒ“ê¸€ ëª©ë¡ í‘œì‹œ (í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©)
function displayComments(comments, page = 1) {
  const commentsList = document.getElementById('commentsList');
  
  if (comments.length === 0) {
    commentsList.innerHTML = '<div class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
    return;
  }
  
  // í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©
  const startIndex = (page - 1) * COMMENTS_PER_PAGE;
  const endIndex = startIndex + COMMENTS_PER_PAGE;
  const pageComments = comments.slice(startIndex, endIndex);
  
  if (pageComments.length === 0 && page > 1) {
    // ë¹ˆ í˜ì´ì§€ì¸ ê²½ìš° ì²« í˜ì´ì§€ë¡œ ì´ë™
    loadComments(1);
    return;
  }
  
  commentsList.innerHTML = '';
  
  pageComments.forEach(comment => {
    const commentItem = createCommentElement(comment);
    commentsList.appendChild(commentItem);
  });
}

// ëŒ“ê¸€ í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
function updateCommentPagination(totalComments) {
  const pagination = document.getElementById('commentsPagination');
  const prevBtn = document.getElementById('prevPageBtn');
  const nextBtn = document.getElementById('nextPageBtn');
  const paginationInfo = document.getElementById('paginationInfo');
  
  const totalPages = Math.ceil(totalComments / COMMENTS_PER_PAGE);
  
  if (totalPages <= 1) {
    pagination.style.display = 'none';
    return;
  }
  
  pagination.style.display = 'flex';
  paginationInfo.textContent = `${currentCommentPage} / ${totalPages}`;
  
  prevBtn.disabled = currentCommentPage === 1;
  nextBtn.disabled = currentCommentPage === totalPages;
}

// ëŒ“ê¸€ ìš”ì†Œ ìƒì„±
function createCommentElement(comment) {
  const div = document.createElement('div');
  div.className = 'comment-item';
  div.dataset.commentId = comment.COMMENT_ID;
  
  const isDeleted = comment.DELETED_YN === 'Y';
  const authorInitial = comment.AUTHOR_NAME.charAt(0).toUpperCase();
  const isEdited = new Date(comment.CREATED_AT).getTime() !== new Date(comment.UPDATED_AT).getTime();
  
  // XSS ë°©ì§€ë¥¼ ìœ„í•´ HTML ì´ìŠ¤ì¼€ì´í”„
  const escapeHtml = (text) => {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  };
  
  const escapedContent = escapeHtml(comment.CONTENT);
  const escapedAuthorName = escapeHtml(comment.AUTHOR_NAME);
  
  // ì‚­ì œëœ ëŒ“ê¸€ì¸ ê²½ìš°
  if (isDeleted) {
    div.innerHTML = `
      <div class="comment-header">
        <div class="comment-author-info">
          <div class="comment-author-profile" style="background-color: var(--border-light);">?</div>
          <div class="comment-author-details">
            <div class="comment-author-name" style="color: var(--text-placeholder);">ì‚­ì œëœ ì‚¬ìš©ì</div>
            <div class="comment-meta">
              <span class="comment-index">#${comment.COMMENT_INDEX}</span>
              <span>â€¢</span>
              <span>${formatDateTime(comment.CREATED_AT || comment.CREATED_AT_FORMATTED)}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="comment-content" style="color: var(--text-placeholder); font-style: italic;">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</div>
    `;
  } else {
    // ì •ìƒ ëŒ“ê¸€
    div.innerHTML = `
      <div class="comment-header">
        <div class="comment-author-info">
          <div class="comment-author-profile">${authorInitial}</div>
          <div class="comment-author-details">
            <div class="comment-author-name">${escapedAuthorName}</div>
            <div class="comment-meta">
              <span class="comment-index">#${comment.COMMENT_INDEX}</span>
              <span>â€¢</span>
              <span>${formatDateTime(comment.CREATED_AT || comment.CREATED_AT_FORMATTED)}</span>
              ${isEdited ? '<span>â€¢ (ìˆ˜ì •ë¨)</span>' : ''}
            </div>
          </div>
        </div>
        <div class="comment-actions">
          <button class="comment-action-btn edit-btn" data-comment-id="${comment.COMMENT_ID}" data-author-name="${escapedAuthorName}">ìˆ˜ì •</button>
          <button class="comment-action-btn delete delete-btn" data-comment-id="${comment.COMMENT_ID}" data-author-name="${escapedAuthorName}">ì‚­ì œ</button>
        </div>
      </div>
      <div class="comment-content" data-original-content="${escapedContent.replace(/"/g, '&quot;')}">${escapedContent}</div>
    `;
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì •ìƒ ëŒ“ê¸€ì—ë§Œ)
    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
    if (checkLoginStatus() && currentUser && currentUser.userId === comment.AUTHOR_ID) {
      div.querySelector('.edit-btn').addEventListener('click', function() {
        editComment(comment.COMMENT_ID, comment.AUTHOR_ID);
      });
      
      div.querySelector('.delete-btn').addEventListener('click', function() {
        deleteComment(comment.COMMENT_ID, comment.AUTHOR_ID);
      });
    } else {
      // ë³¸ì¸ ëŒ“ê¸€ì´ ì•„ë‹ˆë©´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      const actionsElement = div.querySelector('.comment-actions');
      if (actionsElement) {
        actionsElement.style.display = 'none';
      }
    }
  }
  
  return div;
}

// ëŒ“ê¸€ ì‘ì„±
async function submitComment() {
  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  if (!checkLoginStatus()) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
    return;
  }
  
  const contentTextarea = document.getElementById('commentTextarea');
  const content = contentTextarea.value.trim();
  
  if (!content) {
    alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    contentTextarea.focus();
    return;
  }
  
  if (content.length > 1000) {
    alert('ëŒ“ê¸€ì€ ìµœëŒ€ 1000ìê¹Œì§€ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ì°¨ë‹¨ëœ ì‚¬ìš©ì í™•ì¸
  if (currentUser.blocked === true) {
    alert('ì°¨ë‹¨ëœ ì‚¬ìš©ìëŠ” ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  try {
    const response = await fetch('/api/comments', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        postType,
        postId,
        content,
        userId: currentUser.userId,
        authorName: currentUser.nickname
      })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      alert(result.message || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    contentTextarea.value = '';
    document.getElementById('commentCharCount').textContent = '0';
    
    // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì²« í˜ì´ì§€ë¡œ ì´ë™)
    await loadComments(1);
    
    alert('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (error) {
    console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
    alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ëŒ“ê¸€ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
function editComment(commentId, authorId) {
  // ë¡œê·¸ì¸ í™•ì¸
  if (!checkLoginStatus()) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  // ì‘ì„±ì í™•ì¸
  if (currentUser.userId !== authorId) {
    alert('ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
  const contentElement = commentItem.querySelector('.comment-content');
  const originalContent = contentElement.dataset.originalContent;
  const actionsElement = commentItem.querySelector('.comment-actions');
  
  // HTML ì´ìŠ¤ì¼€ì´í”„ í•´ì œ
  const unescapeHtml = (text) => {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
  };
  
  const decodedContent = unescapeHtml(originalContent);
  
  // ìˆ˜ì • í¼ ìƒì„±
  const editForm = document.createElement('div');
  editForm.className = 'comment-edit-form';
  
  const textarea = document.createElement('textarea');
  textarea.className = 'comment-edit-textarea';
  textarea.maxLength = 1000;
  textarea.value = decodedContent;
  
  const editActions = document.createElement('div');
  editActions.className = 'comment-edit-actions';
  
  const saveBtn = document.createElement('button');
  saveBtn.className = 'comment-save-btn';
  saveBtn.textContent = 'ì €ì¥';
  saveBtn.onclick = () => saveComment(commentId);
  
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'comment-cancel-btn';
  cancelBtn.textContent = 'ì·¨ì†Œ';
  cancelBtn.onclick = () => cancelEdit(commentId);
  
  editActions.appendChild(saveBtn);
  editActions.appendChild(cancelBtn);
  editForm.appendChild(textarea);
  editForm.appendChild(editActions);
  
  // ê¸°ì¡´ ë‚´ìš© ìˆ¨ê¸°ê³  ìˆ˜ì • í¼ í‘œì‹œ
  contentElement.style.display = 'none';
  actionsElement.style.display = 'none';
  contentElement.parentNode.appendChild(editForm);
  
  // í…ìŠ¤íŠ¸ ì˜ì—­ í¬ì»¤ìŠ¤
  textarea.focus();
}

// ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ
function cancelEdit(commentId) {
  const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
  const contentElement = commentItem.querySelector('.comment-content');
  const actionsElement = commentItem.querySelector('.comment-actions');
  const editForm = commentItem.querySelector('.comment-edit-form');
  
  contentElement.style.display = 'block';
  actionsElement.style.display = 'flex';
  editForm.remove();
}

// ëŒ“ê¸€ ì €ì¥
async function saveComment(commentId) {
  const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
  const editForm = commentItem.querySelector('.comment-edit-form');
  const textarea = editForm.querySelector('textarea');
  const newContent = textarea.value.trim();
  
  if (!newContent) {
    alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    textarea.focus();
    return;
  }
  
  if (newContent.length > 1000) {
    alert('ëŒ“ê¸€ì€ ìµœëŒ€ 1000ìê¹Œì§€ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  try {
    const response = await fetch(`/api/comments/${commentId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        content: newContent,
        userId: currentUser.userId
      })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      alert(result.message || 'ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ í˜ì´ì§€ ìœ ì§€)
    await loadComments(currentCommentPage);
    
    alert('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (error) {
    console.error('ëŒ“ê¸€ ìˆ˜ì • ì˜¤ë¥˜:', error);
    alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ëŒ“ê¸€ ì‚­ì œ
async function deleteComment(commentId, authorId) {
  // ë¡œê·¸ì¸ í™•ì¸
  if (!checkLoginStatus()) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  // ì‘ì„±ì í™•ì¸
  if (currentUser.userId !== authorId) {
    alert('ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/comments/${commentId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        userId: currentUser.userId
      })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      alert(result.message || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ í˜ì´ì§€ ìœ ì§€, í•„ìš”ì‹œ ì´ì „ í˜ì´ì§€ë¡œ)
    const totalComments = allComments.length - 1;
    const totalPages = Math.ceil(totalComments / COMMENTS_PER_PAGE);
    const targetPage = currentCommentPage > totalPages && totalPages > 0 ? totalPages : currentCommentPage;
    await loadComments(targetPage);
    
    alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (error) {
    console.error('ëŒ“ê¸€ ì‚­ì œ ì˜¤ë¥˜:', error);
    alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ëŒ“ê¸€ ê¸€ì ìˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
function updateCharCount() {
  const textarea = document.getElementById('commentTextarea');
  const charCount = document.getElementById('commentCharCount');
  charCount.textContent = textarea.value.length;
}

// ëª©ë¡ìœ¼ë¡œ ì´ë™ (í•´ë‹¹ ê²Œì‹œíŒê³¼ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™)
async function goBackToList() {
  if (!currentPostData.boardId) {
    // ê²Œì‹œíŒ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì´ì „ í˜ì´ì§€ë¡œ
    window.history.back();
    return;
  }
  
  try {
    // í•´ë‹¹ ê²Œì‹œê¸€ì´ ëª‡ í˜ì´ì§€ì— ìˆëŠ”ì§€ ê³„ì‚°
    let targetPage = 1;
    
    if (currentPostData.categoryId && postId) {
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì—ì„œ ê²Œì‹œê¸€ì˜ ìœ„ì¹˜ ê³„ì‚°
      const limit = currentPostData.boardId === '1' ? 20 : 10; // ë ˆì‹œí”¼: 20ê°œ/í˜ì´ì§€, ì •ë³´ ê³µìœ : 10ê°œ/í˜ì´ì§€
      const apiUrl = currentPostData.boardId === '1' 
        ? `/api/recipes?category=${currentPostData.categoryId}&limit=${limit}`
        : `/api/tips?category=${currentPostData.categoryId}&limit=${limit}`;
      
      try {
        // ì²« í˜ì´ì§€ë¶€í„° ìˆœíšŒí•˜ë©´ì„œ í•´ë‹¹ ê²Œì‹œê¸€ ì°¾ê¸°
        const firstPageResponse = await fetch(`${apiUrl}&page=1`);
        const firstPageResult = await firstPageResponse.json();
        
        if (firstPageResult.success && firstPageResult.pagination) {
          const totalPages = firstPageResult.pagination.totalPages;
          const postIdField = currentPostData.boardId === '1' ? 'RECIPE_ID' : 'TIP_ID';
          
          // ê° í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì—¬ í•´ë‹¹ ê²Œì‹œê¸€ ì°¾ê¸°
          for (let page = 1; page <= totalPages && page <= 10; page++) { // ìµœëŒ€ 10í˜ì´ì§€ê¹Œì§€ë§Œ í™•ì¸
            const pageResponse = await fetch(`${apiUrl}&page=${page}`);
            const pageResult = await pageResponse.json();
            
            if (pageResult.success && pageResult.data) {
              const foundIndex = pageResult.data.findIndex(post => post[postIdField] == postId);
              
              if (foundIndex !== -1) {
                targetPage = page;
                break;
              }
            }
          }
        }
      } catch (error) {
        console.warn('í˜ì´ì§€ ê³„ì‚° ì‹¤íŒ¨, ì²« í˜ì´ì§€ë¡œ ì´ë™:', error);
        targetPage = 1;
      }
    }
    
    // ê²Œì‹œíŒ ëª©ë¡ìœ¼ë¡œ ì´ë™
    const params = new URLSearchParams();
    params.set('board', currentPostData.boardId);
    if (currentPostData.categoryId) {
      params.set('category', currentPostData.categoryId);
    }
    if (targetPage > 1) {
      params.set('page', targetPage);
    }
    
    window.location.href = `/board.html?${params.toString()}`;
  } catch (error) {
    console.error('ëª©ë¡ìœ¼ë¡œ ì´ë™ ì˜¤ë¥˜:', error);
    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ê²Œì‹œíŒìœ¼ë¡œ ì´ë™
    const params = new URLSearchParams();
    params.set('board', currentPostData.boardId);
    if (currentPostData.categoryId) {
      params.set('category', currentPostData.categoryId);
    }
    window.location.href = `/board.html?${params.toString()}`;
  }
}

// ê²Œì‹œê¸€ ìˆ˜ì •
function editPost() {
  if (!postType || !postId) {
    alert('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // post-editor.htmlë¡œ ì´ë™í•˜ë©´ì„œ postIdì™€ postType ì „ë‹¬
  window.location.href = `/post-editor.html?postId=${postId}&postType=${postType}`;
}

// ê²Œì‹œê¸€ ì‚­ì œ
async function deletePost() {
  if (!postType || !postId) {
    alert('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ê²Œì‹œê¸€ì€ ëª©ë¡ì—ì„œ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
    return;
  }
  
  try {
    // MENU_ID 1 = ë ˆì‹œí”¼ ê²Œì‹œíŒ, MENU_ID 2 = ì •ë³´ ê³µìœ  ê²Œì‹œíŒ
    const apiUrl = postType === '1' 
      ? `/api/recipes/${postId}`
      : `/api/tips/${postId}`;
    
    const response = await fetch(apiUrl, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        authorName: '' // í•„ìš”ì‹œ ì‘ì„±ì ì´ë¦„ í™•ì¸ ì¶”ê°€ ê°€ëŠ¥
      })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      alert(result.message || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    
    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    
    // ê²Œì‹œíŒ ëª©ë¡ìœ¼ë¡œ ì´ë™ (postTypeì´ ì´ë¯¸ MENU_ID)
    window.location.href = `/board.html?board=${postType}`;
  } catch (error) {
    console.error('ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:', error);
    alert('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', async function() {
  // GNB ë Œë”ë§
  await window.Gnb.render({
    containerId: 'gnb-root',
    activeMenu: null, // ê²Œì‹œê¸€ ìƒì„¸ëŠ” íŠ¹ì • ë©”ë‰´ì— ì†í•˜ì§€ ì•ŠìŒ
    showMyInfo: true,
    onReady: (refs) => {
      // ë ˆì‹œí”¼/ì •ë³´ê³µìœ  ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²°
      if (refs.recipeBtn) {
        refs.recipeBtn.addEventListener('click', () => {
          window.location.href = '/board.html?board=1';
        });
      }
      if (refs.tipBtn) {
        refs.tipBtn.addEventListener('click', () => {
          window.location.href = '/board.html?board=2';
        });
      }
    }
  });
  
  await loadPost();
  
  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ëŒ“ê¸€ í¼ í‘œì‹œ
  const isLoggedIn = checkLoginStatus();
  
  if (isLoggedIn && currentUser) {
    // ì°¨ë‹¨ëœ ì‚¬ìš©ìëŠ” ëŒ“ê¸€ ì‘ì„± í¼ ìˆ¨ê¸°ê¸°
    if (currentUser.blocked === true) {
      document.getElementById('commentForm').style.display = 'none';
      document.getElementById('commentLoginNotice').style.display = 'none';
    } else {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì: ëŒ“ê¸€ ì‘ì„± í¼ í‘œì‹œ
      document.getElementById('commentForm').style.display = 'block';
      document.getElementById('commentLoginNotice').style.display = 'none';
    }
  } else {
    // ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì: ë¡œê·¸ì¸ ì•ˆë‚´ í‘œì‹œ
    document.getElementById('commentForm').style.display = 'none';
    document.getElementById('commentLoginNotice').style.display = 'block';
  }
  
  // ê²Œì‹œê¸€ ë¡œë“œ í›„ ëŒ“ê¸€ ì„¹ì…˜ í‘œì‹œ ë° ëŒ“ê¸€ ë¡œë“œ
  document.getElementById('commentsSection').style.display = 'block';
  await loadComments();
  
  if (isLoggedIn) {
    // ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('commentSubmitBtn').addEventListener('click', submitComment);
    
    // ëŒ“ê¸€ ê¸€ì ìˆ˜ ì¹´ìš´í„°
    document.getElementById('commentTextarea').addEventListener('input', updateCharCount);
    
    // ì—”í„°í‚¤ë¡œ ëŒ“ê¸€ ì‘ì„± (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
    document.getElementById('commentTextarea').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitComment();
      }
    });
  }
  
  // ê²Œì‹œê¸€ ìˆ˜ì •/ì‚­ì œ ë©”ë‰´ ëª¨ë‹¬ í† ê¸€
  const postMenuBtn = document.getElementById('postMenuBtn');
  const postMenuModal = document.getElementById('postMenuModal');
  
  if (postMenuBtn && postMenuModal) {
    postMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = postMenuModal.style.display === 'block';
      postMenuModal.style.display = isVisible ? 'none' : 'block';
    });
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', (e) => {
      if (!postMenuBtn.contains(e.target) && !postMenuModal.contains(e.target)) {
        postMenuModal.style.display = 'none';
      }
    });
    
    // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('editPostBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      postMenuModal.style.display = 'none';
      editPost();
    });
    
    document.getElementById('deletePostBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      postMenuModal.style.display = 'none';
      deletePost();
    });
  }
  
  // ëŒ“ê¸€ í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('prevPageBtn').addEventListener('click', () => {
    if (currentCommentPage > 1) {
      loadComments(currentCommentPage - 1);
    }
  });
  
  document.getElementById('nextPageBtn').addEventListener('click', () => {
    const totalPages = Math.ceil(allComments.length / COMMENTS_PER_PAGE);
    if (currentCommentPage < totalPages) {
      loadComments(currentCommentPage + 1);
    }
  });
  
  // ì¶”ì²œ ë° ë¶ë§ˆí¬ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('likeBtn').addEventListener('click', toggleLike);
  document.getElementById('bookmarkBtn').addEventListener('click', toggleBookmark);
  
  // ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('backToListBtn').addEventListener('click', goBackToList);
  
  // Footer ë¡œë“œ
  fetch('/footer.html')
    .then(res => res.text())
    .then(html => {
      const footer = document.getElementById('site-footer');
      if (footer) {
        footer.innerHTML = html;
      }
    })
    .catch(err => console.error('Footer ë¡œë“œ ì‹¤íŒ¨:', err));
});
</script>
</body>
</html>

