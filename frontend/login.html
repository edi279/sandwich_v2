<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://accounts.google.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net;">
  <title>샌냠 로그인</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/variables.css">
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/components.css">
  <link rel="stylesheet" href="/assets/css/auth.css">
  <style>
    body {
      background: linear-gradient(135deg, #fff5f8 0%, #ffe0e6 50%, #fff 100%);
      min-height: 100vh;
    }

    .auth-panel {
      width: min(420px, 100%);
    }

    .auth-title {
      font-size: 1.95rem;
    }

    .primary-button {
      width: 100%;
      margin-top: 1rem;
    }

    .outline-button {
      width: 100%;
      margin-top: -0.9rem;
    }

    .notice-area {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="auth-wrapper">
    <section class="auth-panel">
      <header>
        <h1 class="auth-title">이메일로 로그인</h1>
        <p class="auth-subtitle">샌냠 회원이라면 이메일과 비밀번호로 로그인해 주세요.</p>
      </header>

      <form id="email-login-form" class="auth-form">
        <div class="form-group">
          <label for="login-email">이메일</label>
          <input type="email" id="login-email" name="email" placeholder="example@sandwich.com" required>
        </div>
        <div class="form-group">
          <label for="login-password">비밀번호</label>
          <input type="password" id="login-password" name="password" placeholder="비밀번호를 입력해 주세요" required>
        </div>
        <button type="submit" class="primary-button">로그인</button>
      </form>
      <div id="login-notice" class="notice-area"></div>

      <button id="google-login-button" type="button" class="outline-button">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" width="20" height="20" aria-hidden="true">
        구글 계정으로 계속하기
      </button>
      <div id="google-notice" class="notice-area"></div>

      <div class="link-group">
        <a href="/home.html">홈으로</a>
        <span>|</span>
        <a href="/find-password.html">비밀번호 찾기</a>
        <span>|</span>
        <a href="/register.html">회원가입</a>
      </div>
    </section>
  </div>

  <script>
    const emailLoginForm = document.getElementById('email-login-form');
    const googleLoginButton = document.getElementById('google-login-button');

    const loginNotice = document.getElementById('login-notice');
    const googleNotice = document.getElementById('google-notice');

    const showNotice = (element, message, type = 'info') => {
      element.textContent = message;
      element.classList.add('active');
      element.style.color = type === 'error' ? '#d6336c' : '#ff6b9d';
    };

    const clearNotice = (element) => {
      element.textContent = '';
      element.classList.remove('active');
    };

    emailLoginForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearNotice(loginNotice);

      const formData = new FormData(emailLoginForm);
      const payload = {
        email: formData.get('email'),
        password: formData.get('password')
      };

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (!response.ok || !result.success) {
          showNotice(loginNotice, result.message || '로그인에 실패했습니다.', 'error');
          return;
        }

        showNotice(loginNotice, '로그인에 성공했습니다! 환영합니다 :)');
        emailLoginForm.reset();
        if (result.data) {
          try {
            localStorage.setItem('sandwichUser', JSON.stringify(result.data));
          } catch (error) {
            console.warn('사용자 정보를 저장하지 못했습니다.', error);
          }
        }
        
        // 차단된 사용자 확인
        if (result.blocked) {
          alert('차단된 회원입니다. 관리자에게 문의하세요.');
        }
        
        setTimeout(() => {
          window.location.href = '/home.html';
        }, 800);
      } catch (error) {
        console.error(error);
        showNotice(loginNotice, '로그인 처리 중 문제가 발생했습니다. 잠시 후 다시 시도해 주세요.', 'error');
      }
    });

    const simulateGoogleOAuth = async () => {
      // TODO: 실제 Google OAuth 연동으로 교체하세요.
      // 현재는 데모 목적의 모의 데이터를 전송합니다.
      const demoEmail = prompt('구글 계정 이메일을 입력해 주세요.');
      if (!demoEmail) return;

      const mockGoogleId = (window.crypto && typeof window.crypto.randomUUID === 'function')
        ? window.crypto.randomUUID()
        : `google-${Date.now()}`;
      const nickname = demoEmail.split('@')[0];

      try {
        clearNotice(googleNotice);
        const response = await fetch('/api/auth/google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: demoEmail,
            googleId: mockGoogleId,
            nickname,
            eventOptIn: true
          })
        });
        const result = await response.json();

        if (!response.ok || !result.success) {
          showNotice(googleNotice, result.message || '구글 로그인에 실패했습니다.', 'error');
          return;
        }

        showNotice(googleNotice, result.message || '구글 계정으로 로그인되었습니다!');
        if (result.data) {
          try {
            localStorage.setItem('sandwichUser', JSON.stringify(result.data));
          } catch (error) {
            console.warn('사용자 정보를 저장하지 못했습니다.', error);
          }
        }
        
        // 차단된 사용자 확인
        if (result.blocked) {
          alert('차단된 회원입니다. 관리자에게 문의하세요.');
        }
        
        setTimeout(() => {
          window.location.href = '/home.html';
        }, 800);
      } catch (error) {
        console.error(error);
        showNotice(googleNotice, '구글 로그인 처리 중 오류가 발생했습니다.', 'error');
      }
    };

    googleLoginButton.addEventListener('click', simulateGoogleOAuth);
  </script>
</body>
</html>

