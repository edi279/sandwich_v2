<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net;">
  <title>샌드위치냠냠 홈</title>
  <link rel="stylesheet" href="/assets/css/gnb.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    :root {
      --gnb-width: 80px;
      --primary-pink: #ff6b9d;
      --soft-pink: #ffe0e6;
      --soft-gray: #f8f9fa;
      --border-color: #f1f3f5;
      --text-dark: #333;
      --text-muted: #868e96;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background-color: var(--soft-gray);
      font-family: 'Pretendard', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text-dark);
    }

    .home-container {
      display: flex;
      min-height: 100vh;
    }


    .home-main {
      margin-left: var(--gnb-width);
      flex: 1;
      padding: 3rem 4rem;
      position: relative;
    }

    .home-header {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .service-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-pink);
      letter-spacing: 2px;
    }

    .search-area {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .search-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background-color: #fff;
      border-radius: 40px;
      border: 1.5px solid #ffd6e1;
      box-shadow: 0 4px 16px rgba(255, 107, 157, 0.08);
      max-width: 640px;
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 1rem;
      padding: 0 0.5rem;
      color: var(--text-dark);
    }

    .search-input::placeholder {
      color: #adb5bd;
    }

    .search-button {
      border: none;
      background: transparent;
      color: var(--primary-pink);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .search-button:hover {
      transform: scale(1.1);
    }

    .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      max-width: 820px;
    }

    .tag-button {
      border: 1px solid rgba(255, 107, 157, 0.35);
      background-color: #fff;
      color: var(--primary-pink);
      border-radius: 999px;
      padding: 0.45rem 1.25rem;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tag-button:hover {
      background-color: rgba(255, 107, 157, 0.12);
      border-color: rgba(255, 107, 157, 0.55);
    }

    .featured-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
    }

    .thumbnail-card {
      position: relative;
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      background-color: #fff;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      aspect-ratio: 3 / 4;
    }

    .thumbnail-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 40px rgba(255, 107, 157, 0.18);
    }

    .thumbnail-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .thumbnail-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.4) 100%);
      display: flex;
      align-items: flex-end;
      padding: 1rem;
      color: #fff;
      font-size: 0.95rem;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .empty-state {
      padding: 2.5rem;
      text-align: center;
      color: var(--text-muted);
      background-color: #fff;
      border-radius: 18px;
      border: 1px dashed rgba(255, 107, 157, 0.3);
    }

    #site-footer {
      margin-top: 4rem;
    }

    .auth-actions {
      position: absolute;
      top: 2.5rem;
      right: 4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .auth-link {
      text-decoration: none;
      color: var(--primary-pink);
      font-weight: 600;
      transition: color 0.2s ease;
    }

    .auth-link:hover {
      color: #ff4f8d;
    }

    .auth-separator {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    @media (max-width: 1024px) {
      .home-main {
        padding: 2.5rem 2rem;
      }

      .service-title {
        font-size: 2.2rem;
      }

      .thumbnail-grid {
        gap: 1.25rem;
      }

      .auth-actions {
        top: 2rem;
        right: 2rem;
      }
    }

    @media (max-width: 768px) {
      :root {
        --gnb-width: 64px;
      }

      .home-main {
        padding: 2rem 1.5rem;
      }

      .service-title {
        font-size: 2rem;
      }

      .search-bar {
        max-width: 100%;
      }

      .thumbnail-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
      }

      .auth-actions {
        top: 1.5rem;
        right: 1.5rem;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 540px) {
      .home-main {
        padding: 1.8rem 1.2rem;
      }

      .service-title {
        font-size: 1.8rem;
      }

      .tag-cloud {
        gap: 0.6rem;
      }

      .tag-button {
        font-size: 0.85rem;
        padding: 0.35rem 1rem;
      }

      .auth-actions {
        position: static;
        justify-content: flex-end;
        margin-bottom: 1rem;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="home-container">
    <div id="gnb-root"></div>

    <main class="home-main">
      <div class="auth-actions" id="authActions">
        <a href="/login.html" class="auth-link">로그인</a>
        <span class="auth-separator">|</span>
        <a href="/register.html" class="auth-link">회원가입</a>
      </div>
      <header class="home-header">
        <h1 class="service-title">샌드위치냠냠</h1>

        <section class="search-area">
          <div class="search-bar" role="search">
            <input class="search-input" id="homeSearchInput" type="search" placeholder="원하는 샌드위치 레시피를 검색해보세요!" aria-label="전체 게시글 검색">
            <button class="search-button" id="homeSearchButton" type="button" aria-label="검색 실행">
              ↵
            </button>
          </div>

          <div class="tag-cloud" id="popularTags" aria-label="인기 태그"></div>
        </section>
      </header>

      <section class="featured-section" aria-labelledby="featuredTitle">
        <h2 class="section-title" id="featuredTitle">이달의 레시피</h2>
        <div class="thumbnail-grid" id="featuredPosts"></div>
      </section>

      <div id="site-footer"></div>
    </main>
  </div>

  <script src="/assets/js/gnb.js"></script>
  <script>
    const FEATURE_LIMIT = 12;
    const TAG_LIMIT = 13;

    function getStoredUser() {
      try {
        const raw = localStorage.getItem('sandwichUser');
        return raw ? JSON.parse(raw) : null;
      } catch (error) {
        console.warn('저장된 사용자 정보를 불러오지 못했습니다.', error);
        return null;
      }
    }

    function applyAuthState(user, gnbRefs) {
      const authActions = document.getElementById('authActions');
      const isLoggedIn = !!user;

      if (authActions) {
        authActions.style.display = isLoggedIn ? 'none' : 'flex';
      }

      if (gnbRefs && gnbRefs.myInfoBtn) {
        gnbRefs.myInfoBtn.style.display = isLoggedIn ? 'flex' : 'none';
      }
    }

    function renderTags(tagList) {
      const container = document.getElementById('popularTags');
      container.innerHTML = '';

      if (!tagList.length) {
        container.innerHTML = '<p class="text-muted mb-0">인기 태그를 불러오는 중입니다...</p>';
        return;
      }

      tagList.slice(0, TAG_LIMIT).forEach(({ tag }) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'tag-button';
        button.textContent = tag.startsWith('#') ? tag : `#${tag}`;
        button.addEventListener('click', () => {
          console.info(`[TODO] 태그 선택: ${tag} - 태그 기반 검색 결과 노출 예정입니다.`);
        });
        container.appendChild(button);
      });
    }

    function renderFeaturedPosts(posts) {
      const grid = document.getElementById('featuredPosts');
      grid.innerHTML = '';

      if (!posts.length) {
        grid.innerHTML = '<div class="empty-state">아직 추천된 레시피가 없어요. 새로운 레시피를 등록해볼까요?</div>';
        return;
      }

      posts.slice(0, FEATURE_LIMIT).forEach(post => {
        const card = document.createElement('article');
        card.className = 'thumbnail-card';
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
        card.title = `${post.title} 상세보기`;

        const img = document.createElement('img');
        img.src = post.imageUrl || 'https://images.unsplash.com/photo-1569058242341-6eb9337c8ecc?q=80&w=900';
        img.alt = post.title || '샌드위치 레시피 썸네일';
        img.loading = 'lazy';
        img.onerror = () => {
          img.src = 'https://images.unsplash.com/photo-1603046891744-56e936d73ef1?q=80&w=900';
        };

        const overlay = document.createElement('div');
        overlay.className = 'thumbnail-overlay';
        overlay.textContent = post.title || '샌드위치 레시피';

        card.appendChild(img);
        card.appendChild(overlay);

        card.addEventListener('click', () => {
          if (post.href) {
            window.location.href = post.href;
          } else if (post.id) {
            window.location.href = `/post-detail.html?type=1&id=${post.id}`;
          } else {
            console.info('[TODO] 레시피 상세 이동 준비 중입니다.');
          }
        });

        grid.appendChild(card);
      });
    }

    function initSearch() {
      const input = document.getElementById('homeSearchInput');
      const button = document.getElementById('homeSearchButton');

      const triggerSearch = () => {
        const keyword = input.value.trim();
        if (!keyword) {
          input.focus();
          return;
        }
        console.info(`[TODO] 전체 검색 실행: ${keyword}`);
      };

      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          triggerSearch();
        }
      });

      button.addEventListener('click', triggerSearch);
    }

    async function loadHomeData() {
      const tagsContainer = document.getElementById('popularTags');
      const postsContainer = document.getElementById('featuredPosts');

      try {
        const response = await fetch('/api/home');
        if (!response.ok) {
          throw new Error(`서버 응답 오류 (${response.status})`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.message || '데이터를 불러오지 못했습니다.');
        }

        const tags = Array.isArray(result.data?.tags) ? result.data.tags : [];
        const posts = Array.isArray(result.data?.featuredPosts) ? result.data.featuredPosts : [];

        renderTags(tags);
        renderFeaturedPosts(posts);
      } catch (error) {
        console.error('홈 데이터 로드 오류:', error);
        if (tagsContainer) {
          tagsContainer.innerHTML = '<p class="text-danger mb-0">인기 태그를 불러오지 못했습니다.</p>';
        }
        if (postsContainer) {
          postsContainer.innerHTML = '<div class="empty-state text-danger">추천 레시피를 불러오지 못했습니다.</div>';
        }
      }
    }

    function setupHomeGnb(gnbRefs) {
      if (!gnbRefs) return;

      const { recipeBtn, tipBtn } = gnbRefs;

      if (recipeBtn) {
        recipeBtn.addEventListener('click', () => {
          window.location.href = '/board.html?board=1';
        });
      }

      if (tipBtn) {
        tipBtn.addEventListener('click', () => {
          window.location.href = '/board.html?board=2';
        });
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const currentUser = getStoredUser();
      let gnbRefs = null;

      await Gnb.render({
        containerId: 'gnb-root',
        activeMenu: null,
        showMyInfo: !!currentUser,
        onReady: (refs) => {
          gnbRefs = refs;
          setupHomeGnb(refs);
        }
      });

      applyAuthState(currentUser, gnbRefs);

      initSearch();
      loadHomeData();

      fetch('/footer.html')
        .then(res => res.ok ? res.text() : Promise.reject(new Error('NOT_FOUND')))
        .then(html => {
          const footer = document.getElementById('site-footer');
          if (footer) {
            footer.innerHTML = html;
          }
        })
        .catch(err => console.warn('Footer 로드 실패:', err));

      window.addEventListener('storage', (event) => {
        if (event.key === 'sandwichUser') {
          applyAuthState(getStoredUser(), gnbRefs);
        }
      });
    });
  </script>
</body>
</html>

