<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net;">
  <title>샌냠 홈</title>
  <link rel="stylesheet" href="/assets/css/gnb.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/variables.css">
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/layout.css">
  <link rel="stylesheet" href="/assets/css/components.css">
  <link rel="stylesheet" href="/assets/css/pages.css">
</head>
<body>
  <div class="home-container">
    <div id="gnb-root"></div>

    <main class="home-main">
      <div class="auth-actions" id="authActions">
        <a href="/login.html" class="auth-link">로그인</a>
        <span class="auth-separator">|</span>
        <a href="/register.html" class="auth-link">회원가입</a>
      </div>
      <header class="home-header">
        <h1 class="service-title">샌냠 sannyam</h1>

        <section class="search-area">
          <div class="search-bar" role="search">
            <input class="search-input" id="homeSearchInput" type="search" placeholder="원하는 샌드위치 레시피를 검색해보세요!" aria-label="전체 게시글 검색">
            <button class="search-button" id="homeSearchButton" type="button" aria-label="검색 실행">
              ↵
            </button>
          </div>

          <div class="tag-cloud" id="popularTags" aria-label="인기 태그"></div>
        </section>
      </header>

      <section class="featured-section" id="featuredSection">
        <div class="recipe-slider-wrapper">
          <div class="recipe-slider" id="featuredPosts"></div>
          <button class="slider-nav slider-prev" id="sliderPrev" aria-label="이전 슬라이드">‹</button>
          <button class="slider-nav slider-next" id="sliderNext" aria-label="다음 슬라이드">›</button>
          <div class="slider-pagination" id="sliderPagination"></div>
        </div>
      </section>

      <div id="site-footer"></div>
    </main>
  </div>

  <script src="/assets/js/gnb.js"></script>
  <script>
    const FEATURE_LIMIT = 8;
    const TAG_LIMIT = 13;

    function getStoredUser() {
      try {
        const raw = localStorage.getItem('sandwichUser');
        return raw ? JSON.parse(raw) : null;
      } catch (error) {
        console.warn('저장된 사용자 정보를 불러오지 못했습니다.', error);
        return null;
      }
    }

    function applyAuthState(user, gnbRefs) {
      const authActions = document.getElementById('authActions');
      const isLoggedIn = !!user;

      if (authActions) {
        authActions.style.display = isLoggedIn ? 'none' : 'flex';
      }

      if (gnbRefs && gnbRefs.myInfoBtn) {
        gnbRefs.myInfoBtn.style.display = isLoggedIn ? 'flex' : 'none';
      }
    }

    function renderTags(tagList) {
      const container = document.getElementById('popularTags');
      container.innerHTML = '';

      if (!tagList.length) {
        container.innerHTML = '<p class="text-muted mb-0">인기 태그를 불러오는 중입니다...</p>';
        return;
      }

      tagList.slice(0, TAG_LIMIT).forEach(({ tag }) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'tag-button';
        button.textContent = tag.startsWith('#') ? tag : `#${tag}`;
        button.addEventListener('click', () => {
          // 태그 검색 페이지로 이동 (# 포함)
          const tagName = tag.startsWith('#') ? tag : `#${tag}`;
          window.location.href = `/search.html?q=${encodeURIComponent(tagName)}`;
        });
        container.appendChild(button);
      });
    }

    let currentSlide = 0;
    let slidesPerView = 4;

    function updateSliderButtons() {
      const slider = document.getElementById('featuredPosts');
      const prevBtn = document.getElementById('sliderPrev');
      const nextBtn = document.getElementById('sliderNext');
      
      if (!slider || !prevBtn || !nextBtn) return;

      const maxSlide = Math.max(0, slider.children.length - slidesPerView);
      prevBtn.disabled = currentSlide === 0;
      nextBtn.disabled = currentSlide >= maxSlide;
    }

    function updatePagination() {
      const slider = document.getElementById('featuredPosts');
      const pagination = document.getElementById('sliderPagination');
      
      if (!slider || !pagination) return;

      const totalSlides = slider.children.length;
      const totalPages = Math.ceil(totalSlides / slidesPerView);
      
      pagination.innerHTML = '';
      
      for (let i = 0; i < totalPages; i++) {
        const dot = document.createElement('button');
        dot.className = `slider-pagination-dot ${i === Math.floor(currentSlide / slidesPerView) ? 'active' : ''}`;
        dot.setAttribute('aria-label', `${i + 1}페이지`);
        dot.addEventListener('click', () => {
          currentSlide = i * slidesPerView;
          scrollToSlide();
        });
        pagination.appendChild(dot);
      }
    }

    function scrollToSlide() {
      const slider = document.getElementById('featuredPosts');
      if (!slider || !slider.children.length) return;

      const cardWidth = slider.children[0].offsetWidth;
      const gap = parseInt(getComputedStyle(slider).gap) || 24;
      const scrollPosition = currentSlide * (cardWidth + gap);
      
      slider.scrollTo({
        left: scrollPosition,
        behavior: 'smooth'
      });
      
      updateSliderButtons();
      updatePagination();
    }

    function initSlider() {
      const prevBtn = document.getElementById('sliderPrev');
      const nextBtn = document.getElementById('sliderNext');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (currentSlide > 0) {
            currentSlide--;
            scrollToSlide();
          }
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          const slider = document.getElementById('featuredPosts');
          if (slider && currentSlide < slider.children.length - slidesPerView) {
            currentSlide++;
            scrollToSlide();
          }
        });
      }

      // 반응형 처리
      function updateSlidesPerView() {
        const width = window.innerWidth;
        if (width < 540) {
          slidesPerView = 1;
        } else if (width < 768) {
          slidesPerView = 2;
        } else if (width < 1024) {
          slidesPerView = 3;
        } else {
          slidesPerView = 4;
        }
        updateSliderButtons();
        updatePagination();
      }

      window.addEventListener('resize', updateSlidesPerView);
      updateSlidesPerView();
    }

    function renderFeaturedPosts(posts) {
      const slider = document.getElementById('featuredPosts');
      slider.innerHTML = '';

      if (!posts.length) {
        slider.innerHTML = '<div class="empty-state">아직 추천된 레시피가 없어요. 새로운 레시피를 등록해볼까요?</div>';
        return;
      }

      posts.slice(0, FEATURE_LIMIT).forEach(post => {
        const previewCard = document.createElement('article');
        previewCard.className = 'recipe-preview-card';
        previewCard.setAttribute('role', 'button');
        previewCard.setAttribute('tabindex', '0');
        previewCard.title = `${post.title} 상세보기`;

        const imgWrapper = document.createElement('div');
        imgWrapper.className = 'recipe-preview-image';

        const img = document.createElement('img');
        img.src = post.imageUrl || 'https://images.unsplash.com/photo-1569058242341-6eb9337c8ecc?q=80&w=900';
        img.alt = post.title || '샌드위치 레시피 썸네일';
        img.loading = 'lazy';
        img.onerror = () => {
          img.src = 'https://images.unsplash.com/photo-1603046891744-56e936d73ef1?q=80&w=900';
        };

        imgWrapper.appendChild(img);

        previewCard.appendChild(imgWrapper);

        previewCard.addEventListener('click', () => {
          if (post.href) {
            window.location.href = post.href;
          } else if (post.id) {
            window.location.href = `/post-detail.html?type=1&id=${post.id}`;
          } else {
            console.info('[TODO] 레시피 상세 이동 준비 중입니다.');
          }
        });

        slider.appendChild(previewCard);
      });

      // 슬라이더 초기화
      setTimeout(() => {
        initSlider();
        updateSliderButtons();
        updatePagination();
      }, 100);
    }

    function initSearch() {
      const input = document.getElementById('homeSearchInput');
      const button = document.getElementById('homeSearchButton');

      const triggerSearch = () => {
        const keyword = input.value.trim();
        if (!keyword) {
          input.focus();
          return;
        }
        
        // 최소 2글자 검증
        if (keyword.length < 2) {
          alert('검색어는 최소 2글자 이상이어야 합니다.');
          input.focus();
          return;
        }

        // 검색 결과 페이지로 이동
        window.location.href = `/search.html?q=${encodeURIComponent(keyword)}`;
      };

      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          triggerSearch();
        }
      });

      button.addEventListener('click', triggerSearch);
    }

    async function loadHomeData() {
      const tagsContainer = document.getElementById('popularTags');
      const postsContainer = document.getElementById('featuredPosts');

      try {
        const response = await fetch('/api/home');
        if (!response.ok) {
          throw new Error(`서버 응답 오류 (${response.status})`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.message || '데이터를 불러오지 못했습니다.');
        }

        const tags = Array.isArray(result.data?.tags) ? result.data.tags : [];
        const posts = Array.isArray(result.data?.featuredPosts) ? result.data.featuredPosts : [];

        renderTags(tags);
        renderFeaturedPosts(posts);
      } catch (error) {
        console.error('홈 데이터 로드 오류:', error);
        if (tagsContainer) {
          tagsContainer.innerHTML = '<p class="text-danger mb-0">인기 태그를 불러오지 못했습니다.</p>';
        }
        if (postsContainer) {
          postsContainer.innerHTML = '<div class="empty-state text-danger">추천 레시피를 불러오지 못했습니다.</div>';
        }
      }
    }

    function setupHomeGnb(gnbRefs) {
      if (!gnbRefs) return;

      const { recipeBtn, tipBtn } = gnbRefs;

      if (recipeBtn) {
        recipeBtn.addEventListener('click', () => {
          window.location.href = '/board.html?board=1';
        });
      }

      if (tipBtn) {
        tipBtn.addEventListener('click', () => {
          window.location.href = '/board.html?board=2';
        });
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const currentUser = getStoredUser();
      let gnbRefs = null;

      await Gnb.render({
        containerId: 'gnb-root',
        activeMenu: null,
        showMyInfo: !!currentUser,
        onReady: (refs) => {
          gnbRefs = refs;
          setupHomeGnb(refs);
        }
      });

      applyAuthState(currentUser, gnbRefs);

      initSearch();
      loadHomeData();

      fetch('/footer.html')
        .then(res => res.ok ? res.text() : Promise.reject(new Error('NOT_FOUND')))
        .then(html => {
          const footer = document.getElementById('site-footer');
          if (footer) {
            footer.innerHTML = html;
          }
        })
        .catch(err => console.warn('Footer 로드 실패:', err));

      window.addEventListener('storage', (event) => {
        if (event.key === 'sandwichUser') {
          applyAuthState(getStoredUser(), gnbRefs);
        }
      });
    });
  </script>
</body>
</html>

