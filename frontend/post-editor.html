<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.youtube.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; frame-src 'self' https://www.youtube.com; connect-src 'self' https://cdn.jsdelivr.net;">
<title>ê²Œì‹œê¸€ ì‘ì„± - ìƒŒëƒ </title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/variables.css">
<link rel="stylesheet" href="/assets/css/base.css">
<link rel="stylesheet" href="/assets/css/pages.css">
<style>
main { padding-top: 2rem; padding-bottom: 4rem; }
.tag-input { border-radius: 0.375rem; }
.tag-badge { margin: 0.25rem; cursor: pointer; }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">ìƒŒëƒ </a>
  </div>
</nav>

<main class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="editor-container">
        <form id="postForm">
          <!-- ìƒë‹¨ ë°”: ì¹´í…Œê³ ë¦¬ì™€ ë²„íŠ¼ -->
          <div class="editor-top-bar">
            <div class="editor-top-bar-left">
              <select class="form-select" id="postCategory" name="category" style="width: auto; min-width: 200px;">
                <option value="">ê²Œì‹œíŒ ì„ íƒ</option>
                <!-- ë©”ë‰´ëŠ” ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
              </select>
              <select class="form-select" id="postSubCategory" name="subcategory" style="width: auto; min-width: 200px; margin-left: 0px;" disabled>
                <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
              </select>
            </div>
            <div class="editor-top-bar-right">
              <button type="button" class="btn btn-outline-secondary" id="saveBtn">
                ì„ì‹œ ì €ì¥
              </button>
              <button type="submit" class="btn btn-primary" id="publishBtn">
                ë°œí–‰
              </button>
            </div>
          </div>

          <!-- ì œëª© ì…ë ¥ -->
          <div class="title-input-wrapper">
            <input type="text" class="form-control form-control-lg" id="postTitle" name="title" 
                   placeholder="ê²Œì‹œê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required 
                   maxlength="200" autocomplete="off">
            <span class="title-char-count">
              <span id="titleCharCount">0</span>/200
            </span>
          </div>

          <!-- ë³¸ë¬¸ ì—ë””í„° -->
          <div class="editor-content-wrapper">
            <div class="editor-toolbar" id="editorToolbar" role="toolbar">
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" id="fontSizeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    ë³¸ë¬¸
                </button>
                <ul class="dropdown-menu" aria-labelledby="fontSizeDropdown">
                    <li><a class="dropdown-item" href="#" data-format="h1">H1</a></li>
                    <li><a class="dropdown-item" href="#" data-format="h2">H2</a></li>
                    <li><a class="dropdown-item" href="#" data-format="h3">H3</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" data-format="p">ë³¸ë¬¸</a></li>
                </ul>
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="bold" title="êµµê²Œ">
                <strong>B</strong>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="italic" title="ê¸°ìš¸ì„">
                <em>I</em>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="underline" title="ë°‘ì¤„">
                <u>U</u>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="insertUnorderedList" title="ê¸€ë¨¸ë¦¬ ê¸°í˜¸">
                â€¢ ëª©ë¡
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="insertOrderedList" title="ë²ˆí˜¸ ë§¤ê¸°ê¸°">
                1. ëª©ë¡
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="createLink" title="ë§í¬">
                ğŸ”—
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="imageUploadBtn" title="ì´ë¯¸ì§€">
                ğŸ–¼ï¸
              </button>
              <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
              <div style="flex-grow: 1;"></div>
            </div>
            <div class="editor-content" id="editorContent" contenteditable="true" 
                 placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                 data-placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
            <input type="hidden" id="postContent" name="content" required>
          </div>

          <!-- ëŒ€í‘œ ì´ë¯¸ì§€ ì„¤ì • (ë ˆì‹œí”¼ ê²Œì‹œíŒ ì „ìš©) -->
          <div class="thumbnail-section" id="thumbnailSection">
            <div class="mb-2 d-flex justify-content-between align-items-center">
              <label class="form-label mb-0 fw-semibold">ëŒ€í‘œ ì´ë¯¸ì§€</label>
              <small class="text-muted">ì¸ë„¤ì¼ë¡œ ì‚¬ìš©í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</small>
            </div>
            <div class="thumbnail-card" id="thumbnailCard">
              <img src="" alt="ëŒ€í‘œ ì´ë¯¸ì§€" id="thumbnailImage" style="display:none;">
              <div class="thumbnail-placeholder" id="thumbnailPlaceholder">
                ì•„ì§ ëŒ€í‘œ ì´ë¯¸ì§€ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
              </div>
              <div class="thumbnail-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="thumbnailUploadBtn">
                  ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="thumbnailRemoveBtn" style="display:none;">
                  ì œê±°
                </button>
              </div>
            </div>
            <input type="hidden" id="thumbnailUrl" name="thumbnailUrl">
            <input type="file" id="thumbnailUploadInput" accept="image/*" style="display:none;">
          </div>

          <!-- íƒœê·¸ ì…ë ¥ -->
          <div class="tag-section">
            <div id="tagList" class="mt-2"></div>
            <input type="hidden" id="postTags" name="tags">
            <input type="text" class="form-control tag-input mt-2" id="tagInput" 
                   placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ê³  Enter í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”. íƒœê·¸ëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." 
                   autocomplete="off" maxlength="50">
          </div>
        </form>
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
      <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">ë¯¸ë¦¬ë³´ê¸°</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <h3 id="previewTitle" class="mb-3"></h3>
              <img id="previewThumbnail" src="" alt="ëŒ€í‘œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" class="img-fluid rounded mb-3" style="display:none;">
              <div id="previewContent" class="border-top pt-3"></div>
              <div class="mt-3">
                <small class="text-muted">
                  ì¹´í…Œê³ ë¦¬: <span id="previewCategory"></span> | 
                  íƒœê·¸: <span id="previewTags"></span>
                </small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" id="publishFromModalBtn">ë°œí–‰</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<div id="site-footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script>
// XSS ë°©ì–´ë¥¼ ìœ„í•œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
const SecurityUtils = {
  // HTML ì´ìŠ¤ì¼€ì´í”„
  escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
  },

  // DOMPurifyë¥¼ ì‚¬ìš©í•˜ì—¬ HTML ì •í™”
  sanitizeHtml(dirty) {
    return DOMPurify.sanitize(dirty, {
      ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 
                     'blockquote', 'a', 'img', 'code', 'pre', 'iframe'],
      ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'width', 'height', 'frameborder', 'allow', 
                     'allowfullscreen', 'style'],
      ALLOW_DATA_ATTR: false
    });
  },
  
  // ìœ íŠœë¸Œ URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
  extractYouTubeVideoId(url) {
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
      /youtube\.com\/watch\?.*v=([^&\n?#]+)/
    ];
    
    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match && match[1]) {
        return match[1];
      }
    }
    return null;
  },
  
  // ìœ íŠœë¸Œ ë§í¬ë¥¼ iframeìœ¼ë¡œ ë³€í™˜
  convertYouTubeToIframe(html) {
    if (!html || typeof html !== 'string') return html;
    
    // ì´ë¯¸ iframeì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ë³€í™˜í•˜ì§€ ì•ŠìŒ
    if (html.includes('<iframe') && html.includes('youtube.com/embed')) {
      return html;
    }
    
    // ìœ íŠœë¸Œ URL íŒ¨í„´ ë§¤ì¹­ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
    const youtubePatterns = [
      /https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/gi,
      /https?:\/\/youtu\.be\/([a-zA-Z0-9_-]+)/gi,
      /https?:\/\/(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]+)/gi
    ];
    
    let result = html;
    
    youtubePatterns.forEach(pattern => {
      result = result.replace(pattern, (match, videoId) => {
        return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="max-width: 100%;"></iframe>`;
      });
    });
    
    // <a> íƒœê·¸ ë‚´ì˜ ìœ íŠœë¸Œ ë§í¬ë„ ì²˜ë¦¬
    result = result.replace(/<a[^>]*>(https?:\/\/(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]+))<\/a>/gi, (match, url, videoId) => {
      return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="max-width: 100%;"></iframe>`;
    });
    
    return result;
  },

  // ì…ë ¥ ê²€ì¦
  validateInput(text, maxLength = null) {
    if (typeof text !== 'string') return false;
    if (maxLength && text.length > maxLength) return false;
    return true;
  }
};

async function uploadImageFile(file) {
  const formData = new FormData();
  formData.append('image', file);

  const response = await fetch('/api/upload/image', {
    method: 'POST',
    body: formData
  });

  const result = await response.json();

  if (!response.ok || !result.success) {
    throw new Error(result.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }

  return result;
}

// ì—ë””í„° ê´€ë¦¬
const EditorManager = {
  contentElement: document.getElementById('editorContent'),
  titleElement: document.getElementById('postTitle'),
  contentInput: document.getElementById('postContent'),
  
  init() {
    this.setupToolbar();
    this.setupPlaceholder();
    this.setupWordCount();
    this.setupTagInput();
    this.setupFormSubmit();
    this.setupPasteHandler();
    this.setupEnterKeyHandler();
    this.setupImageUpload();
  },

  setupToolbar() {
    const toolbar = document.getElementById('editorToolbar');
    const fontSizeDropdown = document.getElementById('fontSizeDropdown');
    
    // ì¼ë°˜ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
    toolbar.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-command]');
      if (!btn) return;
      
      e.preventDefault();
      const command = btn.dataset.command;
      const value = btn.dataset.value || null;
      
      this.contentElement.focus();
      
      if (command === 'createLink') {
        const url = prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:');
        if (url && this.isValidUrl(url)) {
          document.execCommand(command, false, url);
        }
      } else {
        document.execCommand(command, false, value);
      }
    });
    
    // í°íŠ¸ í¬ê¸° ë“œë¡­ë‹¤ìš´ ì²˜ë¦¬
    const dropdownMenu = toolbar.querySelector('.dropdown-menu');
    if (dropdownMenu) {
      const dropdownItems = dropdownMenu.querySelectorAll('.dropdown-item');
      dropdownItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const format = item.dataset.format;
          const label = item.textContent.trim();
          
          this.contentElement.focus();
          document.execCommand('formatBlock', false, format);
          
          // ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          fontSizeDropdown.textContent = label;
          
          // Bootstrap ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          const dropdown = bootstrap.Dropdown.getInstance(fontSizeDropdown);
          if (dropdown) {
            dropdown.hide();
          }
        });
      });
    }
    
    // í˜„ì¬ ì„ íƒëœ ë¸”ë¡ì˜ ìŠ¤íƒ€ì¼ì— ë”°ë¼ ë“œë¡­ë‹¤ìš´ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    this.contentElement.addEventListener('keyup', () => this.updateFontSizeDropdown());
    this.contentElement.addEventListener('mouseup', () => this.updateFontSizeDropdown());
  },
  
  updateFontSizeDropdown() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    let element = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
    
    // ìµœìƒìœ„ ë¸”ë¡ ìš”ì†Œ ì°¾ê¸°
    while (element && element !== this.contentElement) {
      const tagName = element.tagName?.toLowerCase();
      if (tagName === 'h1' || tagName === 'h2' || tagName === 'h3' || tagName === 'p') {
        const dropdown = document.getElementById('fontSizeDropdown');
        const labels = { 'h1': 'H1', 'h2': 'H2', 'h3': 'H3', 'p': 'ë³¸ë¬¸' };
        dropdown.textContent = labels[tagName] || 'ë³¸ë¬¸';
        return;
      }
      element = element.parentElement;
    }
  },

  isValidUrl(string) {
    try {
      const url = new URL(string);
      return url.protocol === 'http:' || url.protocol === 'https:';
    } catch (_) {
      return false;
    }
  },

  setupPlaceholder() {
    const element = this.contentElement;
    const placeholder = element.dataset.placeholder;
    
    const checkPlaceholder = () => {
      if (element.textContent.trim() === '') {
        element.classList.add('text-muted');
        element.textContent = placeholder;
      }
    };
    
    element.addEventListener('focus', () => {
      if (element.textContent === placeholder) {
        element.textContent = '';
        element.classList.remove('text-muted');
      }
    });
    
    element.addEventListener('blur', () => {
      if (element.textContent.trim() === '') {
        checkPlaceholder();
      }
    });
    
    checkPlaceholder();
  },

  setupWordCount() {
    // ì œëª© ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
    const updateTitleCount = () => {
      const count = this.titleElement.value.length;
      document.getElementById('titleCharCount').textContent = count;
    };
    
    this.titleElement.addEventListener('input', updateTitleCount);
    updateTitleCount(); // ì´ˆê¸°ê°’ ì„¤ì •
  },

  setupTagInput() {
    const tagInput = document.getElementById('tagInput');
    const tagList = document.getElementById('tagList');
    const tags = [];
    const maxTags = 10;

    const updateTagInput = () => {
      document.getElementById('postTags').value = tags.join(',');
    };

    const addTag = (tagText) => {
      const tag = tagText.trim().toLowerCase();
      
      if (!tag) return false;
      if (tags.length >= maxTags) {
        alert(`íƒœê·¸ëŠ” ìµœëŒ€ ${maxTags}ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        return false;
      }
      if (tags.includes(tag)) {
        alert('ì´ë¯¸ ì¶”ê°€ëœ íƒœê·¸ì…ë‹ˆë‹¤.');
        return false;
      }
      if (tag.length > 20) {
        alert('íƒœê·¸ëŠ” ìµœëŒ€ 20ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return false;
      }
      if (!/^[ê°€-í£a-zA-Z0-9\s]+$/.test(tag)) {
        alert('íƒœê·¸ëŠ” í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return false;
      }

      tags.push(tag);
      updateTagInput();
      renderTags();
      tagInput.value = '';
      return true;
    };

    const removeTag = (tag) => {
      const index = tags.indexOf(tag);
      if (index > -1) {
        tags.splice(index, 1);
        updateTagInput();
        renderTags();
      }
    };

    const renderTags = () => {
      tagList.innerHTML = tags.map(tag => 
        `<span class="badge bg-primary tag-badge">${SecurityUtils.escapeHtml(tag)} <span class="ms-1" style="cursor: pointer;">Ã—</span></span>`
      ).join('');
      
      tagList.querySelectorAll('.tag-badge').forEach((badge, index) => {
        badge.addEventListener('click', () => {
          removeTag(tags[index]);
        });
      });
    };

    tagInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (addTag(tagInput.value)) {
          // íƒœê·¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë¨
        }
      }
    });
  },

  setupFormSubmit() {
    const form = document.getElementById('postForm');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    
    // ë°œí–‰ ë²„íŠ¼ í´ë¦­ ì‹œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
    const publishBtn = document.getElementById('publishBtn');
    publishBtn.addEventListener('click', (e) => {
      e.preventDefault();
      
      // ì œëª© ê²€ì¦
      const title = this.titleElement.value.trim();
      if (!SecurityUtils.validateInput(title, 200)) {
        alert('ì œëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœëŒ€ 200ì)');
        return;
      }
      
      // ë³¸ë¬¸ ê²€ì¦
      let content = this.contentElement.innerHTML;
      if (content.trim() === '' || content === this.contentElement.dataset.placeholder) {
        alert('ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì •í™”ëœ ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
      const textContent = this.contentElement.textContent.trim();
      if (!textContent || textContent === this.contentElement.dataset.placeholder) {
        alert('ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const boardId = document.getElementById('postCategory').value;
      const thumbnailUrlField = document.getElementById('thumbnailUrl');
      const thumbnailUrlValue = thumbnailUrlField ? thumbnailUrlField.value.trim() : '';

      if (boardId === '1' && !thumbnailUrlValue) {
        alert('ë ˆì‹œí”¼ ê²Œì‹œíŒ ê²Œì‹œê¸€ì€ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      content = SecurityUtils.convertYouTubeToIframe(content);
      content = SecurityUtils.sanitizeHtml(content);
      this.contentInput.value = content;
      
      // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
      this.showPreview(previewModal);
    });
    
    // ëª¨ë‹¬ ë‚´ ë°œí–‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤ì œ ë°œí–‰
    const publishFromModalBtn = document.getElementById('publishFromModalBtn');
    publishFromModalBtn.addEventListener('click', () => {
      this.executePublish(previewModal);
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      // ì„ì‹œ ì €ì¥ ë¡œì§
      const title = this.titleElement.value.trim();
      let content = this.contentElement.innerHTML;
      
      // ìœ íŠœë¸Œ ë§í¬ë¥¼ iframeìœ¼ë¡œ ë³€í™˜
      content = SecurityUtils.convertYouTubeToIframe(content);
      content = SecurityUtils.sanitizeHtml(content);
      
      const draftData = {
        title: SecurityUtils.escapeHtml(title),
        content: content,
        category: document.getElementById('postCategory').value || '',
        subcategory: document.getElementById('postSubCategory').value || '',
        tags: document.getElementById('postTags').value || '',
        thumbnailUrl: document.getElementById('thumbnailUrl') ? document.getElementById('thumbnailUrl').value || '' : ''
      };
      
      // localStorageì— ì €ì¥ (ì‹¤ì œë¡œëŠ” ì„œë²„ì— ì €ì¥)
      localStorage.setItem('draft_post', JSON.stringify(draftData));
      alert('ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

  },

  setupPasteHandler() {
    this.contentElement.addEventListener('paste', (e) => {
      e.preventDefault();
      
      const clipboardData = e.clipboardData || window.clipboardData;
      const pastedText = clipboardData.getData('text/plain') || '';
      
      // ìœ íŠœë¸Œ ë§í¬ì¸ì§€ í™•ì¸
      const videoId = SecurityUtils.extractYouTubeVideoId(pastedText);
      
      if (videoId) {
        // ìœ íŠœë¸Œ ë§í¬ë¥¼ iframeìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì‚½ì…
        const iframeHtml = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="max-width: 100%;"></iframe>`;
        document.execCommand('insertHTML', false, iframeHtml);
      } else {
        // ì¼ë°˜ í…ìŠ¤íŠ¸ ë˜ëŠ” HTML ë¶™ì—¬ë„£ê¸°
        const html = clipboardData.getData('text/html');
        if (html && html.trim()) {
          // HTML ë‚´ì— ìœ íŠœë¸Œ ë§í¬ê°€ ìˆëŠ”ì§€ í™•ì¸
          const processedHtml = SecurityUtils.convertYouTubeToIframe(html);
          document.execCommand('insertHTML', false, processedHtml);
        } else if (pastedText) {
          // ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°
          document.execCommand('insertText', false, pastedText);
        }
      }
    });
  },

  setupEnterKeyHandler() {
    this.contentElement.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        
        // í˜„ì¬ ì„ íƒ ì˜ì—­
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        
        // br íƒœê·¸ 2ê°œ ì‚½ì… (ì¤„ë°”ê¿ˆ íš¨ê³¼)
        const br1 = document.createElement('br');
        const br2 = document.createElement('br');
        
        range.deleteContents();
        range.insertNode(br2);
        range.insertNode(br1);
        
        // ì»¤ì„œë¥¼ br ë‹¤ìŒìœ¼ë¡œ ì´ë™
        range.setStartAfter(br2);
        range.setEndAfter(br2);
        selection.removeAllRanges();
        selection.addRange(range);
      }
    });
  },

  setupImageUpload() {
    const imageUploadBtn = document.getElementById('imageUploadBtn');
    const imageUploadInput = document.getElementById('imageUploadInput');
    
    if (!imageUploadBtn || !imageUploadInput) return;
    
    // ì´ë¯¸ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì ì—´ê¸°
    imageUploadBtn.addEventListener('click', (e) => {
      e.preventDefault();
      imageUploadInput.click();
    });
    
    // íŒŒì¼ ì„ íƒ ì‹œ ì—…ë¡œë“œ ì²˜ë¦¬
    imageUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // íŒŒì¼ íƒ€ì… ê²€ì¦
      if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB ì œí•œ)
      if (file.size > 5 * 1024 * 1024) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      try {
        const result = await uploadImageFile(file);
        
        // ì´ë¯¸ì§€ë¥¼ ì—ë””í„°ì— ì‚½ì…
        const imgHtml = `<img src="${result.url}" alt="${file.name}" style="max-width: 100%; height: auto; margin: 1em 0;">`;
        document.execCommand('insertHTML', false, imgHtml);
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        alert(error.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      
      // input ì´ˆê¸°í™”
      imageUploadInput.value = '';
    });
  },

  showPreview(previewModal) {
    const title = this.titleElement.value.trim() || '(ì œëª© ì—†ìŒ)';
    let content = this.contentElement.innerHTML;
    let sanitizedContent = '';
    
    if (content.trim() === '' || content === this.contentElement.dataset.placeholder) {
      sanitizedContent = '';
    } else {
      content = SecurityUtils.convertYouTubeToIframe(content);
      sanitizedContent = SecurityUtils.sanitizeHtml(content);
    }

    // ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (IDê°€ ì•„ë‹Œ ì´ë¦„)
    const categorySelect = document.getElementById('postCategory');
    const subCategorySelect = document.getElementById('postSubCategory');
    
    const categoryText = categorySelect.selectedIndex > 0 
      ? categorySelect.options[categorySelect.selectedIndex].text 
      : 'ë¯¸ì„ íƒ';
      
    const subCategoryText = subCategorySelect.selectedIndex > 0 
      ? ' > ' + subCategorySelect.options[subCategorySelect.selectedIndex].text 
      : '';
      
    const category = categoryText + subCategoryText;
    
    const tags = document.getElementById('postTags').value 
      ? document.getElementById('postTags').value.split(',').map(t => SecurityUtils.escapeHtml(t)).join(', ')
      : 'ì—†ìŒ';
    
    const thumbnailUrlInput = document.getElementById('thumbnailUrl');
    const thumbnailUrl = thumbnailUrlInput ? thumbnailUrlInput.value.trim() : '';
    const previewThumbnailEl = document.getElementById('previewThumbnail');

    if (previewThumbnailEl) {
      if (categorySelect.value === '1' && thumbnailUrl) {
        previewThumbnailEl.src = thumbnailUrl;
        previewThumbnailEl.style.display = 'block';
      } else {
        previewThumbnailEl.src = '';
        previewThumbnailEl.style.display = 'none';
      }
    }
    
    document.getElementById('previewTitle').textContent = SecurityUtils.escapeHtml(title);
    document.getElementById('previewContent').innerHTML = sanitizedContent || '<p class="text-muted">(ë‚´ìš© ì—†ìŒ)</p>';
    document.getElementById('previewCategory').textContent = category;
    document.getElementById('previewTags').textContent = tags;
    
    previewModal.show();
  },
  
  async executePublish(previewModal) {
    // ì œëª© ê²€ì¦
    const title = this.titleElement.value.trim();
    if (!SecurityUtils.validateInput(title, 200)) {
      alert('ì œëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœëŒ€ 200ì)');
      return;
    }
    
    // ë³¸ë¬¸ ê²€ì¦
    let content = this.contentElement.innerHTML;
    if (content.trim() === '' || content === this.contentElement.dataset.placeholder) {
      alert('ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // ìœ íŠœë¸Œ ë§í¬ë¥¼ iframeìœ¼ë¡œ ë³€í™˜ (ì•„ì§ ë³€í™˜ë˜ì§€ ì•Šì€ ê²½ìš°)
    content = SecurityUtils.convertYouTubeToIframe(content);
    
    // HTML ì •í™” (XSS ë°©ì–´)
    content = SecurityUtils.sanitizeHtml(content);
    
    // ì •í™”ëœ ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    const textContent = this.contentElement.textContent.trim();
    if (!textContent || textContent === this.contentElement.dataset.placeholder) {
      alert('ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    this.contentInput.value = content;
    
    // ì¹´í…Œê³ ë¦¬ ê²€ì¦
    const boardId = document.getElementById('postCategory').value;
    if (!boardId) {
      alert('ê²Œì‹œíŒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
    
    // í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ê²€ì¦ (í•„ìˆ˜)
    const subcategory = document.getElementById('postSubCategory').value;
    if (!subcategory) {
      alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const thumbnailUrlField = document.getElementById('thumbnailUrl');
    const thumbnailUrlValue = thumbnailUrlField ? thumbnailUrlField.value.trim() : '';

    if (boardId === '1' && !thumbnailUrlValue) {
      alert('ë ˆì‹œí”¼ ê²Œì‹œíŒ ê²Œì‹œê¸€ì€ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
    
    // ìˆ˜ì • ëª¨ë“œ í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('postId');
    const postType = urlParams.get('postType');
    const isEditMode = postId && postType;
    
    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const user = getStoredUser();
    if (!user || !user.userId) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
      window.location.href = '/login.html';
      return;
    }
    
    const authorName = user.nickname || user.email?.split('@')[0] || 'ìµëª…';
    const userId = user.userId;
    
    // í¼ ë°ì´í„° ì¤€ë¹„
    const postData = {
      title: title,
      content: content,
      subcategory: subcategory,
      tags: document.getElementById('postTags').value || '',
      authorName: authorName,
      userId: userId,
      thumbnailUrl: boardId === '1' ? thumbnailUrlValue : ''
    };
    
    // ê²Œì‹œíŒ IDì— ë”°ë¼ API ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
    const apiEndpoint = boardId === '1' ? '/api/recipes' : '/api/tips';
    
    try {
      let response;
      if (isEditMode) {
        // ìˆ˜ì • ëª¨ë“œ: PUT ìš”ì²­
        response = await fetch(`${apiEndpoint}/${postId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        });
      } else {
        // ìƒˆ ê²Œì‹œê¸€: POST ìš”ì²­
        response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        });
      }
      
      const result = await response.json();
      
      if (result.success) {
        // ë°œí–‰ ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì • (í˜ì´ì§€ ì´íƒˆ ê²½ê³  ë¹„í™œì„±í™”)
        isPublished = true;
        
        alert(isEditMode ? 'ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ê²Œì‹œê¸€ì´ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
        
        // ì„ì‹œ ì €ì¥ ë°ì´í„° ì‚­ì œ
        localStorage.removeItem('postDraft');
        
        // ëª¨ë‹¬ ë‹«ê¸° (ìˆëŠ” ê²½ìš°)
        if (typeof previewModal !== 'undefined' && previewModal) {
    previewModal.hide();
        }
        
        if (isEditMode) {
          // ìˆ˜ì • ëª¨ë“œ: ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ (postTypeì´ ì´ë¯¸ MENU_ID)
          window.location.href = `/post-detail.html?type=${postType}&id=${postId}`;
        } else {
          // ìƒˆ ê²Œì‹œê¸€: í•´ë‹¹ ê²Œì‹œíŒ/ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
          const params = new URLSearchParams();
          params.set('board', boardId);
          params.set('category', subcategory);
          
          window.location.href = `/board.html?${params.toString()}`;
        }
      } else {
        alert(isEditMode ? 'ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message : 'ê²Œì‹œê¸€ ë°œí–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message);
      }
    } catch (error) {
      console.error('ê²Œì‹œê¸€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      alert(isEditMode ? 'ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' : 'ê²Œì‹œê¸€ ë°œí–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  },
  
  setupPreview() {
    // ì´ì „ ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ê´€ë ¨ ì½”ë“œ ì œê±°
    // ë°œí–‰ ë²„íŠ¼ê³¼ ëª¨ë‹¬ ë°œí–‰ ë²„íŠ¼ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ë³€ê²½ë¨
  }
};

// ë¡œê·¸ì¸ ì²´í¬ í•¨ìˆ˜
function getStoredUser() {
  try {
    const raw = localStorage.getItem('sandwichUser');
    return raw ? JSON.parse(raw) : null;
  } catch (error) {
    console.warn('ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error);
    return null;
  }
}

function checkLogin() {
  const user = getStoredUser();
  if (!user || !user.userId) {
    alert('ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    window.location.href = '/login.html';
    return false;
  }
  
  // ì°¨ë‹¨ëœ ì‚¬ìš©ì í™•ì¸
  if (user.blocked === true) {
    alert('ì°¨ë‹¨ëœ ì‚¬ìš©ìëŠ” ê²Œì‹œê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    window.location.href = '/home.html';
    return false;
  }
  
  return true;
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
  // ë¡œê·¸ì¸ ì²´í¬
  if (!checkLogin()) {
    return;
  }
  
  EditorManager.init();
  
  // Footer ë¡œë“œ
  fetch('/footer.html')
    .then(res => res.text())
    .then(html => { 
      const footer = document.getElementById('site-footer');
      if (footer) {
        footer.innerHTML = DOMPurify.sanitize(html);
      }
    })
    .catch(err => console.error('Footer ë¡œë“œ ì‹¤íŒ¨:', err));
  
  // ë©”ë‰´ ë°ì´í„° ì €ì¥ ë³€ìˆ˜
  let menuData = {
    boards: [],
    categories: []
  };
  
  const categorySelect = document.getElementById('postCategory');
  const subCategorySelect = document.getElementById('postSubCategory');
  const thumbnailSection = document.getElementById('thumbnailSection');
  const thumbnailCard = document.getElementById('thumbnailCard');
  const thumbnailImage = document.getElementById('thumbnailImage');
  const thumbnailPlaceholder = document.getElementById('thumbnailPlaceholder');
  const thumbnailUploadBtn = document.getElementById('thumbnailUploadBtn');
  const thumbnailUploadInput = document.getElementById('thumbnailUploadInput');
  const thumbnailRemoveBtn = document.getElementById('thumbnailRemoveBtn');
  const thumbnailUrlInput = document.getElementById('thumbnailUrl');
  const previewThumbnail = document.getElementById('previewThumbnail');

  function updateThumbnailVisibility(boardId) {
    if (!thumbnailSection) return;

    if (boardId === '1') {
      thumbnailSection.style.display = 'block';
    } else {
      thumbnailSection.style.display = 'none';
      clearThumbnailSelection();
    }
  }

  function setThumbnailSelection(url, originalName = '') {
    if (!thumbnailCard || !thumbnailImage || !thumbnailPlaceholder || !thumbnailRemoveBtn || !thumbnailUrlInput) {
      return;
    }

    thumbnailUrlInput.value = url;
    thumbnailImage.src = url;
    thumbnailImage.alt = originalName || 'ëŒ€í‘œ ì´ë¯¸ì§€';
    thumbnailImage.style.display = 'block';
    thumbnailPlaceholder.style.display = 'none';
    thumbnailCard.classList.add('has-image');
    thumbnailRemoveBtn.style.display = 'inline-block';

    if (previewThumbnail) {
      previewThumbnail.src = url;
      previewThumbnail.style.display = 'block';
    }
  }

  function clearThumbnailSelection() {
    if (!thumbnailCard || !thumbnailImage || !thumbnailPlaceholder || !thumbnailRemoveBtn || !thumbnailUrlInput) {
      return;
    }

    thumbnailUrlInput.value = '';
    thumbnailImage.src = '';
    thumbnailImage.style.display = 'none';
    thumbnailPlaceholder.style.display = 'block';
    thumbnailCard.classList.remove('has-image');
    thumbnailRemoveBtn.style.display = 'none';

    if (previewThumbnail) {
      previewThumbnail.src = '';
      previewThumbnail.style.display = 'none';
    }
  }

  if (thumbnailUploadBtn && thumbnailUploadInput) {
    thumbnailUploadBtn.addEventListener('click', (e) => {
      e.preventDefault();
      thumbnailUploadInput.click();
    });

    thumbnailUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        thumbnailUploadInput.value = '';
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        thumbnailUploadInput.value = '';
        return;
      }

      try {
        const result = await uploadImageFile(file);
        setThumbnailSelection(result.url, result.originalName || file.name);
      } catch (error) {
        console.error('ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        alert(error.message || 'ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        thumbnailUploadInput.value = '';
      }
    });
  }

  if (thumbnailRemoveBtn) {
    thumbnailRemoveBtn.addEventListener('click', (e) => {
      e.preventDefault();
      clearThumbnailSelection();
    });
  }
  
  // APIì—ì„œ ë©”ë‰´ ë°ì´í„° ë¡œë“œ
  async function loadMenus() {
    try {
      const response = await fetch('/api/menus');
      const result = await response.json();
      
      if (result.success) {
        menuData = result.data;
        
        // ê²Œì‹œíŒ(ëŒ€ë©”ë‰´) ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        categorySelect.innerHTML = '<option value="">ê²Œì‹œíŒ ì„ íƒ</option>';
        menuData.boards.forEach(board => {
          const option = document.createElement('option');
          option.value = board.MENU_ID;
          option.textContent = board.MENU_NAME;
          categorySelect.appendChild(option);
        });
        
        console.log('ë©”ë‰´ ë¡œë“œ ì™„ë£Œ:', menuData);
        updateThumbnailVisibility(categorySelect.value || '');
        return true;
      } else {
        console.error('ë©”ë‰´ ë¡œë“œ ì‹¤íŒ¨:', result.message);
        alert('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return false;
      }
    } catch (error) {
      console.error('ë©”ë‰´ ë¡œë“œ ì˜¤ë¥˜:', error);
      alert('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return false;
    }
  }
  
  // ëŒ€ë©”ë‰´ ì„ íƒ ì‹œ ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸
  categorySelect.addEventListener('change', function() {
    const selectedBoardId = this.value;
    
    // ì†Œë©”ë‰´ ì´ˆê¸°í™”
    subCategorySelect.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>';
    
    if (selectedBoardId) {
      // ì„ íƒëœ ê²Œì‹œíŒì— ì†í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë§Œ í•„í„°ë§
      const relatedCategories = menuData.categories.filter(
        cat => cat.MENU_TOP === parseInt(selectedBoardId)
      );
      
      if (relatedCategories.length > 0) {
        relatedCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.MENU_ID;
          option.textContent = category.MENU_NAME;
          subCategorySelect.appendChild(option);
        });
        subCategorySelect.disabled = false;
      } else {
        subCategorySelect.disabled = true;
      }
    } else {
      subCategorySelect.disabled = true;
    }

    updateThumbnailVisibility(selectedBoardId);
  });
  
  // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²Œì‹œíŒê³¼ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì½ê¸°
  function getUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
      board: urlParams.get('board'),
      category: urlParams.get('category'),
      postId: urlParams.get('postId'),
      postType: urlParams.get('postType')
    };
  }
  
  // URL íŒŒë¼ë¯¸í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ì„¤ì •
  function setDropdownsFromUrl() {
    const params = getUrlParams();
    
    if (!params.board) return; // URL íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì„¤ì •í•˜ì§€ ì•ŠìŒ
    
    // ê²Œì‹œíŒ ë“œë¡­ë‹¤ìš´ ì„¤ì •
    categorySelect.value = params.board;
    updateThumbnailVisibility(params.board);
    
    // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°í•˜ì—¬ ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸
    categorySelect.dispatchEvent(new Event('change'));
    
    // ì¹´í…Œê³ ë¦¬ ì„¤ì • (ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸ í›„)
    if (params.category) {
      setTimeout(() => {
        subCategorySelect.value = params.category;
      }, 200); // ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸ ëŒ€ê¸°
    }
  }
  
  // ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë“œ: URL íŒŒë¼ë¯¸í„°ì—ì„œ postIdì™€ postType(MENU_ID) í™•ì¸
  const urlParams = getUrlParams();
  const postId = urlParams.postId;
  const postType = urlParams.postType; // '1' (ë ˆì‹œí”¼) or '2' (ì •ë³´ ê³µìœ ) - MENU_TBì˜ MENU_ID
  let isEditMode = false;
  let editPostId = null;
  let editPostType = null;
  
  console.log('ğŸ” ìˆ˜ì • ëª¨ë“œ í™•ì¸:', { postId, postType, urlParams });
  
  // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ê²Œì‹œê¸€ ë°ì´í„° ë¡œë“œ
  async function loadPostForEdit(postId, postType) {
    console.log('ğŸ” ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë“œ - ë¡œë“œ ì‹œì‘:', { postId, postType });
    
    try {
      // MENU_ID 1 = ë ˆì‹œí”¼ ê²Œì‹œíŒ, MENU_ID 2 = ì •ë³´ ê³µìœ  ê²Œì‹œíŒ
      const apiUrl = postType === '1' 
        ? `/api/recipes/${postId}`
        : `/api/tips/${postId}`;
      
      console.log('ğŸ” API í˜¸ì¶œ:', apiUrl);
      const response = await fetch(apiUrl);
      const result = await response.json();
      
      console.log('ğŸ” API ì‘ë‹µ:', result);
      
      if (!result.success) {
        alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + result.message);
        return false;
      }
      
      const data = result.data;
      console.log('ğŸ” ê²Œì‹œê¸€ ë°ì´í„°:', data);
      
      // ì œëª© ì„¤ì •
      EditorManager.titleElement.value = data.TITLE || '';
      // ì œëª© ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
      const titleCount = document.getElementById('titleCharCount');
      if (titleCount) {
        titleCount.textContent = (data.TITLE || '').length;
      }
      
      // ë³¸ë¬¸ ì„¤ì •
      EditorManager.contentElement.innerHTML = data.CONTENT || '';
      console.log('ğŸ” ë³¸ë¬¸ ì„¤ì • ì™„ë£Œ:', data.CONTENT ? 'ìˆìŒ' : 'ì—†ìŒ');
      
      if (postType === '1') {
        updateThumbnailVisibility('1');
        if (data.IMAGE_URL) {
          setThumbnailSelection(data.IMAGE_URL, data.IMAGE_URL);
        } else {
          clearThumbnailSelection();
        }
      } else {
        updateThumbnailVisibility(postType);
        clearThumbnailSelection();
      }
      
      // ì¹´í…Œê³ ë¦¬ ì„¤ì • (ë©”ë‰´ ë¡œë“œ í›„)
      if (data.CATEGORY) {
        console.log('ğŸ” ì¹´í…Œê³ ë¦¬ ì„¤ì •:', data.CATEGORY);
        setTimeout(() => {
          // ê²Œì‹œíŒ ì„ íƒ (postTypeì´ ì´ë¯¸ MENU_ID)
          const boardId = postType; // '1' ë˜ëŠ” '2'
          categorySelect.value = boardId;
          categorySelect.dispatchEvent(new Event('change'));
          
          // ì¹´í…Œê³ ë¦¬ ì„ íƒ
          setTimeout(() => {
            subCategorySelect.value = data.CATEGORY;
            console.log('ğŸ” ì¹´í…Œê³ ë¦¬ ì„ íƒ ì™„ë£Œ:', data.CATEGORY);
          }, 200);
        }, 300);
      }
      
      // íƒœê·¸ ì„¤ì •
      if (data.TAGS) {
        const tags = data.TAGS.split(',').map(tag => tag.trim()).filter(tag => tag);
        tags.forEach(tag => {
          const tagInput = document.getElementById('tagInput');
          tagInput.value = tag;
          tagInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        });
        console.log('ğŸ” íƒœê·¸ ì„¤ì • ì™„ë£Œ:', tags);
      }
      
      // í˜ì´ì§€ ì œëª© ë³€ê²½
      document.title = 'ê²Œì‹œê¸€ ìˆ˜ì • - ìƒŒëƒ ';
      
      // ë°œí–‰ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
      const publishBtn = document.getElementById('publishBtn');
      if (publishBtn) {
        publishBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
      }
      
      console.log('âœ… ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë“œ ë¡œë“œ ì™„ë£Œ');
      return true;
    } catch (error) {
      console.error('ê²Œì‹œê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
      alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return false;
    }
  }
  
  // ë©”ë‰´ ë¡œë“œ ì‹¤í–‰
  loadMenus().then(async () => {
    console.log('ğŸ” ë©”ë‰´ ë¡œë“œ ì™„ë£Œ, ìˆ˜ì • ëª¨ë“œ í™•ì¸:', { postId, postType });
    // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ê²Œì‹œê¸€ ë°ì´í„° ë¡œë“œ
    if (postId && postType) {
      console.log('âœ… ìˆ˜ì • ëª¨ë“œ í™œì„±í™”');
      isEditMode = true;
      editPostId = postId;
      editPostType = postType;
      await loadPostForEdit(postId, postType);
    } else if (urlParams.board) {
      // URL íŒŒë¼ë¯¸í„°ë¡œ ë“œë¡­ë‹¤ìš´ ì„¤ì •
      setDropdownsFromUrl();
    } else {
      // ì„ì‹œ ì €ì¥ ë°ì´í„° ë³µì› (URL íŒŒë¼ë¯¸í„°ê°€ ì—†ì„ ë•Œë§Œ)
  const savedDraft = localStorage.getItem('draft_post');
  if (savedDraft) {
    try {
      const draft = JSON.parse(savedDraft);
      if (confirm('ì„ì‹œ ì €ì¥ëœ ê²Œì‹œê¸€ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        EditorManager.titleElement.value = draft.title || '';
        EditorManager.contentElement.innerHTML = draft.content || '';
        if (draft.category) {
              // ë©”ë‰´ ë¡œë“œ ì™„ë£Œ í›„ ë³µì›
              setTimeout(() => {
          document.getElementById('postCategory').value = draft.category;
                updateThumbnailVisibility(draft.category);
                // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°í•˜ì—¬ ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸
                categorySelect.dispatchEvent(new Event('change'));
                
                // ì†Œë©”ë‰´ë„ ë³µì›
                if (draft.subcategory) {
                  setTimeout(() => {
                    document.getElementById('postSubCategory').value = draft.subcategory;
                  }, 100);
                }

                if (draft.category === '1' && draft.thumbnailUrl) {
                  setThumbnailSelection(draft.thumbnailUrl, draft.thumbnailUrl);
                } else {
                  clearThumbnailSelection();
                }
              }, 300);
        }
        if (draft.tags) {
          const tags = draft.tags.split(',');
          tags.forEach(tag => {
            document.getElementById('tagInput').value = tag;
            document.getElementById('tagInput').dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
          });
        }
      }
    } catch (e) {
      console.error('ì„ì‹œ ì €ì¥ ë°ì´í„° ë³µì› ì‹¤íŒ¨:', e);
        }
    }
  }
  });
});

// í˜ì´ì§€ ì´íƒˆ ê²½ê³  í”Œë˜ê·¸
let isPublished = false;

// í˜ì´ì§€ ì´íƒˆ ê²½ê³ 
window.addEventListener('beforeunload', (e) => {
  // ë°œí–‰ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ê²½ê³ í•˜ì§€ ì•ŠìŒ
  if (isPublished) {
    return;
  }
  
  const title = EditorManager.titleElement.value.trim();
  const content = EditorManager.contentElement.textContent.trim();
  
  if (title || (content && content !== EditorManager.contentElement.dataset.placeholder)) {
    e.preventDefault();
    e.returnValue = '';
  }
});
</script>
</body>
</html>
