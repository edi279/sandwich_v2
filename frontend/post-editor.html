<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.youtube.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; frame-src 'self' https://www.youtube.com; connect-src 'self' https://cdn.jsdelivr.net;">
<title>ê²Œì‹œê¸€ ì‘ì„± - ìƒŒëƒ </title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="/assets/css/variables.css">
<link rel="stylesheet" href="/assets/css/base.css">
<link rel="stylesheet" href="/assets/css/components.css">
<link rel="stylesheet" href="/assets/css/pages.css">
<style>
.tag-input { border-radius: 0.375rem; }
.tag-badge { margin: 0.25rem; cursor: pointer; }
/* navbar ê´€ë ¨ ìŠ¤íƒ€ì¼ì€ components.cssì˜ .navbar-simpleì—ì„œ í†µí•© ê´€ë¦¬ */

/* ë°œí–‰ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë¶„í™ìƒ‰ ê³„ì—´) */
#publishBtn,
#publishFromModalBtn {
  background-color: var(--primary-pink) !important;
  border-color: var(--primary-pink) !important;
  color: white !important;
}
#publishBtn:hover,
#publishFromModalBtn:hover {
  background-color: var(--primary-pink-hover) !important;
  border-color: var(--primary-pink-hover) !important;
}
#publishBtn:focus,
#publishFromModalBtn:focus {
  background-color: var(--primary-pink-hover) !important;
  border-color: var(--primary-pink-hover) !important;
  box-shadow: 0 0 0 0.25rem rgba(255, 107, 157, 0.25) !important;
}

/* ì œëª© ì…ë ¥ í•„ë“œ í°íŠ¸ í¬ê¸° ì¡°ì • */
#postTitle {
  font-size: 1rem; /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ë³€ê²½ (ì˜ˆ: 1rem, 0.95rem ë“±) */
}

/* íƒœê·¸ ì…ë ¥ í•„ë“œ í°íŠ¸ í¬ê¸° ì¡°ì • */
.tag-input {
  font-size: 0.9rem; /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ë³€ê²½ (ì˜ˆ: 0.9rem, 0.85rem ë“±) */
}

/* form-label í°íŠ¸ í¬ê¸° ì¡°ì • */
.form-label {
  font-size: 0.9rem; /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ë³€ê²½ (ì˜ˆ: 0.95rem, 0.9rem, 0.85rem ë“±) */
}

/* navbar-brand ìƒ‰ìƒì€ components.cssì˜ .navbar-simpleì—ì„œ í†µí•© ê´€ë¦¬ */

/* Tiptap ì—ë””í„° ìŠ¤íƒ€ì¼ */
.ProseMirror {
  outline: none;
  min-height: 400px;
  padding: 1rem;
  font-size: 14px;
  line-height: 1.6;
}
.ProseMirror p.is-editor-empty:first-child::before {
  content: attr(data-placeholder);
  float: left;
  color: #adb5bd;
  pointer-events: none;
  height: 0;
}
.ProseMirror h1 { font-size: 32px; font-weight: 600; line-height: 1.2; margin: 0.65em 0 0.4em 0; }
.ProseMirror h2 { font-size: 24px; font-weight: 600; line-height: 1.2; margin: 0.6em 0 0.4em 0; }
.ProseMirror h3 { font-size: 18px; font-weight: 600; line-height: 1.2; margin: 0.55em 0 0.4em 0; }
.ProseMirror p { font-size: 14px; margin: 0.35em 0; }
.ProseMirror img { max-width: 100%; height: auto; margin: 1em 0; border-radius: 0.375rem; cursor: pointer; }
.ProseMirror img.resizing { cursor: nwse-resize; }
.ProseMirror iframe { max-width: 100%; margin: 1em 0; border-radius: 0.375rem; }

/* ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ì»¨íŠ¸ë¡¤ - ì˜¤ë²„ë ˆì´ ë°©ì‹ */
.ProseMirror img.image-selected {
  outline: 3px solid #0d6efd;
  outline-offset: 2px;
}

#image-resize-overlay {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  display: none;
}

#image-resize-overlay.active {
  display: block;
}

#image-resize-overlay .resize-handle {
  position: absolute;
  width: 14px;
  height: 14px;
  background-color: #0d6efd;
  border: 2px solid white;
  border-radius: 50%;
  cursor: nwse-resize;
  pointer-events: auto;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  transition: transform 0.1s;
}

#image-resize-overlay .resize-handle:hover {
  background-color: #0b5ed7;
  transform: scale(1.3);
}

#image-resize-overlay .resize-handle.top-left { top: -7px; left: -7px; cursor: nwse-resize; }
#image-resize-overlay .resize-handle.top-right { top: -7px; right: -7px; cursor: nesw-resize; }
#image-resize-overlay .resize-handle.bottom-left { bottom: -7px; left: -7px; cursor: nesw-resize; }
#image-resize-overlay .resize-handle.bottom-right { bottom: -7px; right: -7px; cursor: nwse-resize; }

#image-resize-overlay .resize-info {
  position: absolute;
  top: -32px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
  white-space: nowrap;
  pointer-events: none;
}

/* ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ íˆ´ë°” */
#image-resize-toolbar {
  position: fixed;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 10px 14px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 10000;
  display: none;
  gap: 10px;
  align-items: center;
}

#image-resize-toolbar.active {
  display: flex;
}

#image-resize-toolbar .size-input-group {
  display: flex;
  align-items: center;
  gap: 4px;
}

#image-resize-toolbar .size-input-group label {
  font-size: 12px;
  color: #6c757d;
  margin: 0;
  min-width: 24px;
}

#image-resize-toolbar .size-input {
  width: 65px;
  padding: 4px 6px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  font-size: 12px;
  text-align: center;
  outline: none;
  transition: border-color 0.15s;
}

#image-resize-toolbar .size-input:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.15);
}

#image-resize-toolbar .link-icon {
  color: #0d6efd;
  font-size: 14px;
  margin: 0 2px;
}

#image-resize-toolbar .separator {
  width: 1px;
  height: 24px;
  background-color: #dee2e6;
  margin: 0 4px;
}

#image-resize-toolbar button {
  padding: 5px 10px;
  border: 1px solid #dee2e6;
  background: #f8f9fa;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.15s;
  white-space: nowrap;
}

#image-resize-toolbar button:hover {
  background: #e9ecef;
  border-color: #adb5bd;
}

#image-resize-toolbar button.reset-btn {
  background: #fff3cd;
  border-color: #ffc107;
  color: #856404;
}

#image-resize-toolbar button.reset-btn:hover {
  background: #ffe69c;
}
</style>
</head>
<body>

<!-- ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ì˜¤ë²„ë ˆì´ -->
<div id="image-resize-overlay">
  <div class="resize-handle top-left" data-direction="nw"></div>
  <div class="resize-handle top-right" data-direction="ne"></div>
  <div class="resize-handle bottom-left" data-direction="sw"></div>
  <div class="resize-handle bottom-right" data-direction="se"></div>
  <div class="resize-info"></div>
</div>

<!-- ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ íˆ´ë°” -->
<div id="image-resize-toolbar">
  <div class="size-input-group">
    <label for="resize-width">ê°€ë¡œ</label>
    <input type="number" id="resize-width" class="size-input" min="10" max="5000" placeholder="ê°€ë¡œ">
    <span style="font-size: 11px; color: #6c757d;">px</span>
  </div>
  <span class="link-icon" title="ë¹„ìœ¨ ê³ ì •">ğŸ”—</span>
  <div class="size-input-group">
    <label for="resize-height">ì„¸ë¡œ</label>
    <input type="number" id="resize-height" class="size-input" min="10" max="5000" placeholder="ì„¸ë¡œ">
    <span style="font-size: 11px; color: #6c757d;">px</span>
  </div>
  <div class="separator"></div>
  <button type="button" class="reset-btn" id="reset-size-btn">ì´ˆê¸°í™”</button>
</div>

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top navbar-simple">
  <div class="container-fluid px-3 position-relative d-flex align-items-center navbar-container">
    <button type="button" class="btn btn-link text-decoration-none p-0 me-3 d-flex align-items-center" id="backButton">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
      </svg>
    </button>
    <a class="navbar-brand fw-bold position-absolute start-50 translate-middle-x d-flex align-items-center" href="/home.html" style="z-index: 1; height: 100%; padding-top: 5px; padding-bottom: 5px;">
      <img src="/uploads/icon_logo/logo_veg.svg" class="navbar-logo" alt="ìƒŒëƒ  ë¡œê³ " title="ìƒŒëƒ  sannyam">
    </a>
    <div style="width: 40px; visibility: hidden;"></div> <!-- ì˜¤ë¥¸ìª½ ê· í˜•ì„ ìœ„í•œ ê³µê°„ -->
  </div>
</nav>

<main class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="editor-container">
        <form id="postForm">
          <!-- ìƒë‹¨ ë°”: ì¹´í…Œê³ ë¦¬ì™€ ë²„íŠ¼ -->
          <div class="editor-top-bar">
            <div class="editor-top-bar-left">
              <select class="form-select" id="postCategory" name="category" style="width: auto; min-width: 200px;">
                <option value="">ê²Œì‹œíŒ ì„ íƒ</option>
                <!-- ë©”ë‰´ëŠ” ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
              </select>
              <select class="form-select" id="postSubCategory" name="subcategory" style="width: auto; min-width: 200px; margin-left: 0px;" disabled>
                <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
              </select>
            </div>
            <div class="editor-top-bar-right">
              <button type="button" class="btn btn-outline-secondary" id="saveBtn">
                ì„ì‹œ ì €ì¥
              </button>
              <button type="submit" class="btn btn-primary" id="publishBtn">
                ë°œí–‰
              </button>
            </div>
          </div>

          <!-- ì œëª© ì…ë ¥ -->
          <div class="title-input-wrapper">
            <input type="text" class="form-control form-control-lg" id="postTitle" name="title" 
                   placeholder="ê²Œì‹œê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required 
                   maxlength="200" autocomplete="off">
            <span class="title-char-count">
              <span id="titleCharCount">0</span>/200
            </span>
          </div>

          <!-- ë³¸ë¬¸ ì—ë””í„° -->
          <div class="editor-content-wrapper">
            <div class="editor-toolbar" id="editorToolbar" role="toolbar">
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" id="fontSizeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    ë³¸ë¬¸
                </button>
                <ul class="dropdown-menu" aria-labelledby="fontSizeDropdown">
                    <li><a class="dropdown-item" href="#" data-format="h1">H1</a></li>
                    <li><a class="dropdown-item" href="#" data-format="h2">H2</a></li>
                    <li><a class="dropdown-item" href="#" data-format="h3">H3</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" data-format="p">ë³¸ë¬¸</a></li>
                </ul>
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="bold" title="êµµê²Œ">
                <strong>B</strong>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="italic" title="ê¸°ìš¸ì„">
                <em>I</em>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="underline" title="ë°‘ì¤„">
                <u>U</u>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="insertUnorderedList" title="ê¸€ë¨¸ë¦¬ ê¸°í˜¸">
                â€¢ ëª©ë¡
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="insertOrderedList" title="ë²ˆí˜¸ ë§¤ê¸°ê¸°">
                1. ëª©ë¡
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-command="createLink" title="ë§í¬">
                ğŸ”—
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="imageUploadBtn" title="ì´ë¯¸ì§€">
                ğŸ–¼ï¸
              </button>
              <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
              <div style="flex-grow: 1;"></div>
            </div>
            <div class="editor-content" id="editorContent"></div>
            <input type="hidden" id="postContent" name="content" required>
          </div>

          <!-- ëŒ€í‘œ ì´ë¯¸ì§€ ì„¤ì • (ë ˆì‹œí”¼ ê²Œì‹œíŒ ì „ìš©) -->
          <div class="thumbnail-section" id="thumbnailSection">
            <div class="mb-2">
              <label class="form-label mb-0 fw-semibold">ëŒ€í‘œ ì´ë¯¸ì§€</label>
            </div>
            <div class="thumbnail-card" id="thumbnailCard">
              <img src="" alt="ëŒ€í‘œ ì´ë¯¸ì§€" id="thumbnailImage" style="display:none;">
              <div class="thumbnail-placeholder" id="thumbnailPlaceholder">
                ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
              </div>
              <div class="thumbnail-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="thumbnailUploadBtn">
                  ì—…ë¡œë“œ
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="thumbnailRemoveBtn" style="display:none;">
                  ì œê±°
                </button>
              </div>
            </div>
            <input type="hidden" id="thumbnailUrl" name="thumbnailUrl">
            <input type="file" id="thumbnailUploadInput" accept="image/*" style="display:none;">
          </div>

          <!-- íƒœê·¸ ì…ë ¥ -->
          <div class="tag-section">
            <label class="form-label mb-0 fw-semibold">íƒœê·¸</label>
            <input type="hidden" id="postTags" name="tags">
            <input type="text" class="form-control tag-input mt-2" id="tagInput" 
                   placeholder="ì…ë ¥ í›„ Enter í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”. ìµœëŒ€ 10ê°œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." 
                   autocomplete="off" maxlength="50">
          </div>
        </form>
      </div>
      <div id="site-footer"></div>

      <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
      <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">ë¯¸ë¦¬ë³´ê¸°</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <h3 id="previewTitle" class="mb-3"></h3>
              <img id="previewThumbnail" src="" alt="ëŒ€í‘œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" class="img-fluid rounded mb-3" style="display:none;">
              <div id="previewContent" class="border-top pt-3"></div>
              <div class="mt-3">
                <small class="text-muted">
                  ì¹´í…Œê³ ë¦¬: <span id="previewCategory"></span> | 
                  íƒœê·¸: <span id="previewTags"></span>
                </small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" id="publishFromModalBtn">ë°œí–‰</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
// Tiptap ë²ˆë“¤ ë¡œë“œ í™•ì¸ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
window.TiptapEditorLoaded = false;
window.TiptapEditorError = null;
</script>
<script src="/js/tiptap-editor.bundle.js" 
        onload="window.TiptapEditorLoaded = true; console.log('âœ… Tiptap ë²ˆë“¤ ë¡œë“œ ì™„ë£Œ'); console.log('TiptapEditor íƒ€ì…:', typeof TiptapEditor); console.log('TiptapEditor ê°ì²´:', TiptapEditor); console.log('initTiptapEditor í•¨ìˆ˜:', typeof TiptapEditor?.initTiptapEditor);" 
        onerror="window.TiptapEditorError = 'ë²ˆë“¤ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨'; console.error('âŒ Tiptap ë²ˆë“¤ ë¡œë“œ ì‹¤íŒ¨'); console.error('ì—ëŸ¬ ìƒì„¸:', event);"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script>
// XSS ë°©ì–´ë¥¼ ìœ„í•œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
const SecurityUtils = {
  // HTML ì´ìŠ¤ì¼€ì´í”„
  escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
  },

  // DOMPurifyë¥¼ ì‚¬ìš©í•˜ì—¬ HTML ì •í™”
  sanitizeHtml(dirty) {
    return DOMPurify.sanitize(dirty, {
      ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 
                     'blockquote', 'a', 'img', 'code', 'pre', 'iframe'],
      ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'width', 'height', 'frameborder', 'allow', 
                     'allowfullscreen', 'style'],
      ALLOW_DATA_ATTR: false
    });
  },
  
  // ìœ íŠœë¸Œ URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
  extractYouTubeVideoId(url) {
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
      /youtube\.com\/watch\?.*v=([^&\n?#]+)/
    ];
    
    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match && match[1]) {
        return match[1];
      }
    }
    return null;
  },
  
  // ìœ íŠœë¸Œ ë§í¬ë¥¼ iframeìœ¼ë¡œ ë³€í™˜
  convertYouTubeToIframe(html) {
    if (!html || typeof html !== 'string') return html;
    
    // ì´ë¯¸ iframeì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ë³€í™˜í•˜ì§€ ì•ŠìŒ
    if (html.includes('<iframe') && html.includes('youtube.com/embed')) {
      return html;
    }
    
    // ìœ íŠœë¸Œ URL íŒ¨í„´ ë§¤ì¹­ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
    const youtubePatterns = [
      /https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/gi,
      /https?:\/\/youtu\.be\/([a-zA-Z0-9_-]+)/gi,
      /https?:\/\/(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]+)/gi
    ];
    
    let result = html;
    
    youtubePatterns.forEach(pattern => {
      result = result.replace(pattern, (match, videoId) => {
        return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="max-width: 100%;"></iframe>`;
      });
    });
    
    // <a> íƒœê·¸ ë‚´ì˜ ìœ íŠœë¸Œ ë§í¬ë„ ì²˜ë¦¬
    result = result.replace(/<a[^>]*>(https?:\/\/(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]+))<\/a>/gi, (match, url, videoId) => {
      return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="max-width: 100%;"></iframe>`;
    });
    
    return result;
  },

  // ì…ë ¥ ê²€ì¦
  validateInput(text, maxLength = null) {
    if (typeof text !== 'string') return false;
    if (maxLength && text.length > maxLength) return false;
    return true;
  }
};

async function uploadImageFile(file) {
  const formData = new FormData();
  formData.append('image', file);
  
  const response = await fetch('/api/upload/image', {
    method: 'POST',
    body: formData
  });

  const result = await response.json();

  if (!response.ok || !result.success) {
    throw new Error(result.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }

  return result;
}

// Tiptap ì—ë””í„° ì¸ìŠ¤í„´ìŠ¤
let editor = null;

// ì—ë””í„° ê´€ë¦¬
const EditorManager = {
  contentElement: document.getElementById('editorContent'),
  titleElement: document.getElementById('postTitle'),
  contentInput: document.getElementById('postContent'),
  
  async init() {
    await this.initTiptapEditor();
    this.setupToolbar();
    this.setupWordCount();
    this.setupTagInput();
    this.setupFormSubmit();
    this.setupImageUpload();
    this.setupImageResizeControls();
    this.setupImageWrapperObserver();
  },
  
  async initTiptapEditor() {
    // TiptapEditorê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    let retries = 0;
    const maxRetries = 50; // 5ì´ˆ ëŒ€ê¸°
    
    while (typeof TiptapEditor === 'undefined' && retries < maxRetries) {
      await new Promise(resolve => setTimeout(resolve, 100));
      retries++;
    }
    
  if (typeof TiptapEditor === 'undefined') {
    console.error('âŒ Tiptap ì—ë””í„° ë²ˆë“¤ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    console.error('ë²ˆë“¤ íŒŒì¼ ê²½ë¡œ: /js/tiptap-editor.bundle.js');
    console.error('TiptapEditorLoaded:', window.TiptapEditorLoaded);
    console.error('TiptapEditorError:', window.TiptapEditorError);
    console.error('ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸:', document.querySelector('script[src="/js/tiptap-editor.bundle.js"]'));
    console.error('window ê°ì²´ì— TiptapEditorê°€ ìˆëŠ”ì§€:', 'TiptapEditor' in window);
    
    // ë²ˆë“¤ íŒŒì¼ ì§ì ‘ í…ŒìŠ¤íŠ¸
    fetch('/js/tiptap-editor.bundle.js')
      .then(res => {
        console.log('ë²ˆë“¤ íŒŒì¼ HTTP ìƒíƒœ:', res.status, res.statusText);
        if (res.ok) {
          return res.text();
        }
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      })
      .then(text => {
        console.log('ë²ˆë“¤ íŒŒì¼ í¬ê¸°:', text.length, 'bytes');
        console.log('ë²ˆë“¤ íŒŒì¼ ì²« 200ì:', text.substring(0, 200));
      })
      .catch(err => {
        console.error('ë²ˆë“¤ íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
      });
    
    alert('ì—ë””í„°ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }
    
    console.log('TiptapEditor í™•ì¸:', typeof TiptapEditor, TiptapEditor);
    console.log('TiptapEditor.initTiptapEditor:', typeof TiptapEditor?.initTiptapEditor);
    
    try {
      // Tiptap ì—ë””í„° ì´ˆê¸°í™”
      if (!TiptapEditor || !TiptapEditor.initTiptapEditor) {
        console.error('TiptapEditor ê°ì²´:', TiptapEditor);
        console.error('TiptapEditorì˜ í‚¤ë“¤:', TiptapEditor ? Object.keys(TiptapEditor) : 'undefined');
        throw new Error('TiptapEditor.initTiptapEditor í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      
      if (!this.contentElement) {
        throw new Error('ì—ë””í„° ì»¨í…Œì´ë„ˆ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      
      editor = TiptapEditor.initTiptapEditor(this.contentElement, {
        content: '',
        placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
        onUpdate: ({ editor }) => {
          // ì—ë””í„° ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ í˜¸ì¶œ
          const html = editor.getHTML();
          // XSS ë³´ì•ˆ ì²˜ë¦¬
          const sanitized = SecurityUtils.sanitizeHtml(html);
          this.contentInput.value = sanitized;
        },
      });
      
      if (!editor) {
        throw new Error('ì—ë””í„° ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }
      
      console.log('Tiptap ì—ë””í„° ì´ˆê¸°í™” ì™„ë£Œ', editor);
    } catch (error) {
      console.error('Tiptap ì—ë””í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      console.error('ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
      console.error('ì—ëŸ¬ ìƒì„¸:', {
        message: error.message,
        name: error.name,
        contentElement: this.contentElement,
        TiptapEditor: typeof TiptapEditor,
        initTiptapEditor: typeof TiptapEditor?.initTiptapEditor
      });
      alert('ì—ë””í„°ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  },

  setupToolbar() {
    if (!editor) {
      console.error('ì—ë””í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }
    
    const toolbar = document.getElementById('editorToolbar');
    const fontSizeDropdown = document.getElementById('fontSizeDropdown');
    
    // ë³¼ë“œ ë²„íŠ¼
    const boldBtn = toolbar.querySelector('button[data-command="bold"]');
    if (boldBtn) {
      boldBtn.addEventListener('click', () => {
        editor.chain().focus().toggleBold().run();
      });
    }
    
    // ì´íƒ¤ë¦­ ë²„íŠ¼
    const italicBtn = toolbar.querySelector('button[data-command="italic"]');
    if (italicBtn) {
      italicBtn.addEventListener('click', () => {
        editor.chain().focus().toggleItalic().run();
      });
    }
    
    // ë°‘ì¤„ ë²„íŠ¼
    const underlineBtn = toolbar.querySelector('button[data-command="underline"]');
    if (underlineBtn) {
      underlineBtn.addEventListener('click', () => {
        editor.chain().focus().toggleUnderline().run();
      });
    }
    
    // ê¸€ë¨¸ë¦¬ ê¸°í˜¸ ëª©ë¡
    const bulletListBtn = toolbar.querySelector('button[data-command="insertUnorderedList"]');
    if (bulletListBtn) {
      bulletListBtn.addEventListener('click', () => {
        editor.chain().focus().toggleBulletList().run();
      });
    }
    
    // ë²ˆí˜¸ ë§¤ê¸°ê¸° ëª©ë¡
    const orderedListBtn = toolbar.querySelector('button[data-command="insertOrderedList"]');
    if (orderedListBtn) {
      orderedListBtn.addEventListener('click', () => {
        editor.chain().focus().toggleOrderedList().run();
      });
    }
    
    // ë§í¬ ë²„íŠ¼
    const linkBtn = toolbar.querySelector('button[data-command="createLink"]');
    if (linkBtn) {
      linkBtn.addEventListener('click', () => {
        const url = prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:');
        if (url && this.isValidUrl(url)) {
          editor.chain().focus().setLink({ href: url }).run();
        }
      });
    }
    
    // í°íŠ¸ í¬ê¸° ë“œë¡­ë‹¤ìš´ ì²˜ë¦¬
    const dropdownMenu = toolbar.querySelector('.dropdown-menu');
    if (dropdownMenu) {
      const dropdownItems = dropdownMenu.querySelectorAll('.dropdown-item');
      dropdownItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const format = item.dataset.format;
          const label = item.textContent.trim();
          
          if (format === 'h1') {
            editor.chain().focus().toggleHeading({ level: 1 }).run();
          } else if (format === 'h2') {
            editor.chain().focus().toggleHeading({ level: 2 }).run();
          } else if (format === 'h3') {
            editor.chain().focus().toggleHeading({ level: 3 }).run();
          } else if (format === 'p') {
            editor.chain().focus().setParagraph().run();
          }
          
          // ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          fontSizeDropdown.textContent = label;
          
          // Bootstrap ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          const dropdown = bootstrap.Dropdown.getInstance(fontSizeDropdown);
          if (dropdown) {
            dropdown.hide();
          }
        });
      });
    }
    
    // í˜„ì¬ ì„ íƒëœ ë¸”ë¡ì˜ ìŠ¤íƒ€ì¼ì— ë”°ë¼ ë“œë¡­ë‹¤ìš´ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    editor.on('selectionUpdate', () => {
      this.updateFontSizeDropdown();
    });
  },
  
  updateFontSizeDropdown() {
    if (!editor) return;
    
    const fontSizeDropdown = document.getElementById('fontSizeDropdown');
    if (!fontSizeDropdown) return;
    
    if (editor.isActive('heading', { level: 1 })) {
      fontSizeDropdown.textContent = 'H1';
    } else if (editor.isActive('heading', { level: 2 })) {
      fontSizeDropdown.textContent = 'H2';
    } else if (editor.isActive('heading', { level: 3 })) {
      fontSizeDropdown.textContent = 'H3';
    } else {
      fontSizeDropdown.textContent = 'ë³¸ë¬¸';
    }
  },

  isValidUrl(string) {
    try {
      const url = new URL(string);
      return url.protocol === 'http:' || url.protocol === 'https:';
    } catch (_) {
      return false;
    }
  },


  setupWordCount() {
    // ì œëª© ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
    const updateTitleCount = () => {
      const count = this.titleElement.value.length;
      document.getElementById('titleCharCount').textContent = count;
    };
    
    this.titleElement.addEventListener('input', updateTitleCount);
    updateTitleCount(); // ì´ˆê¸°ê°’ ì„¤ì •
  },

  setupTagInput() {
    const tagInput = document.getElementById('tagInput');
    const tagList = document.getElementById('tagList');
    const tags = [];
    const maxTags = 10;

    const updateTagInput = () => {
      document.getElementById('postTags').value = tags.join(',');
    };

    const addTag = (tagText) => {
      const tag = tagText.trim().toLowerCase();
      
      if (!tag) return false;
      if (tags.length >= maxTags) {
        alert(`íƒœê·¸ëŠ” ìµœëŒ€ ${maxTags}ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        return false;
      }
      if (tags.includes(tag)) {
        alert('ì´ë¯¸ ì¶”ê°€ëœ íƒœê·¸ì…ë‹ˆë‹¤.');
        return false;
      }
      if (tag.length > 20) {
        alert('íƒœê·¸ëŠ” ìµœëŒ€ 20ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return false;
      }
      if (!/^[ê°€-í£a-zA-Z0-9\s]+$/.test(tag)) {
        alert('íƒœê·¸ëŠ” í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return false;
      }

      tags.push(tag);
      updateTagInput();
      renderTags();
      tagInput.value = '';
      return true;
    };

    const removeTag = (tag) => {
      const index = tags.indexOf(tag);
      if (index > -1) {
        tags.splice(index, 1);
        updateTagInput();
        renderTags();
      }
    };

    const renderTags = () => {
      tagList.innerHTML = tags.map(tag => 
        `<span class="badge bg-primary tag-badge">${SecurityUtils.escapeHtml(tag)} <span class="ms-1" style="cursor: pointer;">Ã—</span></span>`
      ).join('');
      
      tagList.querySelectorAll('.tag-badge').forEach((badge, index) => {
        badge.addEventListener('click', () => {
          removeTag(tags[index]);
        });
      });
    };

    tagInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (addTag(tagInput.value)) {
          // íƒœê·¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë¨
        }
      }
    });
  },

  setupFormSubmit() {
    const form = document.getElementById('postForm');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    
    // ë°œí–‰ ë²„íŠ¼ í´ë¦­ ì‹œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
    const publishBtn = document.getElementById('publishBtn');
    publishBtn.addEventListener('click', (e) => {
      e.preventDefault();
      
      // ì œëª© ê²€ì¦
      const title = this.titleElement.value.trim();
      if (!SecurityUtils.validateInput(title, 200)) {
        alert('ì œëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœëŒ€ 200ì)');
        return;
      }
      
      // ë³¸ë¬¸ ê²€ì¦
      if (!editor) {
        alert('ì—ë””í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      let content = editor.getHTML();
      const textContent = editor.getText().trim();
      
      if (!textContent || textContent === '') {
        alert('ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const boardId = document.getElementById('postCategory').value;
      const thumbnailUrlField = document.getElementById('thumbnailUrl');
      const thumbnailUrlValue = thumbnailUrlField ? thumbnailUrlField.value.trim() : '';

      if (boardId === '1' && !thumbnailUrlValue) {
        alert('ë ˆì‹œí”¼ ê²Œì‹œíŒ ê²Œì‹œê¸€ì€ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      // XSS ë³´ì•ˆ ì²˜ë¦¬
      content = SecurityUtils.sanitizeHtml(content);
      this.contentInput.value = content;
      
      // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
      this.showPreview(previewModal);
    });
    
    // ëª¨ë‹¬ ë‚´ ë°œí–‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤ì œ ë°œí–‰
    const publishFromModalBtn = document.getElementById('publishFromModalBtn');
    publishFromModalBtn.addEventListener('click', () => {
      this.executePublish(previewModal);
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      // ì„ì‹œ ì €ì¥ ë¡œì§
      const title = this.titleElement.value.trim();
      let content = '';
      
      if (editor) {
        content = editor.getHTML();
      }
      
      // XSS ë³´ì•ˆ ì²˜ë¦¬
      content = SecurityUtils.sanitizeHtml(content);
      
      const draftData = {
        title: SecurityUtils.escapeHtml(title),
        content: content,
        category: document.getElementById('postCategory').value || '',
        subcategory: document.getElementById('postSubCategory').value || '',
        tags: document.getElementById('postTags').value || '',
        thumbnailUrl: document.getElementById('thumbnailUrl') ? document.getElementById('thumbnailUrl').value || '' : ''
      };
      
      // localStorageì— ì €ì¥ (ì‹¤ì œë¡œëŠ” ì„œë²„ì— ì €ì¥)
      localStorage.setItem('draft_post', JSON.stringify(draftData));
      alert('ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

  },


  setupImageUpload() {
    if (!editor) return;
    
    const imageUploadBtn = document.getElementById('imageUploadBtn');
    const imageUploadInput = document.getElementById('imageUploadInput');
    
    if (!imageUploadBtn || !imageUploadInput) return;
    
    // ì´ë¯¸ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì ì—´ê¸°
    imageUploadBtn.addEventListener('click', (e) => {
      e.preventDefault();
      imageUploadInput.click();
    });
    
    // íŒŒì¼ ì„ íƒ ì‹œ ì—…ë¡œë“œ ì²˜ë¦¬
    imageUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // íŒŒì¼ íƒ€ì… ê²€ì¦
      if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB ì œí•œ)
      if (file.size > 5 * 1024 * 1024) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      try {
        const result = await uploadImageFile(file);
        
        // ì´ë¯¸ì§€ë¥¼ ì—ë””í„°ì— ì‚½ì…
        editor.chain().focus().setImage({ src: result.url, alt: file.name }).run();
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        alert(error.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      
      // input ì´ˆê¸°í™”
      imageUploadInput.value = '';
    });
  },

  // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ì»¨íŠ¸ë¡¤ ì„¤ì • (ì˜¤ë²„ë ˆì´ ë°©ì‹)
  setupImageResizeControls() {
    if (!editor || !this.contentElement) return;

    const overlay = document.getElementById('image-resize-overlay');
    const toolbar = document.getElementById('image-resize-toolbar');
    const resizeInfo = overlay?.querySelector('.resize-info');
    const widthInput = document.getElementById('resize-width');
    const heightInput = document.getElementById('resize-height');
    const resetBtn = document.getElementById('reset-size-btn');
    
    if (!overlay || !toolbar || !widthInput || !heightInput) {
      console.error('ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    let selectedImage = null;
    let originalWidth = 0;  // ì›ë³¸ ê°€ë¡œ í¬ê¸°
    let originalHeight = 0; // ì›ë³¸ ì„¸ë¡œ í¬ê¸°
    let aspectRatio = 1;    // ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨
    let isResizing = false;
    let startX = 0;
    let startY = 0;
    let startWidth = 0;
    let startHeight = 0;
    let resizeDirection = '';
    let isUpdatingInputs = false; // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸ ì¤‘ í”Œë˜ê·¸

    // ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    const updateOverlayPosition = () => {
      if (!selectedImage) return;
      
      const rect = selectedImage.getBoundingClientRect();
      
      // ì´ë¯¸ì§€ í¬ê¸°ê°€ 0ì´ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ì…ë ¥ ì¤‘ì¼ ë•Œ ë°œìƒí•  ìˆ˜ ìˆìŒ)
      if (rect.width <= 0 || rect.height <= 0) {
        return;
      }
      
      overlay.style.left = rect.left + 'px';
      overlay.style.top = rect.top + 'px';
      overlay.style.width = rect.width + 'px';
      overlay.style.height = rect.height + 'px';
      
      // íˆ´ë°” ìœ„ì¹˜ (ì´ë¯¸ì§€ ì•„ë˜)
      toolbar.style.left = rect.left + 'px';
      toolbar.style.top = (rect.bottom + 8) + 'px';
      
      // í˜„ì¬ í¬ê¸° í‘œì‹œ
      const currentWidth = Math.round(selectedImage.clientWidth);
      const currentHeight = Math.round(selectedImage.clientHeight);
      
      // í¬ê¸°ê°€ ìœ íš¨í•  ë•Œë§Œ í‘œì‹œ
      if (currentWidth > 0 && currentHeight > 0) {
        if (resizeInfo) resizeInfo.textContent = `${currentWidth} Ã— ${currentHeight}`;
        
        // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ì…ë ¥ì— ì˜í•œ ì—…ë°ì´íŠ¸ê°€ ì•„ë‹ ë•Œë§Œ)
        if (!isUpdatingInputs) {
          widthInput.value = currentWidth;
          heightInput.value = currentHeight;
        }
      }
    };

    // ì´ë¯¸ì§€ ì„ íƒ
    const selectImage = (imgEl) => {
      // ê¸°ì¡´ ì„ íƒ í•´ì œ
      deselectImage();
      
      selectedImage = imgEl;
      
      // ì›ë³¸ í¬ê¸° ì €ì¥ (naturalWidth/Height ì‚¬ìš©, ì—†ìœ¼ë©´ clientWidth/Height ì‚¬ìš©)
      if (imgEl.naturalWidth > 0 && imgEl.naturalHeight > 0) {
        originalWidth = imgEl.naturalWidth;
        originalHeight = imgEl.naturalHeight;
      } else {
        // ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ naturalWidthê°€ 0ì´ë©´ clientWidth ì‚¬ìš©
        originalWidth = imgEl.clientWidth || 100;
        originalHeight = imgEl.clientHeight || 100;
        
        // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì›ë³¸ í¬ê¸° ì—…ë°ì´íŠ¸
        if (imgEl.complete) {
          // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ë‹¤ì‹œ ì‹œë„
          if (imgEl.naturalWidth > 0 && imgEl.naturalHeight > 0) {
            originalWidth = imgEl.naturalWidth;
            originalHeight = imgEl.naturalHeight;
          }
        } else {
          // ì•„ì§ ë¡œë“œ ì¤‘ì´ë©´ ë¡œë“œ ì™„ë£Œ ì‹œ ì—…ë°ì´íŠ¸
          imgEl.addEventListener('load', function onImageLoad() {
            if (imgEl.naturalWidth > 0 && imgEl.naturalHeight > 0) {
              originalWidth = imgEl.naturalWidth;
              originalHeight = imgEl.naturalHeight;
              aspectRatio = originalWidth / originalHeight;
            }
            imgEl.removeEventListener('load', onImageLoad);
          }, { once: true });
        }
      }
      
      aspectRatio = originalWidth / originalHeight;
      
      imgEl.classList.add('image-selected');
      overlay.classList.add('active');
      toolbar.classList.add('active');
      
      // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ í¬ê¸°ê°€ ì•ˆì •í™”ë  ë•Œê¹Œì§€)
      setTimeout(() => {
        updateOverlayPosition();
      }, 50);
      
      // ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      window.addEventListener('scroll', updateOverlayPosition, true);
      window.addEventListener('resize', updateOverlayPosition);
    };

    // ì´ë¯¸ì§€ ì„ íƒ í•´ì œ
    const deselectImage = () => {
      if (selectedImage) {
        selectedImage.classList.remove('image-selected');
      }
      selectedImage = null;
      originalWidth = 0;
      originalHeight = 0;
      overlay.classList.remove('active');
      toolbar.classList.remove('active');
      
      window.removeEventListener('scroll', updateOverlayPosition, true);
      window.removeEventListener('resize', updateOverlayPosition);
    };

    // í”½ì…€ í¬ê¸° ì ìš© (ë¹„ìœ¨ ìœ ì§€)
    const applyPixelSize = (newWidth, newHeight) => {
      if (!selectedImage) return;

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!Number.isFinite(newWidth) || !Number.isFinite(newHeight)) {
        console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ í¬ê¸° ê°’:', newWidth, newHeight);
        return;
      }

      // ìµœì†Œ í¬ê¸° ì œí•œ
      const clampedWidth = Math.max(10, Math.round(newWidth));
      const clampedHeight = Math.max(10, Math.round(newHeight));
      
      // DOMì— ì§ì ‘ ì ìš© (í”½ì…€ ë‹¨ìœ„)
      selectedImage.style.width = clampedWidth + 'px';
      selectedImage.style.height = clampedHeight + 'px';
      selectedImage.setAttribute('width', clampedWidth + 'px');
      selectedImage.setAttribute('height', clampedHeight + 'px');
      
      // ì—ë””í„°ì—ë„ ì ìš©
      const selectedSrc = selectedImage.getAttribute('src') || selectedImage.src;
      editor.state.doc.descendants((node, pos) => {
        if (node.type.name === 'image') {
          const imgSrc = node.attrs.src;
          if (imgSrc === selectedSrc) {
            editor.chain()
              .setNodeSelection(pos)
              .updateAttributes('image', { 
                width: clampedWidth + 'px',
                height: clampedHeight + 'px'
              })
        .run();
            return false;
          }
        }
      });
      
      // ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸°)
      requestAnimationFrame(() => {
        setTimeout(updateOverlayPosition, 10);
      });
    };

    // ê°€ë¡œ ì…ë ¥ ì‹œ ì„¸ë¡œ ìë™ ê³„ì‚°
    widthInput.addEventListener('input', (e) => {
      if (!selectedImage) return;
      
      const inputValue = e.target.value.trim();
      
      // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ì…ë ¥ ì¤‘ì¼ ìˆ˜ ìˆìŒ)
      if (inputValue === '' || inputValue === '-') {
        return;
      }

      const newWidth = parseInt(inputValue, 10);
      
      // ìœ íš¨í•œ ìˆ«ìê°€ ì•„ë‹ˆê±°ë‚˜ ìµœì†Œê°’ ë¯¸ë§Œì´ë©´ ë¬´ì‹œ
      if (!Number.isFinite(newWidth) || newWidth < 10) {
        return;
      }
      
      isUpdatingInputs = true;
      const newHeight = Math.round(newWidth / aspectRatio);
      heightInput.value = newHeight;
      
      applyPixelSize(newWidth, newHeight);
      
      // ì•½ê°„ì˜ ì§€ì—° í›„ í”Œë˜ê·¸ í•´ì œ (DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸°)
      setTimeout(() => {
        isUpdatingInputs = false;
      }, 0);
    });

    // ì„¸ë¡œ ì…ë ¥ ì‹œ ê°€ë¡œ ìë™ ê³„ì‚°
    heightInput.addEventListener('input', (e) => {
      if (!selectedImage) return;
      
      const inputValue = e.target.value.trim();
      
      // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ì…ë ¥ ì¤‘ì¼ ìˆ˜ ìˆìŒ)
      if (inputValue === '' || inputValue === '-') {
        return;
      }
      
      const newHeight = parseInt(inputValue, 10);
      
      // ìœ íš¨í•œ ìˆ«ìê°€ ì•„ë‹ˆê±°ë‚˜ ìµœì†Œê°’ ë¯¸ë§Œì´ë©´ ë¬´ì‹œ
      if (!Number.isFinite(newHeight) || newHeight < 10) {
        return;
      }
      
      isUpdatingInputs = true;
      const newWidth = Math.round(newHeight * aspectRatio);
      widthInput.value = newWidth;
      
      applyPixelSize(newWidth, newHeight);
      
      // ì•½ê°„ì˜ ì§€ì—° í›„ í”Œë˜ê·¸ í•´ì œ (DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸°)
      setTimeout(() => {
        isUpdatingInputs = false;
      }, 0);
    });
    
    // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì‹œ ì´ì „ ê°’ ì €ì¥ (í¬ì»¤ìŠ¤ ìƒì„ ë•Œ ë³µì›ìš©)
    let previousWidthValue = '';
    let previousHeightValue = '';
    
    widthInput.addEventListener('focus', (e) => {
      previousWidthValue = e.target.value;
    });
    
    heightInput.addEventListener('focus', (e) => {
      previousHeightValue = e.target.value;
    });
    
    // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ìƒì„ ë•Œ ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ì´ë©´ ì´ì „ ê°’ìœ¼ë¡œ ë³µì›
    widthInput.addEventListener('blur', (e) => {
      const inputValue = e.target.value.trim();
      const numValue = parseInt(inputValue, 10);
      
      if (!inputValue || !Number.isFinite(numValue) || numValue < 10) {
        // ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ì´ë©´ ì´ì „ ê°’ìœ¼ë¡œ ë³µì›
        if (previousWidthValue && selectedImage) {
          e.target.value = previousWidthValue;
        } else if (selectedImage) {
          // ì´ì „ ê°’ë„ ì—†ìœ¼ë©´ í˜„ì¬ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ë³µì›
          e.target.value = Math.round(selectedImage.clientWidth);
        }
      }
      isUpdatingInputs = false;
    });
    
    heightInput.addEventListener('blur', (e) => {
      const inputValue = e.target.value.trim();
      const numValue = parseInt(inputValue, 10);
      
      if (!inputValue || !Number.isFinite(numValue) || numValue < 10) {
        // ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ì´ë©´ ì´ì „ ê°’ìœ¼ë¡œ ë³µì›
        if (previousHeightValue && selectedImage) {
          e.target.value = previousHeightValue;
        } else if (selectedImage) {
          // ì´ì „ ê°’ë„ ì—†ìœ¼ë©´ í˜„ì¬ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ë³µì›
          e.target.value = Math.round(selectedImage.clientHeight);
        }
      }
      isUpdatingInputs = false;
    });

    // Enter í‚¤ë¡œ ì ìš©
    [widthInput, heightInput].forEach(input => {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input.blur();
        }
      });
    });

    // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­
    resetBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (!selectedImage || !originalWidth || !originalHeight) return;
      
      isUpdatingInputs = true;
      widthInput.value = originalWidth;
      heightInput.value = originalHeight;
      
      applyPixelSize(originalWidth, originalHeight);
      isUpdatingInputs = false;
    });

    // ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸
    this.contentElement.addEventListener('click', (event) => {
      const target = event.target;
      
      if (target.tagName === 'IMG') {
        event.preventDefault();
        event.stopPropagation();
        
        if (selectedImage === target) {
          deselectImage();
        } else {
          selectImage(target);
        }
      } else {
        // ì´ë¯¸ì§€ê°€ ì•„ë‹Œ ì—ë””í„° ë‚´ë¶€ ì˜ì—­ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
        // ë‹¨, ì˜¤ë²„ë ˆì´ë‚˜ íˆ´ë°” í´ë¦­ì€ ì œì™¸
        if (selectedImage && !overlay.contains(target) && !toolbar.contains(target)) {
          deselectImage();
        }
        // ì—ë””í„° í¬ì»¤ìŠ¤ ìœ ì§€ (ì´ë¯¸ì§€ê°€ ì•„ë‹Œ ì˜ì—­ í´ë¦­ ì‹œ)
        if (editor && !target.closest('#image-resize-overlay') && !target.closest('#image-resize-toolbar')) {
          editor.chain().focus().run();
        }
      }
    });

    // ì—ë””í„° ì™¸ë¶€ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
    document.addEventListener('click', (event) => {
      if (!selectedImage) return;
      
      const target = event.target;
      
      // ì˜¤ë²„ë ˆì´, íˆ´ë°” í´ë¦­ì€ ë¬´ì‹œ (ì—ë””í„° ë‚´ë¶€ëŠ” ìœ„ì—ì„œ ì²˜ë¦¬)
      if (overlay.contains(target) || toolbar.contains(target)) {
        return;
      }
      
      // ì—ë””í„° ì™¸ë¶€ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
      if (!this.contentElement.contains(target)) {
        deselectImage();
      }
    });

    // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ë“œë˜ê·¸
    overlay.querySelectorAll('.resize-handle').forEach(handle => {
      handle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (!selectedImage) return;
        
        isResizing = true;
        resizeDirection = handle.dataset.direction;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = selectedImage.clientWidth;
        startHeight = selectedImage.clientHeight;
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      });
    });

    const handleMouseMove = (e) => {
      if (!isResizing || !selectedImage) return;
      
      e.preventDefault();
      
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;
      
      let newWidth = startWidth;
      
      // ë°©í–¥ì— ë”°ë¥¸ í¬ê¸° ê³„ì‚°
      if (resizeDirection.includes('e')) {
        newWidth = startWidth + deltaX;
      } else if (resizeDirection.includes('w')) {
        newWidth = startWidth - deltaX;
      }
      
      // ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ë†’ì´ ê³„ì‚°
      const newHeight = Math.round(newWidth / aspectRatio);
      
      isUpdatingInputs = true;
      applyPixelSize(newWidth, newHeight);
      isUpdatingInputs = false;
      
      startX = e.clientX;
      startWidth = selectedImage.clientWidth;
    };

    const handleMouseUp = () => {
      isResizing = false;
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };

    // ë”ë¸”í´ë¦­ìœ¼ë¡œ ì§ì ‘ í¬ê¸° ì…ë ¥ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
    this.contentElement.addEventListener('dblclick', (event) => {
      const target = event.target;
      if (target.tagName !== 'IMG') return;

      event.preventDefault();
      event.stopPropagation();
      
      selectImage(target);
      widthInput.focus();
      widthInput.select();
    });

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (ESCë¡œ ì„ íƒ í•´ì œ)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && selectedImage) {
        deselectImage();
      }
    });
  },

  // ì´ë¯¸ì§€ wrapper observer ì œê±° (ì˜¤ë²„ë ˆì´ ë°©ì‹ì—ì„œëŠ” ë¶ˆí•„ìš”)
  setupImageWrapperObserver() {
    // ì˜¤ë²„ë ˆì´ ë°©ì‹ì—ì„œëŠ” wrapperê°€ í•„ìš” ì—†ìŒ
  },

  showPreview(previewModal) {
    const title = this.titleElement.value.trim() || '(ì œëª© ì—†ìŒ)';
    let content = '';
    let sanitizedContent = '';
    
    if (editor) {
      content = editor.getHTML();
      const textContent = editor.getText().trim();
      
      if (textContent === '') {
        sanitizedContent = '';
      } else {
        // XSS ë³´ì•ˆ ì²˜ë¦¬
        sanitizedContent = SecurityUtils.sanitizeHtml(content);
      }
    }

    // ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (IDê°€ ì•„ë‹Œ ì´ë¦„)
    const categorySelect = document.getElementById('postCategory');
    const subCategorySelect = document.getElementById('postSubCategory');
    
    const categoryText = categorySelect.selectedIndex > 0 
      ? categorySelect.options[categorySelect.selectedIndex].text 
      : 'ë¯¸ì„ íƒ';
      
    const subCategoryText = subCategorySelect.selectedIndex > 0 
      ? ' > ' + subCategorySelect.options[subCategorySelect.selectedIndex].text 
      : '';
      
    const category = categoryText + subCategoryText;
    
    const tags = document.getElementById('postTags').value 
      ? document.getElementById('postTags').value.split(',').map(t => SecurityUtils.escapeHtml(t)).join(', ')
      : 'ì—†ìŒ';
    
    // ì¸ë„¤ì¼ ì´ë¯¸ì§€ëŠ” ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í‘œì‹œí•˜ì§€ ì•ŠìŒ (ê²Œì‹œíŒ ëª©ë¡ì—ì„œë§Œ ì‚¬ìš©)
    const previewThumbnailEl = document.getElementById('previewThumbnail');
    if (previewThumbnailEl) {
        previewThumbnailEl.src = '';
        previewThumbnailEl.style.display = 'none';
    }
    
    document.getElementById('previewTitle').textContent = SecurityUtils.escapeHtml(title);
    document.getElementById('previewContent').innerHTML = sanitizedContent || '<p class="text-muted">(ë‚´ìš© ì—†ìŒ)</p>';
    document.getElementById('previewCategory').textContent = category;
    document.getElementById('previewTags').textContent = tags;
    
    previewModal.show();
  },
  
  async executePublish(previewModal) {
    // ì œëª© ê²€ì¦
    const title = this.titleElement.value.trim();
    if (!SecurityUtils.validateInput(title, 200)) {
      alert('ì œëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœëŒ€ 200ì)');
      return;
    }
    
    // ë³¸ë¬¸ ê²€ì¦
    if (!editor) {
      alert('ì—ë””í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }
    
    let content = editor.getHTML();
    const textContent = editor.getText().trim();
    
    if (!textContent || textContent === '') {
      alert('ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // HTML ì •í™” (XSS ë°©ì–´)
    content = SecurityUtils.sanitizeHtml(content);
    
    this.contentInput.value = content;
    
    // ì¹´í…Œê³ ë¦¬ ê²€ì¦
    const boardId = document.getElementById('postCategory').value;
    if (!boardId) {
      alert('ê²Œì‹œíŒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
    
    // í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ê²€ì¦ (í•„ìˆ˜)
    const subcategory = document.getElementById('postSubCategory').value;
    if (!subcategory) {
      alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const thumbnailUrlField = document.getElementById('thumbnailUrl');
    const thumbnailUrlValue = thumbnailUrlField ? thumbnailUrlField.value.trim() : '';

    if (boardId === '1' && !thumbnailUrlValue) {
      alert('ë ˆì‹œí”¼ ê²Œì‹œíŒ ê²Œì‹œê¸€ì€ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
    
    // ìˆ˜ì • ëª¨ë“œ í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('postId');
    const postType = urlParams.get('postType');
    const isEditMode = postId && postType;
    
    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const user = getStoredUser();
    if (!user || !user.userId) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
      window.location.href = '/login.html';
      return;
    }
    
    const authorName = user.nickname || user.email?.split('@')[0] || 'ìµëª…';
    const userId = user.userId;
    
    // í¼ ë°ì´í„° ì¤€ë¹„
    const postData = {
      title: title,
      content: content,
      subcategory: subcategory,
      tags: document.getElementById('postTags').value || '',
      authorName: authorName,
      userId: userId,
      thumbnailUrl: boardId === '1' ? thumbnailUrlValue : ''
    };
    
    // ê²Œì‹œíŒ IDì— ë”°ë¼ API ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
    const apiEndpoint = boardId === '1' ? '/api/recipes' : '/api/tips';
    
    try {
      let response;
      if (isEditMode) {
        // ìˆ˜ì • ëª¨ë“œ: PUT ìš”ì²­
        response = await fetch(`${apiEndpoint}/${postId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        });
      } else {
        // ìƒˆ ê²Œì‹œê¸€: POST ìš”ì²­
        response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        });
      }
      
      const result = await response.json();
      
      if (result.success) {
        // ë°œí–‰ ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì • (í˜ì´ì§€ ì´íƒˆ ê²½ê³  ë¹„í™œì„±í™”)
        isPublished = true;
        
        alert(isEditMode ? 'ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ê²Œì‹œê¸€ì´ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
        
        // ì„ì‹œ ì €ì¥ ë°ì´í„° ì‚­ì œ
        localStorage.removeItem('postDraft');
        
        // ëª¨ë‹¬ ë‹«ê¸° (ìˆëŠ” ê²½ìš°)
        if (typeof previewModal !== 'undefined' && previewModal) {
    previewModal.hide();
        }
        
        if (isEditMode) {
          // ìˆ˜ì • ëª¨ë“œ: ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ (postTypeì´ ì´ë¯¸ MENU_ID)
          window.location.href = `/post-detail.html?type=${postType}&id=${postId}`;
        } else {
          // ìƒˆ ê²Œì‹œê¸€: í•´ë‹¹ ê²Œì‹œíŒ/ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
          const params = new URLSearchParams();
          params.set('board', boardId);
          params.set('category', subcategory);
          
          window.location.href = `/board.html?${params.toString()}`;
        }
      } else {
        alert(isEditMode ? 'ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message : 'ê²Œì‹œê¸€ ë°œí–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message);
      }
    } catch (error) {
      console.error('ê²Œì‹œê¸€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      alert(isEditMode ? 'ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' : 'ê²Œì‹œê¸€ ë°œí–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  },
  
  setupPreview() {
    // ì´ì „ ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ê´€ë ¨ ì½”ë“œ ì œê±°
    // ë°œí–‰ ë²„íŠ¼ê³¼ ëª¨ë‹¬ ë°œí–‰ ë²„íŠ¼ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ë³€ê²½ë¨
  }
};

// ë¡œê·¸ì¸ ì²´í¬ í•¨ìˆ˜
function getStoredUser() {
  try {
    const raw = localStorage.getItem('sandwichUser');
    return raw ? JSON.parse(raw) : null;
  } catch (error) {
    console.warn('ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error);
    return null;
  }
}

function checkLogin() {
  const user = getStoredUser();
  if (!user || !user.userId) {
    alert('ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    window.location.href = '/login.html';
    return false;
  }
  
  // ì°¨ë‹¨ëœ ì‚¬ìš©ì í™•ì¸
  if (user.blocked === true) {
    alert('ì°¨ë‹¨ëœ ì‚¬ìš©ìëŠ” ê²Œì‹œê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    window.location.href = '/home.html';
    return false;
  }
  
  return true;
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async () => {
  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
  const backButton = document.getElementById('backButton');
  if (backButton) {
    backButton.addEventListener('click', () => {
      // ì´ì „ í˜ì´ì§€ë¡œ ì´ë™ ë˜ëŠ” í™ˆìœ¼ë¡œ ì´ë™
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/home.html';
      }
    });
  }
  
  // ë¡œê·¸ì¸ ì²´í¬
  if (!checkLogin()) {
    return;
  }
  
  // Tiptap ë²ˆë“¤ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
  let retries = 0;
  const maxRetries = 100; // 10ì´ˆ ëŒ€ê¸°
  
  while ((typeof TiptapEditor === 'undefined' || !window.TiptapEditorLoaded) && retries < maxRetries) {
    await new Promise(resolve => setTimeout(resolve, 100));
    retries++;
  }
  
  if (typeof TiptapEditor === 'undefined') {
    console.error('Tiptap ì—ë””í„° ë²ˆë“¤ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    console.error('ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ í™•ì¸:', document.querySelector('script[src="/js/tiptap-editor.bundle.js"]'));
    console.error('TiptapEditorLoaded:', window.TiptapEditorLoaded);
    console.error('window ê°ì²´ì— TiptapEditorê°€ ìˆëŠ”ì§€:', 'TiptapEditor' in window);
    alert('ì—ë””í„°ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  console.log('TiptapEditor í™•ì¸:', typeof TiptapEditor, TiptapEditor);
  console.log('TiptapEditor.initTiptapEditor:', typeof TiptapEditor?.initTiptapEditor);
  
  await EditorManager.init();
  
  // Footer ë¡œë“œ
  fetch('/footer.html')
    .then(res => res.text())
    .then(html => { 
      const footer = document.getElementById('site-footer');
      if (footer) {
        footer.innerHTML = DOMPurify.sanitize(html);
      }
    })
    .catch(err => console.error('Footer ë¡œë“œ ì‹¤íŒ¨:', err));
  
  // ë©”ë‰´ ë°ì´í„° ì €ì¥ ë³€ìˆ˜
  let menuData = {
    boards: [],
    categories: []
  };
  
  const categorySelect = document.getElementById('postCategory');
  const subCategorySelect = document.getElementById('postSubCategory');
  const thumbnailSection = document.getElementById('thumbnailSection');
  const thumbnailCard = document.getElementById('thumbnailCard');
  const thumbnailImage = document.getElementById('thumbnailImage');
  const thumbnailPlaceholder = document.getElementById('thumbnailPlaceholder');
  const thumbnailUploadBtn = document.getElementById('thumbnailUploadBtn');
  const thumbnailUploadInput = document.getElementById('thumbnailUploadInput');
  const thumbnailRemoveBtn = document.getElementById('thumbnailRemoveBtn');
  const thumbnailUrlInput = document.getElementById('thumbnailUrl');
  const previewThumbnail = document.getElementById('previewThumbnail');

  function updateThumbnailVisibility(boardId) {
    if (!thumbnailSection) return;

    if (boardId === '1') {
      thumbnailSection.style.display = 'block';
    } else {
      thumbnailSection.style.display = 'none';
      clearThumbnailSelection();
    }
  }

  function setThumbnailSelection(url, originalName = '') {
    if (!thumbnailCard || !thumbnailImage || !thumbnailPlaceholder || !thumbnailRemoveBtn || !thumbnailUrlInput) {
      return;
    }

    thumbnailUrlInput.value = url;
    thumbnailImage.src = url;
    thumbnailImage.alt = originalName || 'ëŒ€í‘œ ì´ë¯¸ì§€';
    thumbnailImage.style.display = 'block';
    thumbnailPlaceholder.style.display = 'none';
    thumbnailCard.classList.add('has-image');
    thumbnailRemoveBtn.style.display = 'inline-block';

    if (previewThumbnail) {
      previewThumbnail.src = url;
      previewThumbnail.style.display = 'block';
    }
  }

  function clearThumbnailSelection() {
    if (!thumbnailCard || !thumbnailImage || !thumbnailPlaceholder || !thumbnailRemoveBtn || !thumbnailUrlInput) {
      return;
    }

    thumbnailUrlInput.value = '';
    thumbnailImage.src = '';
    thumbnailImage.style.display = 'none';
    thumbnailPlaceholder.style.display = 'block';
    thumbnailCard.classList.remove('has-image');
    thumbnailRemoveBtn.style.display = 'none';

    if (previewThumbnail) {
      previewThumbnail.src = '';
      previewThumbnail.style.display = 'none';
    }
  }

  if (thumbnailUploadBtn && thumbnailUploadInput) {
    thumbnailUploadBtn.addEventListener('click', (e) => {
      e.preventDefault();
      thumbnailUploadInput.click();
    });

    thumbnailUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        thumbnailUploadInput.value = '';
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        thumbnailUploadInput.value = '';
        return;
      }

      try {
        const result = await uploadImageFile(file);
        setThumbnailSelection(result.url, result.originalName || file.name);
      } catch (error) {
        console.error('ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        alert(error.message || 'ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        thumbnailUploadInput.value = '';
      }
    });
  }

  if (thumbnailRemoveBtn) {
    thumbnailRemoveBtn.addEventListener('click', (e) => {
      e.preventDefault();
      clearThumbnailSelection();
    });
  }
  
  // APIì—ì„œ ë©”ë‰´ ë°ì´í„° ë¡œë“œ
  async function loadMenus() {
    try {
      const response = await fetch('/api/menus');
      const result = await response.json();
      
      if (result.success) {
        menuData = result.data;
        
        // ê²Œì‹œíŒ(ëŒ€ë©”ë‰´) ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        categorySelect.innerHTML = '<option value="">ê²Œì‹œíŒ ì„ íƒ</option>';
        menuData.boards.forEach(board => {
          const option = document.createElement('option');
          option.value = board.MENU_ID;
          option.textContent = board.MENU_NAME;
          categorySelect.appendChild(option);
        });
        
        console.log('ë©”ë‰´ ë¡œë“œ ì™„ë£Œ:', menuData);
        updateThumbnailVisibility(categorySelect.value || '');
        return true;
      } else {
        console.error('ë©”ë‰´ ë¡œë“œ ì‹¤íŒ¨:', result.message);
        alert('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return false;
      }
    } catch (error) {
      console.error('ë©”ë‰´ ë¡œë“œ ì˜¤ë¥˜:', error);
      alert('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return false;
    }
  }
  
  // ëŒ€ë©”ë‰´ ì„ íƒ ì‹œ ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸
  categorySelect.addEventListener('change', function() {
    const selectedBoardId = this.value;
    
    // ì†Œë©”ë‰´ ì´ˆê¸°í™”
    subCategorySelect.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>';
    
    if (selectedBoardId) {
      // ì„ íƒëœ ê²Œì‹œíŒì— ì†í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë§Œ í•„í„°ë§
      const relatedCategories = menuData.categories.filter(
        cat => cat.MENU_TOP === parseInt(selectedBoardId)
      );
      
      if (relatedCategories.length > 0) {
        relatedCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.MENU_ID;
          option.textContent = category.MENU_NAME;
          subCategorySelect.appendChild(option);
        });
        subCategorySelect.disabled = false;
      } else {
        subCategorySelect.disabled = true;
      }
    } else {
      subCategorySelect.disabled = true;
    }

    updateThumbnailVisibility(selectedBoardId);
  });
  
  // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²Œì‹œíŒê³¼ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì½ê¸°
  function getUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
      board: urlParams.get('board'),
      category: urlParams.get('category'),
      postId: urlParams.get('postId'),
      postType: urlParams.get('postType')
    };
  }
  
  // URL íŒŒë¼ë¯¸í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ì„¤ì •
  function setDropdownsFromUrl() {
    const params = getUrlParams();
    
    if (!params.board) return; // URL íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì„¤ì •í•˜ì§€ ì•ŠìŒ
    
    // ê²Œì‹œíŒ ë“œë¡­ë‹¤ìš´ ì„¤ì •
    categorySelect.value = params.board;
    updateThumbnailVisibility(params.board);
    
    // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°í•˜ì—¬ ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸
    categorySelect.dispatchEvent(new Event('change'));
    
    // ì¹´í…Œê³ ë¦¬ ì„¤ì • (ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸ í›„)
    if (params.category) {
      setTimeout(() => {
        subCategorySelect.value = params.category;
      }, 200); // ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸ ëŒ€ê¸°
    }
  }
  
  // ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë“œ: URL íŒŒë¼ë¯¸í„°ì—ì„œ postIdì™€ postType(MENU_ID) í™•ì¸
  const urlParams = getUrlParams();
  const postId = urlParams.postId;
  const postType = urlParams.postType; // '1' (ë ˆì‹œí”¼) or '2' (ì •ë³´ ê³µìœ ) - MENU_TBì˜ MENU_ID
  let isEditMode = false;
  let editPostId = null;
  let editPostType = null;
  
  console.log('ğŸ” ìˆ˜ì • ëª¨ë“œ í™•ì¸:', { postId, postType, urlParams });
  
  // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ê²Œì‹œê¸€ ë°ì´í„° ë¡œë“œ
  async function loadPostForEdit(postId, postType) {
    console.log('ğŸ” ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë“œ - ë¡œë“œ ì‹œì‘:', { postId, postType });
    
    try {
      // MENU_ID 1 = ë ˆì‹œí”¼ ê²Œì‹œíŒ, MENU_ID 2 = ì •ë³´ ê³µìœ  ê²Œì‹œíŒ
      const apiUrl = postType === '1' 
        ? `/api/recipes/${postId}`
        : `/api/tips/${postId}`;
      
      console.log('ğŸ” API í˜¸ì¶œ:', apiUrl);
      const response = await fetch(apiUrl);
      const result = await response.json();
      
      console.log('ğŸ” API ì‘ë‹µ:', result);
      
      if (!result.success) {
        alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + result.message);
        return false;
      }
      
      const data = result.data;
      console.log('ğŸ” ê²Œì‹œê¸€ ë°ì´í„°:', data);
      
      // ì œëª© ì„¤ì •
      EditorManager.titleElement.value = data.TITLE || '';
      // ì œëª© ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
      const titleCount = document.getElementById('titleCharCount');
      if (titleCount) {
        titleCount.textContent = (data.TITLE || '').length;
      }
      
      // ë³¸ë¬¸ ì„¤ì •
      if (editor && data.CONTENT) {
        editor.commands.setContent(data.CONTENT);
      }
      console.log('ğŸ” ë³¸ë¬¸ ì„¤ì • ì™„ë£Œ:', data.CONTENT ? 'ìˆìŒ' : 'ì—†ìŒ');
      
      if (postType === '1') {
        updateThumbnailVisibility('1');
        if (data.IMAGE_URL) {
          setThumbnailSelection(data.IMAGE_URL, data.IMAGE_URL);
        } else {
          clearThumbnailSelection();
        }
      } else {
        updateThumbnailVisibility(postType);
        clearThumbnailSelection();
      }
      
      // ì¹´í…Œê³ ë¦¬ ì„¤ì • (ë©”ë‰´ ë¡œë“œ í›„)
      if (data.CATEGORY) {
        console.log('ğŸ” ì¹´í…Œê³ ë¦¬ ì„¤ì •:', data.CATEGORY);
        setTimeout(() => {
          // ê²Œì‹œíŒ ì„ íƒ (postTypeì´ ì´ë¯¸ MENU_ID)
          const boardId = postType; // '1' ë˜ëŠ” '2'
          categorySelect.value = boardId;
          categorySelect.dispatchEvent(new Event('change'));
          
          // ì¹´í…Œê³ ë¦¬ ì„ íƒ
          setTimeout(() => {
            subCategorySelect.value = data.CATEGORY;
            console.log('ğŸ” ì¹´í…Œê³ ë¦¬ ì„ íƒ ì™„ë£Œ:', data.CATEGORY);
          }, 200);
        }, 300);
      }
      
      // íƒœê·¸ ì„¤ì •
      if (data.TAGS) {
        const tags = data.TAGS.split(',').map(tag => tag.trim()).filter(tag => tag);
        tags.forEach(tag => {
          const tagInput = document.getElementById('tagInput');
          tagInput.value = tag;
          tagInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        });
        console.log('ğŸ” íƒœê·¸ ì„¤ì • ì™„ë£Œ:', tags);
      }
      
      // í˜ì´ì§€ ì œëª© ë³€ê²½
      document.title = 'ê²Œì‹œê¸€ ìˆ˜ì • - ìƒŒëƒ ';
      
      // ë°œí–‰ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
      const publishBtn = document.getElementById('publishBtn');
      if (publishBtn) {
        publishBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
      }
      
      console.log('âœ… ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë“œ ë¡œë“œ ì™„ë£Œ');
      return true;
    } catch (error) {
      console.error('ê²Œì‹œê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
      alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return false;
    }
  }
  
  // ë©”ë‰´ ë¡œë“œ ì‹¤í–‰
  loadMenus().then(async () => {
    console.log('ğŸ” ë©”ë‰´ ë¡œë“œ ì™„ë£Œ, ìˆ˜ì • ëª¨ë“œ í™•ì¸:', { postId, postType });
    // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ê²Œì‹œê¸€ ë°ì´í„° ë¡œë“œ
    if (postId && postType) {
      console.log('âœ… ìˆ˜ì • ëª¨ë“œ í™œì„±í™”');
      isEditMode = true;
      editPostId = postId;
      editPostType = postType;
      await loadPostForEdit(postId, postType);
    } else if (urlParams.board) {
      // URL íŒŒë¼ë¯¸í„°ë¡œ ë“œë¡­ë‹¤ìš´ ì„¤ì •
      setDropdownsFromUrl();
    } else {
      // ì„ì‹œ ì €ì¥ ë°ì´í„° ë³µì› (URL íŒŒë¼ë¯¸í„°ê°€ ì—†ì„ ë•Œë§Œ)
  const savedDraft = localStorage.getItem('draft_post');
  if (savedDraft) {
    try {
      const draft = JSON.parse(savedDraft);
      if (confirm('ì„ì‹œ ì €ì¥ëœ ê²Œì‹œê¸€ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        EditorManager.titleElement.value = draft.title || '';
        if (editor && draft.content) {
          editor.commands.setContent(draft.content);
        }
        if (draft.category) {
              // ë©”ë‰´ ë¡œë“œ ì™„ë£Œ í›„ ë³µì›
              setTimeout(() => {
          document.getElementById('postCategory').value = draft.category;
                updateThumbnailVisibility(draft.category);
                // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°í•˜ì—¬ ì†Œë©”ë‰´ ì—…ë°ì´íŠ¸
                categorySelect.dispatchEvent(new Event('change'));
                
                // ì†Œë©”ë‰´ë„ ë³µì›
                if (draft.subcategory) {
                  setTimeout(() => {
                    document.getElementById('postSubCategory').value = draft.subcategory;
                  }, 100);
                }

                if (draft.category === '1' && draft.thumbnailUrl) {
                  setThumbnailSelection(draft.thumbnailUrl, draft.thumbnailUrl);
                } else {
                  clearThumbnailSelection();
                }
              }, 300);
        }
        if (draft.tags) {
          const tags = draft.tags.split(',');
          tags.forEach(tag => {
            document.getElementById('tagInput').value = tag;
            document.getElementById('tagInput').dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
          });
        }
      }
    } catch (e) {
      console.error('ì„ì‹œ ì €ì¥ ë°ì´í„° ë³µì› ì‹¤íŒ¨:', e);
        }
    }
  }
  });
});

// í˜ì´ì§€ ì´íƒˆ ê²½ê³  í”Œë˜ê·¸
let isPublished = false;

// í˜ì´ì§€ ì´íƒˆ ê²½ê³ 
window.addEventListener('beforeunload', (e) => {
  // ë°œí–‰ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ê²½ê³ í•˜ì§€ ì•ŠìŒ
  if (isPublished) {
    return;
  }
  
  const title = EditorManager.titleElement.value.trim();
  const content = editor ? editor.getText().trim() : '';
  
  if (title || content) {
    e.preventDefault();
    e.returnValue = '';
  }
});
</script>
</body>
</html>
