<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net;">
  <title>ê²€ìƒ‰ ê²°ê³¼ - ìƒŒëƒ </title>
  <link rel="stylesheet" href="/assets/css/gnb.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/variables.css">
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/layout.css">
  <link rel="stylesheet" href="/assets/css/components.css">
  <style>

    .search-container {
      display: flex;
      min-height: 100vh;
    }

    .search-main {
      margin-left: var(--gnb-width);
      flex: 1;
      padding: 3rem 4rem;
    }

    .search-header {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .search-area {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .search-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background-color: var(--bg-white);
      border-radius: 40px;
      border: 1.5px solid var(--soft-pink-border);
      box-shadow: 0 4px 16px rgba(255, 107, 157, 0.08);
      max-width: 640px;
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 1rem;
      padding: 0 0.5rem;
      color: var(--text-dark);
    }

    .search-input::placeholder {
      color: var(--text-placeholder);
    }

    .search-button {
      border: none;
      background: transparent;
      color: var(--primary-pink);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .search-button:hover {
      transform: scale(1.1);
    }

    .search-results-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .search-results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .search-results-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .search-results-count {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .search-results-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .search-result-item {
      background-color: var(--bg-white);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .search-result-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(255, 107, 157, 0.15);
    }

    .search-result-image {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      background-color: var(--soft-gray);
    }

    .search-result-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .search-result-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-dark);
      margin: 0;
    }

    .search-result-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .search-result-type {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .search-result-type.recipe {
      background-color: rgba(255, 107, 157, 0.1);
      color: var(--primary-pink);
    }

    .search-result-type.tip {
      background-color: rgba(108, 117, 125, 0.1);
      color: var(--text-secondary);
    }

    .search-result-author {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .search-result-views {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .search-result-date {
      margin-left: auto;
    }

    .users-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .users-section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .users-list {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .user-card {
      background-color: var(--bg-white);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 200px;
    }

    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(255, 107, 157, 0.15);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--soft-pink);
      position: relative;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }

    .user-avatar-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .user-avatar-icon svg {
      width: 24px;
      height: 24px;
      color: var(--bg-white);
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-nickname {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-dark);
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .empty-state {
      padding: 2.5rem;
      text-align: center;
      color: var(--text-muted);
      background-color: var(--bg-white);
      border-radius: 18px;
      border: 1px dashed rgba(255, 107, 157, 0.3);
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary-pink);
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 1rem;
      transition: color 0.2s ease;
    }

    .back-button:hover {
      color: var(--primary-pink-hover);
    }

    @media (max-width: 1024px) {
      .search-main {
        padding: 2.5rem 2rem;
      }
    }

    @media (max-width: 768px) {
      :root {
        --gnb-width: 64px;
      }

      .search-main {
        margin-left: 0;
        padding: 2rem 1.5rem;
      }

      .search-bar {
        max-width: 100%;
      }
    }

    @media (max-width: 540px) {
      .search-main {
        padding: 1.8rem 1.2rem;
      }

      .search-result-item {
        flex-direction: column;
        padding: 1rem;
      }

      .search-result-image {
        width: 100%;
        height: 200px;
      }

      .search-result-meta {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .search-result-date {
        margin-left: 0;
        width: 100%;
      }

      .search-results-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="search-container">
    <div id="gnb-root"></div>

    <main class="search-main">
      <a href="/home.html" class="back-button">â† í™ˆìœ¼ë¡œ</a>

      <header class="search-header">
        <h1 class="page-title">ê²€ìƒ‰</h1>

        <section class="search-area">
          <div class="search-bar" role="search">
            <input class="search-input" id="searchInput" type="search" placeholder="ì›í•˜ëŠ” ìƒŒë“œìœ„ì¹˜ ë ˆì‹œí”¼ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”!" aria-label="ì „ì²´ ê²Œì‹œê¸€ ê²€ìƒ‰" value="">
            <button class="search-button" id="searchButton" type="button" aria-label="ê²€ìƒ‰ ì‹¤í–‰">
              â†µ
            </button>
          </div>
        </section>
      </header>

      <section class="users-section" id="usersSection" style="display: none;">
        <h2 class="users-section-title">ì‚¬ìš©ì</h2>
        <div class="users-list" id="usersList"></div>
      </section>

      <section class="search-results-section" id="searchResultsSection">
        <div class="search-results-header">
          <div>
            <h2 class="search-results-title" id="searchResultsTitle">ê²€ìƒ‰ ê²°ê³¼</h2>
            <div class="search-results-count" id="searchResultsCount"></div>
          </div>
        </div>
        <div class="search-results-list" id="searchResultsList">
          <div class="empty-state">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
      </section>

      <div id="site-footer"></div>
    </main>
  </div>

  <script src="/assets/js/gnb.js"></script>
  <script>
    function getStoredUser() {
      try {
        const raw = localStorage.getItem('sandwichUser');
        return raw ? JSON.parse(raw) : null;
      } catch (error) {
        console.warn('ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error);
        return null;
      }
    }

    function applyAuthState(user, gnbRefs) {
      if (gnbRefs && gnbRefs.myInfoBtn) {
        const isMobile = window.innerWidth <= 768;
        // ëª¨ë°”ì¼ì—ì„œëŠ” í•­ìƒ í”„ë¡œí•„ ë²„íŠ¼ í‘œì‹œ, PCì—ì„œëŠ” ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ
        if (isMobile) {
          gnbRefs.myInfoBtn.style.setProperty('display', 'flex', 'important');
        } else {
          gnbRefs.myInfoBtn.style.setProperty('display', user ? 'flex' : 'none', 'important');
        }
      }
    }


    function renderUsers(users) {
      const usersSection = document.getElementById('usersSection');
      const usersList = document.getElementById('usersList');

      if (!users || users.length === 0) {
        usersSection.style.display = 'none';
        return;
      }

      usersSection.style.display = 'flex';
      usersList.innerHTML = '';

      users.forEach(user => {
        const card = document.createElement('div');
        card.className = 'user-card';
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');

        const avatar = document.createElement('div');
        avatar.className = 'user-avatar';
        
        // GNBì™€ ë™ì¼í•œ ê¸°ë³¸ ì•„ì´ì½˜
        const defaultIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16" style="color: #ffffff;"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/></svg>`;
        
        if (user.profileImageUrl) {
          // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°
          const img = document.createElement('img');
          img.src = user.profileImageUrl;
          img.alt = user.nickname;
          img.className = 'user-avatar-image';
          
          const iconSpan = document.createElement('span');
          iconSpan.className = 'user-avatar-icon';
          iconSpan.style.display = 'none';
          iconSpan.innerHTML = defaultIcon;
          
          img.onerror = () => {
            // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì•„ì´ì½˜ í‘œì‹œ
            img.style.display = 'none';
            iconSpan.style.display = 'flex';
          };
          
          avatar.appendChild(img);
          avatar.appendChild(iconSpan);
        } else {
          // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì•„ì´ì½˜ í‘œì‹œ
          const iconSpan = document.createElement('span');
          iconSpan.className = 'user-avatar-icon';
          iconSpan.innerHTML = defaultIcon;
          avatar.appendChild(iconSpan);
        }

        const info = document.createElement('div');
        info.className = 'user-info';
        
        const nickname = document.createElement('p');
        nickname.className = 'user-nickname';
        nickname.textContent = user.nickname;
        
        info.appendChild(nickname);
        card.appendChild(avatar);
        card.appendChild(info);

        card.addEventListener('click', () => {
          window.location.href = user.href;
        });

        card.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            window.location.href = user.href;
          }
        });

        usersList.appendChild(card);
      });
    }

    function renderSearchResults(results, keyword) {
      const resultsList = document.getElementById('searchResultsList');
      const resultsCount = document.getElementById('searchResultsCount');
      const resultsTitle = document.getElementById('searchResultsTitle');

      if (!results || results.length === 0) {
        resultsList.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</div>';
        resultsCount.textContent = `"${keyword}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
        resultsTitle.textContent = 'ê²€ìƒ‰ ê²°ê³¼';
      } else {
        resultsList.innerHTML = '';
        resultsCount.textContent = `"${keyword}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ ${results.length}ê°œ`;
        resultsTitle.textContent = 'ê²€ìƒ‰ ê²°ê³¼';

        results.forEach(post => {
          const item = document.createElement('article');
          item.className = 'search-result-item';
          item.setAttribute('role', 'button');
          item.setAttribute('tabindex', '0');

          const imageHtml = post.imageUrl 
            ? `<img src="${post.imageUrl}" alt="${post.title}" class="search-result-image" loading="lazy" onerror="this.style.display='none'">`
            : '';

          const typeLabel = post.postType === 1 ? 'ë ˆì‹œí”¼' : 'ì •ë³´ ê³µìœ ';
          const typeClass = post.postType === 1 ? 'recipe' : 'tip';
          const dateStr = post.createdAt 
            ? new Date(post.createdAt).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
              }).replace(/\. /g, '.').replace(/\.$/, '')
            : '';

          item.innerHTML = `
            ${imageHtml}
            <div class="search-result-content">
              <h3 class="search-result-title">${post.title}</h3>
              <div class="search-result-meta">
                <span class="search-result-type ${typeClass}">${typeLabel}</span>
                <span class="search-result-author">ğŸ‘¤ ${post.authorName}</span>
                <span class="search-result-views">ğŸ‘ ${post.views}</span>
                ${dateStr ? `<span class="search-result-date">${dateStr}</span>` : ''}
              </div>
            </div>
          `;

          item.addEventListener('click', () => {
            window.location.href = post.href;
          });

          item.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              window.location.href = post.href;
            }
          });

          resultsList.appendChild(item);
        });
      }
    }

    async function performSearch(keyword) {
      const resultsList = document.getElementById('searchResultsList');

      // ê²€ìƒ‰ ì¤‘ í‘œì‹œ
      resultsList.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ì¤‘...</div>';

      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(keyword)}`);
        if (!response.ok) {
          throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status})`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.message || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        // ì‚¬ìš©ì ê²°ê³¼ ë Œë”ë§
        if (result.data.users && result.data.users.length > 0) {
          renderUsers(result.data.users);
        } else {
          document.getElementById('usersSection').style.display = 'none';
        }

        // ê²Œì‹œê¸€ ê²°ê³¼ ë Œë”ë§
        renderSearchResults(result.data.results, result.data.keyword);
        
        // URL ì—…ë°ì´íŠ¸ (íˆìŠ¤í† ë¦¬ ì¶”ê°€)
        const newUrl = `/search.html?q=${encodeURIComponent(keyword)}`;
        window.history.pushState({ keyword }, '', newUrl);
      } catch (error) {
        console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        resultsList.innerHTML = `<div class="empty-state text-danger">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
      }
    }

    function initSearch() {
      const input = document.getElementById('searchInput');
      const button = document.getElementById('searchButton');

      const triggerSearch = () => {
        const keyword = input.value.trim();
        if (!keyword) {
          input.focus();
          return;
        }
        
        // ìµœì†Œ 2ê¸€ì ê²€ì¦
        if (keyword.length < 2) {
          alert('ê²€ìƒ‰ì–´ëŠ” ìµœì†Œ 2ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
          input.focus();
          return;
        }

        performSearch(keyword);
      };

      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          triggerSearch();
        }
      });

      button.addEventListener('click', triggerSearch);
    }

    // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ ê²€ìƒ‰ì–´ ì½ê¸°
    function loadSearchFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const keyword = urlParams.get('q');
      
      if (keyword && keyword.trim().length >= 2) {
        const input = document.getElementById('searchInput');
        input.value = keyword.trim();
        performSearch(keyword.trim());
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const currentUser = getStoredUser();
      let gnbRefs = null;

      await Gnb.render({
        containerId: 'gnb-root',
        activeMenu: null,
        showMyInfo: true,
        onReady: (refs) => {
          gnbRefs = refs;
          applyAuthState(currentUser, gnbRefs);
          window.addEventListener('resize', () => {
            applyAuthState(getStoredUser(), gnbRefs);
          });
        }
      });

      initSearch();
      loadSearchFromUrl();

      fetch('/footer.html')
        .then(res => res.ok ? res.text() : Promise.reject(new Error('NOT_FOUND')))
        .then(html => {
          const footer = document.getElementById('site-footer');
          if (footer) {
            footer.innerHTML = html;
          }
        })
        .catch(err => console.warn('Footer ë¡œë“œ ì‹¤íŒ¨:', err));

      window.addEventListener('storage', (event) => {
        if (event.key === 'sandwichUser') {
          applyAuthState(getStoredUser(), gnbRefs);
        }
      });
    });
  </script>
</body>
</html>

