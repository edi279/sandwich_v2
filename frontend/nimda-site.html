<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self' https://cdn.jsdelivr.net;">
  <title>ê´€ë¦¬ì í˜ì´ì§€ - ìƒŒëƒ </title>
  <link rel="stylesheet" href="/assets/css/gnb.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="/assets/css/variables.css">
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/layout.css">
  <link rel="stylesheet" href="/assets/css/components.css">
  <style>
    .admin-container {
      display: flex;
      min-height: 100vh;
    }

    .admin-main {
      margin-left: var(--gnb-width);
      flex: 1;
      padding: 3rem 4rem;
    }

    .page-header {
      margin-bottom: 3rem;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-pink);
      letter-spacing: 2px;
      margin: 0 0 0.5rem 0;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
      margin: 0;
    }

    .menu-tabs {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 1rem;
    }

    .menu-tab {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 999px;
      background-color: transparent;
      color: var(--text-muted);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .menu-tab:hover {
      background-color: rgba(255, 107, 157, 0.08);
      color: var(--primary-pink);
    }

    .menu-tab.active {
      color: var(--primary-pink);
      background-color: rgba(255, 107, 157, 0.12);
    }

    .content-section {
      background-color: var(--bg-white);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      margin-bottom: 2rem;
      min-height: 400px;
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-dark);
      margin: 0 0 1.5rem 0;
    }

    .search-form {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .search-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-pink);
    }

    .btn-search {
      padding: 0.75rem 2rem;
      background-color: var(--primary-pink);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-search:hover {
      background-color: #ff4d8a;
    }

    .user-table, .post-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .user-table th, .user-table td,
    .post-table th, .post-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .user-table th, .post-table th {
      background-color: var(--soft-gray);
      font-weight: 600;
      color: var(--text-dark);
    }

    .user-table tr:hover, .post-table tr:hover {
      background-color: rgba(255, 107, 157, 0.05);
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .status-badge.blocked {
      background-color: #fee;
      color: #c33;
    }

    .status-badge.withdrawn {
      background-color: #eef;
      color: #33c;
    }

    .status-badge.normal {
      background-color: #efe;
      color: #3c3;
    }

    .btn-action {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-block {
      background-color: #fee;
      color: #c33;
    }

    .btn-block:hover {
      background-color: #fcc;
    }

    .btn-unblock {
      background-color: #efe;
      color: #3c3;
    }

    .btn-unblock:hover {
      background-color: #cfc;
    }

    .btn-delete {
      background-color: #fee;
      color: #c33;
    }

    .btn-delete:hover {
      background-color: #fcc;
    }

    .empty-state {
      padding: 3rem 2rem;
      text-align: center;
      color: var(--text-muted);
      background-color: var(--soft-gray);
      border-radius: 18px;
      border: 1px dashed rgba(255, 107, 157, 0.3);
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 2rem;
    }

    .pagination button {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
      background-color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pagination button:hover {
      background-color: var(--soft-gray);
    }

    .pagination button.active {
      background-color: var(--primary-pink);
      color: white;
      border-color: var(--primary-pink);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .alert {
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .post-type-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .post-type-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--border-color);
      background-color: white;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .post-type-btn.active {
      background-color: var(--primary-pink);
      color: white;
      border-color: var(--primary-pink);
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div id="gnb-root"></div>

    <main class="admin-main">
      <header class="page-header">
        <h1 class="page-title">ê´€ë¦¬ì í˜ì´ì§€</h1>
        <p class="page-subtitle">ì‚¬ìš©ì ë° ê²Œì‹œê¸€ ê´€ë¦¬</p>
      </header>

      <div class="menu-tabs">
        <button class="menu-tab active" data-tab="users">ì‚¬ìš©ì ê´€ë¦¬</button>
        <button class="menu-tab" data-tab="posts">ê²Œì‹œê¸€ ê´€ë¦¬</button>
      </div>

      <!-- ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
      <section id="users-section" class="content-section active">
        <h2 class="section-title">ì‚¬ìš©ì ê²€ìƒ‰ ë° ê´€ë¦¬</h2>
        
        <div id="user-alert" class="alert"></div>

        <form class="search-form" id="user-search-form">
          <input 
            type="text" 
            class="search-input" 
            id="user-search-input" 
            placeholder="ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë©”ì¼ë¡œ ê²€ìƒ‰..."
          >
          <button type="submit" class="btn-search">ê²€ìƒ‰</button>
          <button type="button" class="btn-search" id="user-reset-btn" style="background-color: #6c757d;">ì´ˆê¸°í™”</button>
        </form>

        <div id="user-results">
          <div class="empty-state">
            <p>ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>

        <div class="pagination" id="user-pagination"></div>
      </section>

      <!-- ê²Œì‹œê¸€ ê´€ë¦¬ ì„¹ì…˜ -->
      <section id="posts-section" class="content-section">
        <h2 class="section-title">ê²Œì‹œê¸€ ê´€ë¦¬</h2>
        
        <div id="post-alert" class="alert"></div>

        <form class="search-form" id="post-search-form">
          <input 
            type="text" 
            class="search-input" 
            id="post-search-input" 
            placeholder="ì œëª© ë˜ëŠ” ì‘ì„±ìëª…ìœ¼ë¡œ ê²€ìƒ‰..."
          >
          <button type="submit" class="btn-search">ê²€ìƒ‰</button>
          <button type="button" class="btn-search" id="post-reset-btn" style="background-color: #6c757d;">ì´ˆê¸°í™”</button>
        </form>

        <div id="post-results">
          <div class="empty-state">
            <p>ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>

        <div class="pagination" id="post-pagination"></div>
      </section>
    </main>
  </div>

  <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ê²Œì‹œê¸€ ì‚­ì œ í™•ì¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          <p class="text-muted">ì‚­ì œëœ ê²Œì‹œê¸€ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">ì‚­ì œ</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/assets/js/gnb.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    let currentUserPage = 1;
    let currentUserKeyword = '';
    let currentPostPage = 1;
    let currentPostKeyword = '';
    let deletePostType = null;
    let deletePostId = null;

    // ê´€ë¦¬ì ì´ë©”ì¼ í™•ì¸
    function getAdminEmail() {
      try {
        const raw = localStorage.getItem('sandwichUser');
        if (raw) {
          const user = JSON.parse(raw);
          return user.email || null;
        }
      } catch (error) {
        console.warn('ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error);
      }
      return null;
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(containerId, message, type = 'success') {
      const alert = document.getElementById(containerId);
      alert.textContent = message;
      alert.className = `alert alert-${type} show`;
      setTimeout(() => {
        alert.classList.remove('show');
      }, 3000);
    }

    // íƒ­ ì „í™˜
    document.querySelectorAll('.menu-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.menu-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        
        tab.classList.add('active');
        const sectionId = `${tab.dataset.tab}-section`;
        document.getElementById(sectionId).classList.add('active');
      });
    });

    // ì‚¬ìš©ì ê²€ìƒ‰
    document.getElementById('user-search-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      currentUserKeyword = document.getElementById('user-search-input').value.trim();
      currentUserPage = 1;
      loadUsers();
    });

    // ì‚¬ìš©ì ê²€ìƒ‰ ì´ˆê¸°í™”
    document.getElementById('user-reset-btn').addEventListener('click', () => {
      document.getElementById('user-search-input').value = '';
      currentUserKeyword = '';
      currentUserPage = 1;
      loadUsers();
    });

    // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
    async function loadUsers(page = 1) {
      const adminEmail = getAdminEmail();
      if (!adminEmail) {
        showAlert('user-alert', 'ê´€ë¦¬ì ì´ë©”ì¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      currentUserPage = page;

      try {
        const response = await fetch('/api/admin/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email: adminEmail, 
            page: currentUserPage, 
            limit: 20,
            keyword: currentUserKeyword
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:', response.status, errorText);
          showAlert('user-alert', `ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${response.status})`, 'error');
          return;
        }

        const result = await response.json();

        if (!result.success) {
          showAlert('user-alert', result.message || 'ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        renderUserResults(result.data);
        renderUserPagination(result.data);
      } catch (error) {
        console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        showAlert('user-alert', 'ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ì‚¬ìš©ì ê²°ê³¼ ë Œë”ë§
    function renderUserResults(data) {
      const container = document.getElementById('user-results');

      if (!data.users || data.users.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
        return;
      }

      let html = '<table class="user-table"><thead><tr><th>ID</th><th>ì´ë©”ì¼</th><th>ë‹‰ë„¤ì„</th><th>ê´‘ê³  ìˆ˜ì‹ </th><th>ìƒíƒœ</th><th>ê°€ì…ì¼</th><th>ì‘ì—…</th></tr></thead><tbody>';

      data.users.forEach(user => {
        const statusBadges = [];
        if (user.blocked) {
          statusBadges.push('<span class="status-badge blocked">ì°¨ë‹¨</span>');
        }
        if (user.withdrawn) {
          statusBadges.push('<span class="status-badge withdrawn">íƒˆí‡´</span>');
        }
        if (statusBadges.length === 0) {
          statusBadges.push('<span class="status-badge normal">ì •ìƒ</span>');
        }

        html += `
          <tr>
            <td>${user.userId}</td>
            <td>${user.email}</td>
            <td>${user.nickname}</td>
            <td>${user.eventOptIn ? 'Y' : 'N'}</td>
            <td>${statusBadges.join(' ')}</td>
            <td>${new Date(user.createdAt).toLocaleDateString('ko-KR')}</td>
            <td>
              ${user.blocked 
                ? `<button class="btn-action btn-unblock" onclick="toggleUserBlock(${user.userId}, false)">ì°¨ë‹¨ í•´ì œ</button>`
                : `<button class="btn-action btn-block" onclick="toggleUserBlock(${user.userId}, true)">ì°¨ë‹¨</button>`
              }
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ì‚¬ìš©ì í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    function renderUserPagination(data) {
      const container = document.getElementById('user-pagination');
      
      if (data.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';

      // ì´ì „ í˜ì´ì§€
      html += `<button ${currentUserPage === 1 ? 'disabled' : ''} onclick="loadUsers(${currentUserPage - 1})">ì´ì „</button>`;

      // í˜ì´ì§€ ë²ˆí˜¸
      for (let i = 1; i <= data.totalPages; i++) {
        if (i === 1 || i === data.totalPages || (i >= currentUserPage - 2 && i <= currentUserPage + 2)) {
          html += `<button class="${i === currentUserPage ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
        } else if (i === currentUserPage - 3 || i === currentUserPage + 3) {
          html += '<span>...</span>';
        }
      }

      // ë‹¤ìŒ í˜ì´ì§€
      html += `<button ${currentUserPage === data.totalPages ? 'disabled' : ''} onclick="loadUsers(${currentUserPage + 1})">ë‹¤ìŒ</button>`;

      container.innerHTML = html;
    }

    // ì‚¬ìš©ì ì°¨ë‹¨/í•´ì œ
    async function toggleUserBlock(userId, blocked) {
      const adminEmail = getAdminEmail();
      if (!adminEmail) {
        showAlert('user-alert', 'ê´€ë¦¬ì ì´ë©”ì¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      if (!confirm(blocked ? 'ì´ ì‚¬ìš©ìë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì´ ì‚¬ìš©ìì˜ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/users/${userId}/block`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: adminEmail, blocked })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          showAlert('user-alert', result.message || 'ì°¨ë‹¨ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        showAlert('user-alert', result.message, 'success');
        
        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadUsers(currentUserPage);
      } catch (error) {
        console.error('ì‚¬ìš©ì ì°¨ë‹¨ ì˜¤ë¥˜:', error);
        showAlert('user-alert', 'ì°¨ë‹¨ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ê²Œì‹œê¸€ ê²€ìƒ‰
    document.getElementById('post-search-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      currentPostKeyword = document.getElementById('post-search-input').value.trim();
      currentPostPage = 1;
      loadPosts();
    });

    // ê²€ìƒ‰ ì´ˆê¸°í™”
    document.getElementById('post-reset-btn').addEventListener('click', () => {
      document.getElementById('post-search-input').value = '';
      currentPostKeyword = '';
      currentPostPage = 1;
      loadPosts();
    });

    // ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ
    async function loadPosts(page = 1) {
      const adminEmail = getAdminEmail();
      if (!adminEmail) {
        showAlert('post-alert', 'ê´€ë¦¬ì ì´ë©”ì¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      currentPostPage = page;

      try {
        const response = await fetch('/api/admin/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email: adminEmail, 
            page: currentPostPage, 
            limit: 20,
            keyword: currentPostKeyword
          })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          showAlert('post-alert', result.message || 'ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        renderPostResults(result.data);
        renderPagination(result.data);
      } catch (error) {
        console.error('ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        showAlert('post-alert', 'ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ê²Œì‹œê¸€ ê²°ê³¼ ë Œë”ë§
    function renderPostResults(data) {
      const container = document.getElementById('post-results');

      if (!data.posts || data.posts.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
        return;
      }

      let html = '<table class="post-table"><thead><tr><th>íƒ€ì…</th><th>ID</th><th>ì œëª©</th><th>ì‘ì„±ì</th><th>ì¹´í…Œê³ ë¦¬</th><th>ì¡°íšŒìˆ˜</th><th>ì‘ì„±ì¼</th><th>ì‘ì—…</th></tr></thead><tbody>';

      data.posts.forEach(post => {
        html += `
          <tr>
            <td><span class="status-badge ${post.postType === 1 ? 'normal' : 'withdrawn'}" style="background-color: ${post.postType === 1 ? '#e3f2fd' : '#fff3e0'}; color: ${post.postType === 1 ? '#1976d2' : '#f57c00'};">${post.postTypeName || (post.postType === 1 ? 'ë ˆì‹œí”¼' : 'ì •ë³´ê³µìœ ')}</span></td>
            <td>${post.postId}</td>
            <td>${post.title}</td>
            <td>${post.authorName || 'ìµëª…'}</td>
            <td>${post.categoryName || '-'}</td>
            <td>${post.views || 0}</td>
            <td>${new Date(post.createdAt).toLocaleDateString('ko-KR')}</td>
            <td>
              <button class="btn-action btn-delete" onclick="confirmDeletePost(${post.postType}, ${post.postId})">ì‚­ì œ</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    function renderPagination(data) {
      const container = document.getElementById('post-pagination');
      
      if (data.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';

      // ì´ì „ í˜ì´ì§€
      html += `<button ${currentPostPage === 1 ? 'disabled' : ''} onclick="loadPosts(${currentPostPage - 1})">ì´ì „</button>`;

      // í˜ì´ì§€ ë²ˆí˜¸
      for (let i = 1; i <= data.totalPages; i++) {
        if (i === 1 || i === data.totalPages || (i >= currentPostPage - 2 && i <= currentPostPage + 2)) {
          html += `<button class="${i === currentPostPage ? 'active' : ''}" onclick="loadPosts(${i})">${i}</button>`;
        } else if (i === currentPostPage - 3 || i === currentPostPage + 3) {
          html += '<span>...</span>';
        }
      }

      // ë‹¤ìŒ í˜ì´ì§€
      html += `<button ${currentPostPage === data.totalPages ? 'disabled' : ''} onclick="loadPosts(${currentPostPage + 1})">ë‹¤ìŒ</button>`;

      container.innerHTML = html;
    }

    // ê²Œì‹œê¸€ ì‚­ì œ í™•ì¸
    function confirmDeletePost(postType, postId) {
      deletePostType = postType;
      deletePostId = postId;
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      modal.show();
    }

    // ê²Œì‹œê¸€ ì‚­ì œ ì‹¤í–‰
    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
      const adminEmail = getAdminEmail();
      if (!adminEmail) {
        showAlert('post-alert', 'ê´€ë¦¬ì ì´ë©”ì¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      if (!deletePostType || !deletePostId) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/posts/${deletePostType}/${deletePostId}/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: adminEmail })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          showAlert('post-alert', result.message || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        showAlert('post-alert', result.message, 'success');
        
        // ëª¨ë‹¬ ë‹«ê¸°
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();
        
        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadPosts(currentPostPage);
      } catch (error) {
        console.error('ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:', error);
        showAlert('post-alert', 'ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    });

    // ê´€ë¦¬ì ì ‘ê·¼ í™•ì¸
    async function checkAdminAccess() {
      const adminEmail = getAdminEmail();
      if (!adminEmail) {
        show404Page();
        setTimeout(() => {
          alert('í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í™ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          window.location.href = '/home.html';
        }, 100);
        return false;
      }

      try {
        const response = await fetch('/api/admin/check-access', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: adminEmail })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          show404Page();
          setTimeout(() => {
            alert('í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í™ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = '/home.html';
          }, 100);
          return false;
        }

        return true;
      } catch (error) {
        console.error('ê´€ë¦¬ì ì ‘ê·¼ í™•ì¸ ì˜¤ë¥˜:', error);
        show404Page();
        setTimeout(() => {
          alert('í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í™ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          window.location.href = '/home.html';
        }, 100);
        return false;
      }
    }

    // 404 í˜ì´ì§€ í‘œì‹œ
    function show404Page() {
      document.title = 'í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ - ìƒŒëƒ ';
      const body = document.body;
      body.innerHTML = `
        <div style="display: flex; min-height: 100vh; align-items: center; justify-content: center; background-color: var(--soft-gray, #f5f5f5);">
          <div style="text-align: center; max-width: 600px; padding: 2rem;">
            <h1 style="font-size: 2rem; font-weight: bold; color: var(--text-dark, #333); margin-bottom: 1rem;">
              ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤
            </h1>
            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
              <p style="color: #856404; margin: 0; font-size: 1rem;">
                ìš”ì²­í•˜ì‹  í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              </p>
            </div>
            <div style="margin-top: 2rem; color: var(--text-muted, #666); font-size: 0.9rem;">
              ğŸ¥ª ìƒŒëƒ  sannyam | Email: sdwc.nn@gmail.com | ì´ìš©ì•½ê´€
            </div>
          </div>
        </div>
      `;
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async () => {
      // ê´€ë¦¬ì ì ‘ê·¼ í™•ì¸
      const hasAccess = await checkAdminAccess();
      if (!hasAccess) {
        return;
      }

      // ê´€ë¦¬ì ê¶Œí•œì´ í™•ì¸ë˜ë©´ í˜ì´ì§€ ë¡œë“œ
      loadUsers();
      loadPosts();
    });
  </script>
</body>
</html>

